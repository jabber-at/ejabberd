Description: adjust ejabberd.yml.example to sane defaults
 ejabberd's default configuration needs to be altered to be
 useful on Debian systems
Author: Philipp Huebner <debalance@debian.org>

Index: ejabberd/ejabberd.yml.example
===================================================================
--- ejabberd.orig/ejabberd.yml.example
+++ ejabberd/ejabberd.yml.example
@@ -23,7 +23,7 @@
 ###   Example of folded string:
 ###   > Art thou not Romeo,
 ###     and a Montague?
-
+---
 ###.  =======
 ###'  LOGGING
 
@@ -39,23 +39,10 @@
 loglevel: 4
 
 ##
-## rotation: Describe how to rotate logs. Either size and/or date can trigger
-## log rotation. Setting count to N keeps N rotated logs. Setting count to 0
-## does not disable rotation, it instead rotates the file and keeps no previous
-## versions around. Setting size to X rotate log when it reaches X bytes.
-## To disable rotation set the size to 0 and the date to ""
-## Date syntax is taken from the syntax newsyslog uses in newsyslog.conf.
-## Some examples:
-##  $D0     rotate every night at midnight
-##  $D23    rotate every day at 23:00 hr
-##  $W0D23  rotate every week on Sunday at 23:00 hr
-##  $W5D16  rotate every week on Friday at 16:00 hr
-##  $M1D0   rotate on the first day of every month at midnight
-##  $M5D6   rotate on every 5th day of the month at 6:00 hr
-##
-log_rotate_size: 10485760
+## rotation: Disable ejabberd's internal log rotation, as the Debian package
+## uses logrotate(8).
+log_rotate_size: 0
 log_rotate_date: ""
-log_rotate_count: 1
 
 ##
 ## overload protection: If you want to limit the number of messages per second
@@ -102,10 +89,9 @@ hosts:
 ## chains of certificates or certificate keys. Full chains will be built
 ## automatically by ejabberd.
 ##
-## certfiles:
-##   - "/etc/letsencrypt/live/example.org/*.pem"
-##   - "/etc/letsencrypt/live/example.com/*.pem"
-##
+certfiles:
+  - "/etc/ejabberd/ejabberd.pem"
+
 ## If your system provides only a single CA file (CentOS/FreeBSD):
 ## ca_file: "/etc/ssl/certs/ca-bundle.pem"
 
@@ -116,20 +102,21 @@ hosts:
 ## configuration of the TLS driver, so you don't need to
 ## uncomment it.
 ##
-## define_macro:
-##   'TLS_CIPHERS': "HIGH:!aNULL:!eNULL:!3DES:@STRENGTH"
-##   'TLS_OPTIONS':
-##     - "no_sslv3"
-##     - "cipher_server_preference"
-##     - "no_compression"
-##   'DH_FILE': "/path/to/dhparams.pem" # generated with: openssl dhparam -out dhparams.pem 2048
-##
+define_macro:
+  'TLS_CIPHERS': "HIGH:!aNULL:!eNULL:!3DES:@STRENGTH"
+  'TLS_OPTIONS':
+    - "no_sslv3"
+    - "no_tlsv1"
+    - "cipher_server_preference"
+    - "no_compression"
+  ## 'DH_FILE': "/path/to/dhparams.pem" # generated with: openssl dhparam -out dhparams.pem 2048
+
 ## c2s_dhfile: 'DH_FILE'
 ## s2s_dhfile: 'DH_FILE'
-## c2s_ciphers: 'TLS_CIPHERS'
-## s2s_ciphers: 'TLS_CIPHERS'
-## c2s_protocol_options: 'TLS_OPTIONS'
-## s2s_protocol_options: 'TLS_OPTIONS'
+c2s_ciphers: 'TLS_CIPHERS'
+s2s_ciphers: 'TLS_CIPHERS'
+c2s_protocol_options: 'TLS_OPTIONS'
+s2s_protocol_options: 'TLS_OPTIONS'
 
 ###.  ===============
 ###'  LISTENING PORTS
@@ -143,21 +130,8 @@ listen:
     port: 5222
     ip: "::"
     module: ejabberd_c2s
-    ##
-    ## If TLS is compiled in and you installed a SSL
-    ## certificate, uncomment this line:
-    ##
-    ## starttls: true
-    ##
-    ## To enforce TLS encryption for client connections,
-    ## use this instead of the "starttls" option:
-    ##
-    ## starttls_required: true
-    ##
-    ## Stream compression
-    ##
-    ## zlib: true
-    ##
+    starttls_required: true
+    protocol_options: 'TLS_OPTIONS'
     max_stanza_size: 65536
     shaper: c2s_shaper
     access: c2s
@@ -190,7 +164,9 @@ listen:
     ##  "/pub/archive": mod_http_fileserver
     web_admin: true
     ## register: true
-    captcha: true
+    ## captcha: true
+    tls: true
+    protocol_options: 'TLS_OPTIONS'
 
   ##
   ## ejabberd_service: Interact with external components (transports, ...)
@@ -255,7 +231,7 @@ listen:
 
 ## Disabling digest-md5 SASL authentication. digest-md5 requires plain-text
 ## password storage (see auth_password_format option).
-## disable_sasl_mechanisms: "digest-md5"
+disable_sasl_mechanisms: "digest-md5"
 
 ###.  ==================
 ###'  S2S GLOBAL OPTIONS
@@ -265,7 +241,7 @@ listen:
 ## Allowed values are: false, optional or required
 ## You must specify 'certfiles' option
 ##
-## s2s_use_starttls: optional
+s2s_use_starttls: required
 
 ##
 ## S2S whitelist or blacklist
@@ -299,7 +275,7 @@ auth_method: internal
 ##
 ## Store the plain passwords or hashed for SCRAM:
 ## auth_password_format: plain
-## auth_password_format: scram
+auth_password_format: scram
 ##
 ## Define the FQDN if ejabberd doesn't detect it:
 ## fqdn: "server3.example.com"
@@ -580,14 +556,14 @@ access_rules:
   ## Only allow to register from localhost
   trusted_network:
     - allow: loopback
-  ## Do not establish S2S connections with bad servers
-  ## If you enable this you also have to uncomment "s2s_access: s2s"
-  ## s2s:
-  ##   - deny:
-  ##     - ip: "XXX.XXX.XXX.XXX/32"
-  ##   - deny:
-  ##     - ip: "XXX.XXX.XXX.XXX/32"
-  ##   - allow
+    ## Do not establish S2S connections with bad servers
+    ## If you enable this you also have to uncomment "s2s_access: s2s"
+    ## s2s:
+    ##   - deny:
+    ##     - ip: "XXX.XXX.XXX.XXX/32"
+    ##   - deny:
+    ##     - ip: "XXX.XXX.XXX.XXX/32"
+    ##   - allow
 
 ## ===============
 ## API PERMISSIONS
@@ -616,9 +592,9 @@ api_permissions:
   "admin access":
     who:
       - access:
-          - allow:
-            - acl: loopback
-            - acl: admin
+        - allow:
+          - acl: loopback
+          - acl: admin
       - oauth:
         - scope: "ejabberd:admin"
         - access:
@@ -639,7 +615,7 @@ api_permissions:
 ## By default the frequency of account registrations from the same IP
 ## is limited to 1 account every 10 minutes. To disable, specify: infinity
 ## registration_timeout: 600
-  
+
 ##
 ## Define specific Access Rules in a virtual host.
 ##
@@ -673,7 +649,7 @@ language: "en"
 ##
 ## Full path to a script that generates the image.
 ##
-## captcha_cmd: "/lib/ejabberd/priv/bin/captcha.sh"
+## captcha_cmd: "/usr/share/ejabberd/captcha.sh"
 
 ##
 ## Host for the URL and port where ejabberd listens for CAPTCHA requests.
@@ -691,29 +667,29 @@ language: "en"
 ## In order to use the acme certificate acquiring through "Let's Encrypt"
 ## an http listener has to be configured to listen to port 80 so that
 ## the authorization challenges posed by "Let's Encrypt" can be solved.
-## 
+##
 ## A simple way of doing this would be to add the following in the listening
-## section and to configure port forwarding from 80 to 5280 either via NAT
+## section and to configure port forwarding from 80 to 5281 either via NAT
 ## (for ipv4 only) or using frontends such as haproxy/nginx/sslh/etc.
-##   - 
-##    port: 5280
+##   -
+##    port: 5281
 ##    ip: "::"
 ##    module: ejabberd_http
 
 acme:
 
-   ## A contact mail that the ACME Certificate Authority can contact in case of
-   ## an authorization issue, such as a server-initiated certificate revocation.
-   ## It is not mandatory to provide an email address but it is highly suggested.
-   contact: "mailto:example-admin@example.com"
+  ## A contact mail that the ACME Certificate Authority can contact in case of
+  ## an authorization issue, such as a server-initiated certificate revocation.
+  ## It is not mandatory to provide an email address but it is highly suggested.
+  contact: "mailto:example-admin@example.com"
 
 
-   ## The ACME Certificate Authority URL.
-   ## This could either be:
-   ##   - https://acme-v01.api.letsencrypt.org - (Default) for the production CA
-   ##   - https://acme-staging.api.letsencrypt.org - for the staging CA
-   ##   - http://localhost:4000 - for a local version of the CA
-   ca_url: "https://acme-v01.api.letsencrypt.org"
+  ## The ACME Certificate Authority URL.
+  ## This could either be:
+  ##   - https://acme-v01.api.letsencrypt.org - (Default) for the production CA
+  ##   - https://acme-staging.api.letsencrypt.org - for the staging CA
+  ##   - http://localhost:4000 - for a local version of the CA
+  ca_url: "https://acme-v01.api.letsencrypt.org"
 
 ###.  =======
 ###'  MODULES
@@ -724,14 +700,15 @@ acme:
 modules:
   mod_adhoc: {}
   mod_admin_extra: {}
-  mod_announce: # recommends mod_adhoc
+  mod_announce:   # recommends mod_adhoc
     access: announce
-  mod_blocking: {} # requires mod_privacy
+  mod_block_strangers: {}
+  mod_blocking: {}   # requires mod_privacy
   mod_caps: {}
   mod_carboncopy: {}
   mod_client_state: {}
-  mod_configure: {} # requires mod_adhoc
-  ## mod_delegation: {} # for xep0356
+  mod_configure: {}   # requires mod_adhoc
+  ## mod_delegation: {}   # for xep0356
   mod_disco: {}
   mod_echo: {}
   mod_bosh: {}
@@ -763,9 +740,9 @@ modules:
   mod_offline:
     access_max_user_messages: max_user_offline_messages
   mod_ping: {}
-  ## mod_pres_counter:
-  ##   count: 5
-  ##   interval: 60
+  mod_pres_counter:
+    count: 5
+    interval: 60
   mod_privacy: {}
   mod_private: {}
   ## mod_proxy65: {}
@@ -779,53 +756,51 @@ modules:
     plugins:
       - "flat"
       - "hometree"
-      - "pep" # pep requires mod_caps
+      - "pep"   # pep requires mod_caps
     force_node_config:
-      ## Avoid using OMEMO by default because it
-      ## introduces a lot of hard-to-track problems.
-      ## Comment out the following lines to enable OMEMO support
       "eu.siacs.conversations.axolotl.*":
-        access_model: whitelist
+        access_model: open
       ## Avoid buggy clients to make their bookmarks public
       "storage:bookmarks":
         access_model: whitelist
   mod_push: {}
   mod_push_keepalive: {}
   ## mod_register:
-    ##
-    ## Protect In-Band account registrations with CAPTCHA.
-    ##
-    ##   captcha_protected: true
-    ##
-    ## Set the minimum informational entropy for passwords.
-    ##
-    ##   password_strength: 32
-    ##
-    ## After successful registration, the user receives
-    ## a message with this subject and body.
-    ##
-    ##   welcome_message:
-    ##     subject: "Welcome!"
-    ##     body: |-
-    ##       Hi.
-    ##       Welcome to this XMPP server.
-    ##
-    ## When a user registers, send a notification to
-    ## these XMPP accounts.
-    ##
-    ##   registration_watchers:
-    ##     - "admin1@example.org"
-    ##
-    ## Only clients in the server machine can register accounts
-    ##
-    ##   ip_access: trusted_network
-    ##
-    ## Local c2s or remote s2s users cannot register accounts
-    ##
-    ##   access_from: deny
-    ##   access: register
+  ##
+  ## Protect In-Band account registrations with CAPTCHA.
+  ##
+  ##   captcha_protected: true
+  ##
+  ## Set the minimum informational entropy for passwords.
+  ##
+  ##   password_strength: 32
+  ##
+  ## After successful registration, the user receives
+  ## a message with this subject and body.
+  ##
+  ##   welcome_message:
+  ##     subject: "Welcome!"
+  ##     body: |-
+  ##       Hi.
+  ##       Welcome to this XMPP server.
+  ##
+  ## When a user registers, send a notification to
+  ## these XMPP accounts.
+  ##
+  ##   registration_watchers:
+  ##     - "admin1@example.org"
+  ##
+  ## Only clients in the server machine can register accounts
+  ##
+  ##   ip_access: trusted_network
+  ##
+  ## Local c2s or remote s2s users cannot register accounts
+  ##
+  ##   access_from: deny
+  ##   access: register
   mod_roster: {}
   mod_shared_roster: {}
+  mod_sic: {}
   mod_stats: {}
   mod_time: {}
   mod_vcard:
@@ -833,7 +808,8 @@ modules:
   mod_vcard_xupdate: {}
   mod_avatar: {}
   mod_version: {}
-  mod_stream_mgmt: {}
+  mod_stream_mgmt:
+    resend_on_timeout: if_offline
   ##   Non-SASL Authentication (XEP-0078) is now disabled by default
   ##   because it's obsoleted and is used mostly by abandoned
   ##   client software
