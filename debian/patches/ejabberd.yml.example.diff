Description: adjust ejabberd.yml.example to sane defaults
 ejabberd's default configuration needs to be altered to be
 useful on Debian systems
Author: Philipp Huebner <debalance@debian.org>

Index: ejabberd/ejabberd.yml.example
===================================================================
--- ejabberd.orig/ejabberd.yml.example
+++ ejabberd/ejabberd.yml.example
@@ -23,7 +23,7 @@
 ###   Example of folded string:
 ###   > Art thou not Romeo,
 ###     and a Montague?
-
+---
 ###.  =======
 ###'  LOGGING
 
@@ -39,23 +39,10 @@
 loglevel: 4
 
 ##
-## rotation: Describe how to rotate logs. Either size and/or date can trigger
-## log rotation. Setting count to N keeps N rotated logs. Setting count to 0
-## does not disable rotation, it instead rotates the file and keeps no previous
-## versions around. Setting size to X rotate log when it reaches X bytes.
-## To disable rotation set the size to 0 and the date to ""
-## Date syntax is taken from the syntax newsyslog uses in newsyslog.conf.
-## Some examples:
-##  $D0     rotate every night at midnight
-##  $D23    rotate every day at 23:00 hr
-##  $W0D23  rotate every week on Sunday at 23:00 hr
-##  $W5D16  rotate every week on Friday at 16:00 hr
-##  $M1D0   rotate on the first day of every month at midnight
-##  $M5D6   rotate on every 5th day of the month at 6:00 hr
-##
-log_rotate_size: 10485760
+## rotation: Disable ejabberd's internal log rotation, as the Debian package
+## uses logrotate(8).
+log_rotate_size: 0
 log_rotate_date: ""
-log_rotate_count: 1
 
 ##
 ## overload protection: If you want to limit the number of messages per second
@@ -110,9 +97,10 @@
 ## chains of certificates or certificate keys. Full chains will be built
 ## automatically by ejabberd.
 ##
-## certfiles:
-##   - "/etc/letsencrypt/live/example.org/*.pem"
-##   - "/etc/letsencrypt/live/example.com/*.pem"
+certfiles:
+  - "/etc/ejabberd/ejabberd.pem"
+  ## - "/etc/letsencrypt/live/example.org/*.pem"
+  ## - "/etc/letsencrypt/live/example.com/*.pem"
 ##
 ## If your system provides only a single CA file (CentOS/FreeBSD):
 ## ca_file: "/etc/ssl/certs/ca-bundle.pem"
@@ -124,20 +112,20 @@
 ## configuration of the TLS driver, so you don't need to
 ## uncomment it.
 ##
-## define_macro:
-##   'TLS_CIPHERS': "HIGH:!aNULL:!eNULL:!3DES:@STRENGTH"
-##   'TLS_OPTIONS':
-##     - "no_sslv3"
-##     - "cipher_server_preference"
-##     - "no_compression"
+define_macro:
+   'TLS_CIPHERS': "HIGH:!aNULL:!eNULL:!3DES:@STRENGTH"
+   'TLS_OPTIONS':
+     - "no_sslv3"
+     - "cipher_server_preference"
+     - "no_compression"
 ##   'DH_FILE': "/path/to/dhparams.pem" # generated with: openssl dhparam -out dhparams.pem 2048
 ##
 ## c2s_dhfile: 'DH_FILE'
 ## s2s_dhfile: 'DH_FILE'
-## c2s_ciphers: 'TLS_CIPHERS'
-## s2s_ciphers: 'TLS_CIPHERS'
-## c2s_protocol_options: 'TLS_OPTIONS'
-## s2s_protocol_options: 'TLS_OPTIONS'
+c2s_ciphers: 'TLS_CIPHERS'
+s2s_ciphers: 'TLS_CIPHERS'
+c2s_protocol_options: 'TLS_OPTIONS'
+s2s_protocol_options: 'TLS_OPTIONS'
 
 ###.  ===============
 ###'  LISTENING PORTS
@@ -151,21 +139,7 @@
     port: 5222
     ip: "::"
     module: ejabberd_c2s
-    ##
-    ## If TLS is compiled in and you installed a SSL
-    ## certificate, uncomment this line:
-    ##
-    ## starttls: true
-    ##
-    ## To enforce TLS encryption for client connections,
-    ## use this instead of the "starttls" option:
-    ##
-    ## starttls_required: true
-    ##
-    ## Stream compression
-    ##
-    ## zlib: true
-    ##
+    starttls_required: true
     max_stanza_size: 65536
     shaper: c2s_shaper
     access: c2s
@@ -184,7 +158,10 @@
     ##  "/pub/archive": mod_http_fileserver
     web_admin: true
     ## register: true
-    captcha: true
+    ## captcha: true
+    tls: true
+    protocol_options: 'TLS_OPTIONS'
+
   ##
   ## Direct-TLS for C2S (XEP-0368). A good practice is to forward
   ## traffic from port 443 to this port, possibly multiplexing it
@@ -263,7 +240,7 @@
 
 ## Disabling digest-md5 SASL authentication. digest-md5 requires plain-text
 ## password storage (see auth_password_format option).
-## disable_sasl_mechanisms: "digest-md5"
+disable_sasl_mechanisms: "digest-md5"
 
 ###.  ==================
 ###'  S2S GLOBAL OPTIONS
@@ -273,7 +250,7 @@
 ## Allowed values are: false, optional or required
 ## You must specify 'certfiles' option
 ##
-## s2s_use_starttls: optional
+s2s_use_starttls: required
 
 ##
 ## S2S whitelist or blacklist
@@ -307,7 +284,7 @@
 ##
 ## Store the plain passwords or hashed for SCRAM:
 ## auth_password_format: plain
-## auth_password_format: scram
+auth_password_format: scram
 ##
 ## Define the FQDN if ejabberd doesn't detect it:
 ## fqdn: "server3.example.com"
@@ -580,14 +557,14 @@
   ## Only allow to register from localhost
   trusted_network:
     - allow: loopback
-  ## Do not establish S2S connections with bad servers
-  ## If you enable this you also have to uncomment "s2s_access: s2s"
-  ## s2s:
-  ##   - deny:
-  ##     - ip: "XXX.XXX.XXX.XXX/32"
-  ##   - deny:
-  ##     - ip: "XXX.XXX.XXX.XXX/32"
-  ##   - allow
+    ## Do not establish S2S connections with bad servers
+    ## If you enable this you also have to uncomment "s2s_access: s2s"
+    ## s2s:
+    ##   - deny:
+    ##     - ip: "XXX.XXX.XXX.XXX/32"
+    ##   - deny:
+    ##     - ip: "XXX.XXX.XXX.XXX/32"
+    ##   - allow
 
 ## ===============
 ## API PERMISSIONS
@@ -616,9 +593,9 @@
   "admin access":
     who:
       - access:
-          - allow:
-            - acl: loopback
-            - acl: admin
+        - allow:
+          - acl: loopback
+          - acl: admin
       - oauth:
         - scope: "ejabberd:admin"
         - access:
@@ -639,7 +616,7 @@
 ## By default the frequency of account registrations from the same IP
 ## is limited to 1 account every 10 minutes. To disable, specify: infinity
 ## registration_timeout: 600
-  
+
 ##
 ## Define specific Access Rules in a virtual host.
 ##
@@ -673,7 +650,7 @@
 ##
 ## Full path to a script that generates the image.
 ##
-## captcha_cmd: "/lib/ejabberd/priv/bin/captcha.sh"
+## captcha_cmd: "/usr/share/ejabberd/captcha.sh"
 
 ##
 ## Host for the URL and port where ejabberd listens for CAPTCHA requests.
@@ -691,29 +668,29 @@
 ## In order to use the acme certificate acquiring through "Let's Encrypt"
 ## an http listener has to be configured to listen to port 80 so that
 ## the authorization challenges posed by "Let's Encrypt" can be solved.
-## 
+##
 ## A simple way of doing this would be to add the following in the listening
-## section and to configure port forwarding from 80 to 5280 either via NAT
+## section and to configure port forwarding from 80 to 5281 either via NAT
 ## (for ipv4 only) or using frontends such as haproxy/nginx/sslh/etc.
-##   - 
-##    port: 5280
+##   -
+##    port: 5281
 ##    ip: "::"
 ##    module: ejabberd_http
 
 acme:
 
-   ## A contact mail that the ACME Certificate Authority can contact in case of
-   ## an authorization issue, such as a server-initiated certificate revocation.
-   ## It is not mandatory to provide an email address but it is highly suggested.
-   contact: "mailto:example-admin@example.com"
+  ## A contact mail that the ACME Certificate Authority can contact in case of
+  ## an authorization issue, such as a server-initiated certificate revocation.
+  ## It is not mandatory to provide an email address but it is highly suggested.
+  contact: "mailto:example-admin@example.com"
 
 
-   ## The ACME Certificate Authority URL.
-   ## This could either be:
-   ##   - https://acme-v01.api.letsencrypt.org - (Default) for the production CA
-   ##   - https://acme-staging.api.letsencrypt.org - for the staging CA
-   ##   - http://localhost:4000 - for a local version of the CA
-   ca_url: "https://acme-v01.api.letsencrypt.org"
+  ## The ACME Certificate Authority URL.
+  ## This could either be:
+  ##   - https://acme-v01.api.letsencrypt.org - (Default) for the production CA
+  ##   - https://acme-staging.api.letsencrypt.org - for the staging CA
+  ##   - http://localhost:4000 - for a local version of the CA
+  ca_url: "https://acme-v01.api.letsencrypt.org"
 
 ###.  =======
 ###'  MODULES
@@ -724,14 +701,14 @@
 modules:
   mod_adhoc: {}
   mod_admin_extra: {}
-  mod_announce: # recommends mod_adhoc
+  mod_announce:   # recommends mod_adhoc
     access: announce
-  mod_blocking: {} # requires mod_privacy
+  mod_blocking: {}   # requires mod_privacy
   mod_caps: {}
   mod_carboncopy: {}
   mod_client_state: {}
-  mod_configure: {} # requires mod_adhoc
-  ## mod_delegation: {} # for xep0356
+  mod_configure: {}   # requires mod_adhoc
+  ## mod_delegation: {}   # for xep0356
   mod_disco: {}
   mod_echo: {}
   mod_irc: {}
@@ -824,7 +801,8 @@
     ##
     ##   access_from: deny
     ##   access: register
-  mod_roster: {}
+  mod_roster:
+        versioning: true
   mod_shared_roster: {}
   mod_stats: {}
   mod_time: {}
@@ -833,7 +811,8 @@
   mod_vcard_xupdate: {}
   mod_avatar: {}
   mod_version: {}
-  mod_stream_mgmt: {}
+  mod_stream_mgmt:
+    resend_on_timeout: if_offline
   ##   Non-SASL Authentication (XEP-0078) is now disabled by default
   ##   because it's obsoleted and is used mostly by abandoned
   ##   client software
