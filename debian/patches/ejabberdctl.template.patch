Description: adjust ejabberdctl
 The default ejabberdctl needs some changes to work correctly and to
 avoid unnecessary problematic changes compared to older versions.
Author: Philipp Huebner <debalance@debian.org>

Index: ejabberd/ejabberdctl.template
===================================================================
--- ejabberd.orig/ejabberdctl.template
+++ ejabberd/ejabberdctl.template
@@ -7,14 +7,14 @@ ERL_MAX_PORTS=32000
 ERL_PROCESSES=250000
 ERL_MAX_ETS_TABLES=1400
 FIREWALL_WINDOW=""
-ERLANG_NODE=ejabberd@localhost
+ERLANG_NODE=ejabberd
 
 # define default environment variables
 SCRIPT_DIR=`cd ${0%/*} && pwd`
 ERL={{erl}}
 IEX={{bindir}}/iex
 EPMD={{bindir}}/epmd
-INSTALLUSER={{installuser}}
+INSTALLUSER=ejabberd
 ERL_LIBS={{libdir}}
 
 # check the proper system user is used if defined
@@ -30,7 +30,7 @@ if [ "$INSTALLUSER" != "" ] ; then
             EXEC_CMD="su $INSTALLUSER -c"
         fi
     done
-    if [ `id -g` -eq `id -g $INSTALLUSER` ] ; then
+    if [ `id -nu` = "$INSTALLUSER" -o `id -g` -eq `id -g $INSTALLUSER` ] ; then
         EXEC_CMD="sh -c"
     fi
     if [ "$EXEC_CMD" = "false" ] ; then
@@ -52,7 +52,8 @@ while [ $# -ne 0 ] ; do
         --node) ERLANG_NODE_ARG=$1 ; shift ;;
         --config-dir) ETC_DIR="$1" ; shift ;;
         --config) EJABBERD_CONFIG_PATH="$1" ; shift ;;
-        --ctl-config) EJABBERDCTL_CONFIG_PATH="$1" ; shift ;;
+        --default) EJABBERDCTL_CONFIG_PATH="$1" ; shift ;;
+        --default-dir) DEFAULTDIR="$1" ; shift ;;
         --logs) LOGS_DIR="$1" ; shift ;;
         --spool) SPOOL_DIR="$1" ; shift ;;
         *) ARGS=("${ARGS[@]}" "$PARAM") ;;
@@ -63,8 +64,11 @@ done
 if [ "$ETC_DIR" = "" ] ; then
     ETC_DIR={{sysconfdir}}/ejabberd
 fi
+if [ "$DEFAULTDIR" = "" ] ; then
+    DEFAULTDIR={{sysconfdir}}/default
+fi
 if [ "$EJABBERDCTL_CONFIG_PATH" = "" ] ; then
-    EJABBERDCTL_CONFIG_PATH=$ETC_DIR/ejabberdctl.cfg
+    EJABBERDCTL_CONFIG_PATH=$DEFAULTDIR/ejabberd
 fi
 if [ -f "$EJABBERDCTL_CONFIG_PATH" ] ; then
     . "$EJABBERDCTL_CONFIG_PATH"
@@ -99,6 +103,7 @@ fi
 EJABBERD_LOG_PATH=$LOGS_DIR/ejabberd.log
 DATETIME=`date "+%Y%m%d-%H%M%S"`
 ERL_CRASH_DUMP=$LOGS_DIR/erl_crash_$DATETIME.dump
+HOME=$SPOOL_DIR
 ERL_INETRC=$ETC_DIR/inetrc
 
 # define mnesia options
@@ -337,7 +342,8 @@ help()
     echo "Optional parameters when starting an ejabberd node:"
     echo "  --config-dir dir   Config ejabberd:    $ETC_DIR"
     echo "  --config file      Config ejabberd:    $EJABBERD_CONFIG_PATH"
-    echo "  --ctl-config file  Config ejabberdctl: $EJABBERDCTL_CONFIG_PATH"
+    echo "  --default file     Config ejabberdctl: $EJABBERDCTL_CONFIG_PATH"
+    echo "  --default-dir      Config ejabberdctl: $DEFAULTDIR"
     echo "  --logs dir         Directory for logs: $LOGS_DIR"
     echo "  --spool dir        Database spool dir: $SPOOL_DIR"
     echo "  --node nodename    ejabberd node name: $ERLANG_NODE"
@@ -357,7 +363,7 @@ ctl()
         JOT=/usr/bin/jot
         if [ ! -x "$JOT" ] ; then
             # no flock or jot, simply invoke ctlexec()
-            CTL_CONN="ctl-${ERLANG_NODE}"
+            CTL_CONN="ctl-$$-${ERLANG_NODE}"
             ctlexec $CTL_CONN "$@"
             result=$?
         else
