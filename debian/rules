#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DESTDIR=$(CURDIR)/debian/ejabberd
# NOTE: We force libdir, because it defaults to /var/lib/x86_64-linux-gnu
# on Debian Stable and all Ubuntu distros up to at least Saucy.
DEB_CONFIGURE_EXTRA_FLAGS := --enable-nif --enable-pam --libdir=/usr/lib \
    --enable-odbc --enable-mysql --enable-pgsql \
    --enable-stun --enable-json

override_dh_auto_configure:
	dh_auto_configure -- ${DEB_CONFIGURE_EXTRA_FLAGS}

override_dh_clean:
	dh_clean -Xasn1/ELDAPv3.asn1~

override_dh_auto_install:
	dh_auto_install

	# Remove unused upstream config files/move to correct location
	mv $(DESTDIR)/etc/ejabberd/ejabberd.yml $(DESTDIR)/usr/share/ejabberd/ejabberd.yml
	mv $(DESTDIR)/etc/ejabberd/ejabberdctl.cfg $(DESTDIR)/etc/default/ejabberd

	# Remove unused upstream directories:
	rm -rf $(DESTDIR)/var/lock
	rmdir $(DESTDIR)/var/lib/ejabberd
	rmdir $(DESTDIR)/var/lib

	# Remove upstream license file:
	rm $(DESTDIR)/usr/share/doc/ejabberd/COPYING

	find $(CURDIR) | sort | grep init
	cp $(CURDIR)/ejabberd.init $(CURDIR)/debian/

override_dh_fixperms:
	dh_fixperms
	erlang-depends

# test suite requires a running mysql and postgres server, so skipping the test.
override_dh_auto_test:

%:
	dh $@ ${DH_ARGS}
