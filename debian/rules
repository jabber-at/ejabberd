#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# NOTE: We force libdir, because it defaults to /var/lib/x86_64-linux-gnu
# on Debian Stable and all Ubuntu distros up to at least Saucy.
DEB_CONFIGURE_EXTRA_FLAGS := --enable-odbc --enable-pam --libdir=/usr/lib
# Not sure if we should enable workaround for gateway subscription
# Adding it breaks XMPP compatibility
# Not adding breaks roster import for some gateways (specifically JIT)
#DEB_CONFIGURE_EXTRA_FLAGS := --enable-odbc --enable-roster-gateway-workaround


DESTDIR=$(CURDIR)/debian/ejabberd

ifndef HOME
	export HOME="$(CURDIR)"
endif

override_dh_clean:
	dh_clean -Xasn1/ELDAPv3.asn1~

override_dh_auto_install:
	dh_auto_install

	# Remove unused upstream config files:
	find $(DESTDIR)/
	rm $(DESTDIR)/etc/ejabberd/ejabberd.yml
	rm $(DESTDIR)/etc/ejabberd/ejabberdctl.cfg

	# Remove unused upstream directories:
	rm -rf $(DESTDIR)/var/lock

	# Remove upstream license file:
	rm $(DESTDIR)/usr/share/doc/ejabberd/COPYING

	# Remove autogenerated init-script:
	rm $(CURDIR)/src/ejabberd.init

override_dh_auto_test:

get-orig-source:
	dh_testdir
	wget -O ../ejabberd_$(DEB_UPSTREAM_VERSION).orig.tar.gz \
		http://www.process-one.net/en/projects/ejabberd/download/$(DEB_UPSTREAM_VERSION)/ejabberd-$(DEB_UPSTREAM_VERSION).tar.gz

%:
	dh $@ ${DH_ARGS}
