#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/buildflags.mk

CFLAGS += -fPIC
CPPFLAGS += -fPIC

DESTDIR=$(CURDIR)/debian/ejabberd
# NOTE: We force libdir, because it defaults to /var/lib/x86_64-linux-gnu
# on Debian Stable and all Ubuntu distros up to at least Saucy.
DEB_CONFIGURE_EXTRA_FLAGS := --enable-nif --enable-pam --libdir=/usr/lib \
    --enable-odbs --enable-mysql --enable-pgsql \
    --enable-stun --enable-json

override_dh_auto_configure:
	dh_auto_configure -- ${DEB_CONFIGURE_EXTRA_FLAGS}

override_dh_clean:
	dh_clean -Xasn1/ELDAPv3.asn1~

override_dh_auto_install:
	dh_auto_install

	# Remove unused upstream config files/move to correct location
	mv $(DESTDIR)/etc/ejabberd/ejabberd.yml $(DESTDIR)/usr/share/ejabberd/ejabberd.yml
	mv $(DESTDIR)/etc/ejabberd/ejabberdctl.cfg $(DESTDIR)/etc/default/ejabberd

	# Remove unused upstream directories:
	rm -rf $(DESTDIR)/var/lock

	# Remove upstream license file:
	rm $(DESTDIR)/usr/share/doc/ejabberd/COPYING

	# Remove autogenerated init-script:
	#rm $(CURDIR)/src/ejabberd.init
	find $(CURDIR) | sort | grep init

# test suite requires a running mysql and postgres server, so skipping the test.
override_dh_auto_test:

%:
	dh $@ ${DH_ARGS}
