<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>ejabberd Installation and Operation Guide</title>
	<meta name="bodyclass" content="nocomment"/>
<style>@font-face {font-family: "nunito-bold";src: url("../fonts/Nunito-Bold-webfont.eot");src: url("../fonts/Nunito-Bold-webfont.eot?#iefix") format("embedded-opentype"), url("../fonts/Nunito-Bold-webfont.woff2") format("woff2"), url("../fonts/Nunito-Bold-webfont.woff") format("woff"), url("../fonts/Nunito-Bold-webfont.ttf") format("truetype"), url("../fonts/Nunito-Bold-webfont.svg#nunito-bold") format("svg");font-weight: bold;font-style: normal;}@font-face {font-family: "nunito-light";src: url("../fonts/Nunito-Light-webfont.eot");src: url("../fonts/Nunito-Light-webfont.eot?#iefix") format("embedded-opentype"), url("../fonts/Nunito-Light-webfont.woff2") format("woff2"), url("../fonts/Nunito-Light-webfont.woff") format("woff"), url("../fonts/Nunito-Light-webfont.ttf") format("truetype"), url("../fonts/Nunito-Light-webfont.svg#nunito-light") format("svg");font-weight: lighter;font-style: normal;}@font-face {font-family: "nunito-regular";src: url("../fonts/Nunito-Regular-webfont.eot");src: url("../fonts/Nunito-Regular-webfont.eot?#iefix") format("embedded-opentype"), url("../fonts/Nunito-Regular-webfont.woff2") format("woff2"), url("../fonts/Nunito-Regular-webfont.woff") format("woff"), url("../fonts/Nunito-Regular-webfont.ttf") format("truetype"), url("../fonts/Nunito-Regular-webfont.svg#nunito-regular") format("svg");font-weight: normal;font-style: normal;}body{background: #3eaefb;font-family: "nunito-light", Helvetica, Arial, sans-serif;font-weight: lighter;}  body.homepage{background: url(../images/background@2x.jpg) center 60px no-repeat #3eaefb;background-size: 100% auto;}  body.blog{background: #fff;}    body .on-blog,  body.blog #sidebar,  body.blog .off-blog{display: none;}    body.blog .on-blog{display: block;}a{color: #3daefb;}  a:hover,  a:active{color: #3daefb;}ul{padding-left: 1.25em;}h1,h2,h3,h4,h5,h6{font-family: "nunito-regular", Helvetica, Arial, sans-serif;font-weight: normal;}h2,h3,h4{margin-top: 1.5em;}h5,h5{margin-top: 20px;}.btn{padding: 1em 2em;border: 1px solid #fff;border-radius: 8px;text-transform: uppercase;font-weight: lighter !important;}  .btn:hover{border-color: #fff;background-color: #fff;color: #3e9cda !important;}    .container-fluid .row > div:first-child{padding-left: 10%;}.container-fluid .row > div:last-child{padding-right: 10%;}#header-wrapper{padding: 20px 0 15px 0;background-color: #2B3038;}#logo{display: inline-block;text-decoration: none;font-size: 18px;color: #3EAFFA;}  #logo > *{display: inline-block;vertical-align: bottom;}  #logo img{margin-right: 10px;}#logo-footer{display: inline-block;font-size: 34px;}#header menu{margin: 0;padding: 0;list-style: none;float: right;}   #header menu li a{padding-left: 20px;background: url(../images/arrow_header@2x.png) left center no-repeat transparent;background-size: 9px 13px;text-transform: uppercase;color: #fff;}    #header menu li a:hover,  #header menu li a:active{color: #fff;}#sidebar,#content{min-height: 728px;}#sidebar{padding-top: 60px;background: url(../images/background@2x.jpg) top center no-repeat #3eaefb;background-size: auto 728px;line-height: 2em;font-size: 18px;}  body.homepage #sidebar{background: none;}  #sidebar a{text-decoration: none;color: #444;}    #sidebar a.current-item{color: #fff;}    #sidebar a:hover,  #sidebar a:active{text-decoration: none;color: #fff;}    #sidebar ul{margin: 0;padding: 0;list-style: none;}    #sidebar ul ul{margin-left: 10px;line-height: 2em;font-size: 0.9em;}    body.homepage #sidebar ul li:first-child a{color: #fff;}#content{padding-top: 60px;padding-left: 10%;background: #fff;line-height: 1.75em;font-size: 15px;color: #666;}  body.homepage #content{background: transparent;color: #fff;}  body.blog #content{padding-left: 10%;background: transparent;}  body.homepage #content h1{margin-top: 0;}  body.homepage #content h1,  body.homepage #content p{margin-bottom: 40px;}    body.homepage #content a{font-weight: bold;color: inherit;}#footer-wrapper{background-color: #2B3038;padding: 30px 0 60px 0;}  #footer a{color: #666;}  #footer a:hover,  #footer a:active{text-decoration: none;color: #fff;}    #footer menu{list-style: none;padding: 0;}  #footer .sitemap{display: inline-block;vertical-align: top;margin: 0 100px 40px 0;padding: 0;list-style: none;line-height: 1.75em;font-size: 13px;}    #footer .sitemap li a{text-transform: uppercase;color: #999;}    #footer .sitemap li:first-child a{text-transform: none;color: #3daefb;}    #footer .sitemap li a:hover,    #footer .sitemap li a:active{text-decoration: none;color: #fff;}    #disqus_thread{margin-top: 40px;}    #content img{max-width: 100%;}.line-numbers{margin-right: 1em;}  .line-numbers a{color: #bbb;}  .line-numbers a:hover,  .line-numbers a:active{color: #666;}code{background: inherit;color: inherit;margin: 0;padding: 0;}  body.blog .meta{margin: 0;padding: 0;list-style: none;font-size: 11px;}  body.blog .meta li{margin-right: 10px;display: inline-block;}    body.blog .meta .who_when img{margin-right: 3px;border-radius: 10px;vertical-align: middle;}      body.blog h2.title{margin: 10px 0 20px 0;}    body.blog .read-more{display: inline-block;padding: 0.1em 1em 0.2em 1em;border: 1px solid #ccc;border-radius: 2em;}@media only screen and (max-width: 990px) {#sidebar, #content { min-height: inherit;}    #sidebar,  #content{padding-top: 20px;padding-bottom: 20px;}}
pre,code{background-color:#24282d;color:#93a1a1}.highlight,.code{background-color:#24282d;color:#93a1a1}.linenos{background-color:#24282d;color:#586e75}.linenos pre{color:#586e75!important}.highlight .c{color:#586e75}.highlight .err{color:#93a1a1}.highlight .g{color:#93a1a1}.highlight .k{color:#859900}.highlight .l{color:#93a1a1}.highlight .n{color:#93a1a1}.highlight .o{color:#859900}.highlight .x{color:#cb4b16}.highlight .p{color:#93a1a1}.highlight .cm{color:#586e75}.highlight .cp{color:#859900}.highlight .c1{color:#586e75}.highlight .cs{color:#859900}.highlight .gd{color:#2aa198}.highlight .ge{color:#93a1a1;font-style:italic}.highlight .gr{color:#dc322f}.highlight .gh{color:#cb4b16}.highlight .gi{color:#859900}.highlight .go{color:#93a1a1}.highlight .gp{color:#93a1a1}.highlight .gs{color:#93a1a1;font-weight:bold}.highlight .gu{color:#cb4b16}.highlight .gt{color:#93a1a1}.highlight .kc{color:#cb4b16}.highlight .kd{color:#268bd2}.highlight .kn{color:#859900}.highlight .kp{color:#859900}.highlight .kr{color:#268bd2}.highlight .kt{color:#dc322f}.highlight .ld{color:#93a1a1}.highlight .m{color:#2aa198}.highlight .s{color:#2aa198}.highlight .na{color:#93a1a1}.highlight .nb{color:#b58900}.highlight .nc{color:#268bd2}.highlight .no{color:#cb4b16}.highlight .nd{color:#268bd2}.highlight .ni{color:#cb4b16}.highlight .ne{color:#cb4b16}.highlight .nf{color:#268bd2}.highlight .nl{color:#93a1a1}.highlight .nn{color:#93a1a1}.highlight .nx{color:#93a1a1}.highlight .py{color:#93a1a1}.highlight .nt{color:#268bd2}.highlight .nv{color:#268bd2}.highlight .ow{color:#859900}.highlight .w{color:#93a1a1}.highlight .mf{color:#2aa198}.highlight .mh{color:#2aa198}.highlight .mi{color:#2aa198}.highlight .mo{color:#2aa198}.highlight .sb{color:#586e75}.highlight .sc{color:#2aa198}.highlight .sd{color:#93a1a1}.highlight .s2{color:#2aa198}.highlight .se{color:#cb4b16}.highlight .sh{color:#93a1a1}.highlight .si{color:#2aa198}.highlight .sx{color:#2aa198}.highlight .sr{color:#dc322f}.highlight .s1{color:#2aa198}.highlight .ss{color:#2aa198}.highlight .bp{color:#268bd2}.highlight .vc{color:#268bd2}.highlight .vg{color:#268bd2}.highlight .vi{color:#268bd2}.highlight .il{color:#2aa198}td.linenos,td.code{display:inline-block;margin:0;padding:0;border:0}td.linenos{padding-right:1em}table.highlighttable{margin:0;padding:0;width:100%;overflow:auto;white-space:nowrap}table.highlighttable td{vertical-align:middle!important}pre,code{border-radius:3px;margin:0;font-size:15px;line-height:18px}pre code{display:block;padding:0 3px}pre{padding:1em}pre pre{padding:0;overflow:visible}
.TOC { float: left; width: 20% }
#content { float: left; width: 75%; padding-left: 2em; padding-right: 2em; }
code {
background: inherit;
color: inherit;
margin: 0px;
padding: 0px;
font-size: inherit !important;
font-family: inherit;
}
</style>
</head>
<body>

<div id="sidebar" class="TOC">
<ul>
<li><a href="#introduction">Introduction</a>

<ul>
<li><a href="#keyfeatures">Key Features</a></li>
<li><a href="#additionalfeatures">Additional Features</a></li>
</ul></li>
<li><a href="#ejabberdinstallationandsetup">ejabberd Installation and Setup</a>

<ul>
<li><a href="#installingejabberdwithbinaryinstaller">Installing ejabberd with Binary Installer</a>

<ul>
<li><a href="#downloadandrunningtheinstaller">Download and running the installer</a></li>
<li><a href="#usingejabberdonmicrosoftwindows">Using ejabberd on Microsoft Windows</a></li>
</ul></li>
<li><a href="#installingejabberdwithoperatingsystemspecificpackages">Installing ejabberd with Operating System Specific Packages</a></li>
<li><a href="#installingejabberdfromsourcecode">Installing ejabberd from Source Code</a>

<ul>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#downloadsourcecode">Download Source Code</a></li>
<li><a href="#compile">Compile</a>

<ul>
<li><a href="#configureoptions">Configure options</a></li>
</ul></li>
<li><a href="#install">Install</a></li>
<li><a href="#start">Start</a></li>
<li><a href="#specificnotes">Specific Notes</a>

<ul>
<li><a href="#specificnotesforosx">Specific Notes for OSX</a></li>
<li><a href="#specificnotesforbsd">Specific Notes for BSD</a></li>
<li><a href="#specificnotesforsunsolaris">Specific Notes for Sun Solaris</a></li>
</ul></li>
</ul></li>
<li><a href="#post-installoperations">Post-install Operations</a>

<ul>
<li><a href="#creatinganxmppaccountforadministration">Creating an XMPP Account for Administration</a></li>
<li><a href="#upgradingejabberd">Upgrading ejabberd</a></li>
</ul></li>
</ul></li>
<li><a href="#configuringejabberd">Configuring ejabberd</a>

<ul>
<li><a href="#configfileformatting">Config File Formatting</a>

<ul>
<li><a href="#yamlconfigurationfileformat">Yaml Configuration File Format</a></li>
<li><a href="#legacyconfigurationfile">Legacy Configuration File</a></li>
</ul></li>
<li><a href="#configuringoneorseveralxmppdomains">Configuring One or Several XMPP Domains</a>

<ul>
<li><a href="#hostnames">Host Names</a></li>
<li><a href="#virtualhosting">Virtual Hosting</a></li>
</ul></li>
<li><a href="#basicconfiguration">Basic Configuration</a>

<ul>
<li><a href="#logging">Logging</a></li>
<li><a href="#listeningports">Listening Ports</a>

<ul>
<li><a href="#portnumberipaddressandtransportprotocol">Port Number, IP Address and Transport Protocol</a></li>
<li><a href="#listeningmodule">Listening Module</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#examples">Examples</a></li>
</ul></li>
<li><a href="#authentication">Authentication</a>

<ul>
<li><a href="#internal">Internal</a></li>
<li><a href="#externalscript">External Script</a></li>
<li><a href="#anonymousloginandsaslanonymous">Anonymous Login and SASL Anonymous</a></li>
<li><a href="#pamauthentication">PAM Authentication</a></li>
</ul></li>
<li><a href="#accessrules">Access Rules</a>

<ul>
<li><a href="#acldefinition">ACL Definition</a></li>
<li><a href="#accessrights">Access Rights</a></li>
<li><a href="#limitingopenedsessionswithacl">Limiting Opened Sessions with ACL</a></li>
<li><a href="#severalconnectionstoaremotexmppserverwithacl">Several connections to a remote XMPP server with ACL</a></li>
</ul></li>
<li><a href="#shapers">Shapers</a></li>
<li><a href="#defaultlanguage">Default Language</a></li>
<li><a href="#captcha">CAPTCHA</a></li>
<li><a href="#nodesettings">Node settings</a></li>
<li><a href="#stunandturn">STUN and TURN</a></li>
<li><a href="#sip">SIP</a></li>
<li><a href="#includeadditionalconfigurationfiles">Include Additional Configuration Files</a></li>
<li><a href="#optionmacrosinconfigurationfile">Option Macros in Configuration File</a></li>
</ul></li>
<li><a href="#databaseandldapconfiguration">Database and LDAP Configuration</a>

<ul>
<li><a href="#relationaldatabases">Relational Databases</a>

<ul>
<li><a href="#storage">Storage</a></li>
</ul></li>
<li><a href="#ldap">LDAP</a>

<ul>
<li><a href="#connection">Connection</a></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#examples">Examples</a>

<ul>
<li><a href="#commonexample">Common example</a></li>
<li><a href="#activedirectory">Active Directory</a></li>
</ul></li>
</ul></li>
<li><a href="#riak">Riak</a>

<ul>
<li><a href="#connection">Connection</a></li>
<li><a href="#storage">Storage</a></li>
<li><a href="#riakconfiguration">Riak Configuration</a></li>
</ul></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#defaultdatabaseconfiguration">Default database configuration</a></li>
</ul></li>
<li><a href="#sessionmanagement">Session Management</a></li>
<li><a href="#modulesconfiguration">Modules Configuration</a>

<ul>
<li><a href="#modulesoverview">Modules Overview</a></li>
<li><a href="#commonoptions">Common Options</a>

<ul>
<li><a href="#iqdisc">iqdisc</a></li>
<li><a href="#host">host</a></li>
</ul></li>
<li><a href="#mod_admin_extra">mod_admin_extra</a></li>
<li><a href="#mod_announce">mod_announce</a></li>
<li><a href="#mod_client_state">mod_client_state</a></li>
<li><a href="#mod_disco">mod_disco</a></li>
<li><a href="#mod_echo">mod_echo</a></li>
<li><a href="#mod_fail2ban">mod_fail2ban</a></li>
<li><a href="#mod_http_bind">mod_http_bind</a></li>
<li><a href="#mod_http_fileserver">mod_http_fileserver</a></li>
<li><a href="#mod_http_ws">mod_http_ws</a></li>
<li><a href="#mod_irc">mod_irc</a></li>
<li><a href="#mod_last">mod_last</a></li>
<li><a href="#mod_mam">mod_mam</a></li>
<li><a href="#mod_muc">mod_muc</a></li>
<li><a href="#mod_muc_log">mod_muc_log</a></li>
<li><a href="#mod_multicast">mod_multicast</a></li>
<li><a href="#mod_offline">mod_offline</a></li>
<li><a href="#mod_ping">mod_ping</a></li>
<li><a href="#mod_pres_counter">mod_pres_counter</a></li>
<li><a href="#mod_privacy">mod_privacy</a></li>
<li><a href="#mod_private">mod_private</a></li>
<li><a href="#mod_proxy65">mod_proxy65</a></li>
<li><a href="#mod_pubsub">mod_pubsub</a></li>
<li><a href="#mod_register">mod_register</a></li>
<li><a href="#mod_register_web">mod_register_web</a></li>
<li><a href="#mod_roster">mod_roster</a></li>
<li><a href="#mod_service_log">mod_service_log</a></li>
<li><a href="#mod_shared_roster">mod_shared_roster</a></li>
<li><a href="#mod_shared_roster_ldap">mod_shared_roster_ldap</a>

<ul>
<li><a href="#configurationparameters">Configuration parameters</a>

<ul>
<li><a href="#filters">Filters</a></li>
</ul></li>
<li><a href="#attributes">Attributes</a></li>
<li><a href="#controlparameters">Control parameters</a></li>
<li><a href="#connectionparameters">Connection parameters</a></li>
<li><a href="#retrievingtheroster">Retrieving the roster</a></li>
<li><a href="#configurationexamples">Configuration examples</a>

<ul>
<li><a href="#flatdit">Flat DIT</a></li>
<li><a href="#deepdit">Deep DIT</a></li>
</ul></li>
</ul></li>
<li><a href="#mod_sic">mod_sic</a></li>
<li><a href="#mod_sip">mod_sip</a></li>
<li><a href="#mod_stats">mod_stats</a></li>
<li><a href="#mod_time">mod_time</a></li>
<li><a href="#mod_vcard">mod_vcard</a></li>
<li><a href="#mod_vcard_ldap">mod_vcard_ldap</a></li>
<li><a href="#mod_vcard_xupdate">mod_vcard_xupdate</a></li>
<li><a href="#mod_version">mod_version</a></li>
</ul></li>
</ul></li>
<li><a href="#managinganejabberdserver">Managing an ejabberd server</a>

<ul>
<li><a href="#ejabberdctl">ejabberdctl</a>

<ul>
<li><a href="#ejabberdctlcommands">ejabberdctl Commands</a></li>
<li><a href="#erlangruntimesystem">Erlang Runtime System</a></li>
</ul></li>
<li><a href="#ejabberdcommands">ejabberd Commands</a>

<ul>
<li><a href="#listofejabberdcommands">List of ejabberd Commands</a></li>
<li><a href="#restrictexecutionwithaccesscommands">Restrict Execution with AccessCommands</a></li>
</ul></li>
<li><a href="#webadmin">Web Admin</a></li>
<li><a href="#ad-hoccommands">Ad-hoc Commands</a></li>
<li><a href="#changecomputerhostname">Change Computer Hostname</a></li>
</ul></li>
<li><a href="#securingejabberd">Securing ejabberd</a>

<ul>
<li><a href="#firewallsettings">Firewall Settings</a></li>
<li><a href="#epmd">epmd</a></li>
<li><a href="#erlangcookie">Erlang Cookie</a></li>
<li><a href="#erlangnodename">Erlang Node Name</a></li>
<li><a href="#securingsensitivefiles">Securing Sensitive Files</a></li>
</ul></li>
<li><a href="#clustering">Clustering</a>

<ul>
<li><a href="#howitworks">How it Works</a>

<ul>
<li><a href="#router">Router</a></li>
<li><a href="#localrouter">Local Router</a></li>
<li><a href="#sessionmanager">Session Manager</a></li>
<li><a href="#s2smanager">s2s Manager</a></li>
</ul></li>
<li><a href="#clusteringsetup">Clustering Setup</a>

<ul>
<li><a href="#addinganodeinacluster">Adding a node in a cluster</a></li>
<li><a href="#removinganodefromthecluster">Removing a node from the cluster</a></li>
</ul></li>
</ul></li>
<li><a href="#serviceload-balancing">Service Load-Balancing</a></li>
<li><a href="#troubleshootingejabberd">Troubleshooting ejabberd</a>

<ul>
<li><a href="#logfiles">Log Files</a></li>
<li><a href="#debugconsole">Debug Console</a></li>
<li><a href="#watchdogalerts">Watchdog Alerts</a></li>
</ul></li>
</ul>
</div>

<p><div id='content'></p>

<h1 id="introduction">Introduction</h1>

<p><code>ejabberd</code> is a <em>free and open source</em> instant messaging server written in <a href="http://www.erlang.org/"><code>Erlang/OTP</code></a>.</p>

<p><code>ejabberd</code> is <em>cross-platform</em>, distributed, fault-tolerant, and based on open standards to achieve real-time communication.</p>

<p><code>ejabberd</code> is designed to be a <em>rock-solid and feature rich</em> XMPP server.</p>

<p><code>ejabberd</code> is suitable for small deployments, whether they need to be <em>scalable</em> or not, as well as extremely big deployments.</p>

<h2 id="keyfeatures">Key Features</h2>

<p><code>ejabberd</code> is:</p>

<ul>
<li><p><em>Cross-platform:</em> <code>ejabberd</code> runs under Microsoft Windows and Unix derived systems such as Linux, FreeBSD and NetBSD.</p></li>
<li><p><em>Distributed:</em> You can run <code>ejabberd</code> on a cluster of machines and all of them will serve the same Jabber domain(s). When you need more capacity you can simply add a new cheap node to your cluster. Accordingly, you do not need to buy an expensive high-end machine to support tens of thousands concurrent users.</p></li>
<li><p><em>Fault-tolerant:</em> You can deploy an <code>ejabberd</code> cluster so that all the information required for a properly working service will be replicated permanently on all nodes. This means that if one of the nodes crashes, the others will continue working without disruption. In addition, nodes also can be added or replaced 'on the fly'.</p></li>
<li><p><em>Administrator Friendly:</em> <code>ejabberd</code> is built on top of the Erlang programming language. As a result, if you wish, you can perform self-contained deployments. You are not required to install an external database, an external web server, amongst others because everything is already included, and ready to run out of the box. Other administrator benefits include:</p>

<ul>
<li>Comprehensive documentation.</li>
<li>Straightforward installers for Linux, Mac OS X, and Windows.</li>
<li>Web Administration.</li>
<li>Shared Roster Groups.</li>
<li>Command line administration tool.</li>
<li>Can integrate with existing authentication mechanisms.</li>
<li>Capability to send announce messages.</li>
</ul></li>
<li><p><em>Internationalized:</em> <code>ejabberd</code> leads in internationalization. Hence it is very well suited to build service available across the world. Related features are:</p>

<ul>
<li>Translated to 25 languages.</li>
<li>Support for <a href="http://tools.ietf.org/html/rfc3490"><code>IDNA</code></a>.</li>
</ul></li>
<li><p><em>Open Standards:</em> <code>ejabberd</code> is the first Open Source Jabber server claiming to fully comply to the XMPP standard.</p>

<ul>
<li>Fully XMPP compliant.</li>
<li>XML-based protocol.</li>
<li><a href="http://www.ejabberd.im/protocols">Many protocols supported</a>.</li>
</ul></li>
</ul>

<h2 id="additionalfeatures">Additional Features</h2>

<p>Moreover, <code>ejabberd</code> comes with a wide range of other state-of-the-art features:</p>

<ul>
<li><p>Modular</p>

<ul>
<li>Load only the modules you want.</li>
<li>Extend <code>ejabberd</code> with your own custom modules.</li>
</ul></li>
<li><p>Security</p>

<ul>
<li>SASL and STARTTLS for c2s and s2s connections.</li>
<li>STARTTLS and Dialback s2s connections.</li>
<li>Web Admin accessible via HTTPS secure access.</li>
</ul></li>
<li><p>Databases</p>

<ul>
<li>Internal database for fast deployment (Mnesia).</li>
<li>Native MySQL support.</li>
<li>Native PostgreSQL support.</li>
<li>ODBC data storage support.</li>
<li>Microsoft SQL Server support.</li>
<li>Riak NoSQL database support.</li>
</ul></li>
<li><p>Authentication</p>

<ul>
<li>Internal Authentication.</li>
<li>PAM, LDAP, ODBC and Riak.</li>
<li>External Authentication script.</li>
</ul></li>
<li><p>Others</p>

<ul>
<li>Support for virtual hosting.</li>
<li>Compressing XML streams with Stream Compression
(<a href="http://xmpp.org/extensions/xep-0138.html"><code>XEP-0138</code></a>).</li>
<li>Statistics via Statistics Gathering
(<a href="http://xmpp.org/extensions/xep-0039.html"><code>XEP-0039</code></a>).</li>
<li>IPv6 support both for c2s and s2s connections.</li>
<li><a href="http://xmpp.org/extensions/xep-0045.html"><code>Multi-User Chat</code></a> module with support for clustering and HTML logging.</li>
<li>Users Directory based on users vCards.</li>
<li><a href="http://xmpp.org/extensions/xep-0060.html"><code>Publish-Subscribe</code></a> component with support for
<a href="http://xmpp.org/extensions/xep-0163.html"><code>Personal Eventing via Pubsub</code></a>.</li>
<li>Support for web clients: Support for <a href="https://tools.ietf.org/html/rfc7395">XMPP subprotocol for Websocket</a> and <a href="http://xmpp.org/extensions/xep-0206.html"><code>HTTP Binding (BOSH)</code></a> services.</li>
<li>IRC transport.</li>
<li>SIP support.</li>
<li>Component support: interface with networks such as AIM, ICQ and MSN installing special tranports.</li>
</ul></li>
</ul>

<h1 id="ejabberdinstallationandsetup">ejabberd Installation and Setup</h1>

<p>You have several options to install ejabberd:</p>

<ul>
<li><a href="#installingejabberdwithbinaryinstaller">Installing <code>ejabberd</code> with Binary Installer</a></li>
<li><a href="#installingejabberdwithoperatingsystemspecificpackages">Installing <code>ejabberd</code> with Operating System Specific Packages</a></li>
<li><a href="#installingejabberdfromsourcecode">Installing <code>ejabberd</code> from Source Code</a></li>
</ul>

<p>Once installed, you may want to register users and create admin accounts:</p>

<ul>
<li><a href="#postinstalloperations">Post-install Operations</a></li>
</ul>

<hr />

<h2 id="installingejabberdwithbinaryinstaller">Installing ejabberd with Binary Installer</h2>

<h3 id="downloadandrunningtheinstaller">Download and running the installer</h3>

<p>Probably the easiest way to install an <code>ejabberd</code> instant messaging
server is using the binary installer published by ProcessOne. The
binary installers of released <code>ejabberd</code> versions are available in the
<a href="http://www.process-one.net/">ProcessOne</a> <code>ejabberd</code> downloads page: <a href="http://www.process-one.net/en/ejabberd/downloads">ejabberd Downloads</a>.</p>

<p>The binary installer will deploy and configure a full featured
<code>ejabberd</code> server and does not require any extra dependencies. It
includes a stripped down version of Erlang. As such, when using
ejabberd installer, you do not need to install Erlang separately.</p>

<p>In *nix systems, remember to set executable the binary installer
before starting it. For example:</p>

<pre><code>#!console
chmod +x ejabberd-15.06-linux-x86_64-installer.run
./ejabberd-15.06-linux-x86_64-installer.run
</code></pre>

<p><code>ejabberd</code> can be started manually at any time, or automatically by
the operating system at system boot time.</p>

<!-- TODO: Link to a page describing the binary installer command-line options -->

<p>To start and stop <code>ejabberd</code> manually, use the desktop shortcuts
created by the installer. If the machine doesn't have a graphical
system, use the scripts 'start' and 'stop' in the 'bin' directory
where <code>ejabberd</code> is installed.</p>

<!-- TODO: What about systemd in newer Linux distributions ? -->

<p>On a *nix system, if you want ejabberd to be started as daemon at
boot time, copy <code>ejabberd.init</code> from the 'bin' directory to something
like <code>/etc/init.d/ejabberd</code> (depending on your distribution). Create a
system user called <code>ejabberd</code>, give it write access to the directories
<code>database/</code> and <code>logs/</code>, and set that as home; the script will start
the server with that user. Then you can call <code>/etc/inid.d/ejabberd
start</code> as root to start the server.</p>

<p>When ejabberd is started, the processes that are started in the system
are <code>beam</code> or <code>beam.smp</code>, and also <code>epmd</code>. For more information
regarding <code>epmd</code> consult the section relating to <a href="#epmd">epmd</a>.</p>

<p>If <code>ejabberd</code> doesn't start correctly and a crash dump file is
generated, there was a severe problem. You can try starting <code>ejabberd</code>
with the script <code>bin/live.bat</code> in Windows, or with the command
<code>bin/ejabberdctl live</code> in other Operating Systems. This way you see
the error message provided by Erlang and can identify what is exactly
the problem.</p>

<p>The <code>ejabberdctl</code> administration script is included in the <code>bin</code>
directory. Please refer to the section <a href="#ejabberdctl">ejabberdctl</a> for details
about <code>ejabberdctl</code>, and configurable options to fine tune the Erlang
runtime system.</p>

<h3 id="usingejabberdonmicrosoftwindows">Using ejabberd on Microsoft Windows</h3>

<p>The Windows installer also adds ejabberd as a system service, and a
shortcut to a debug console for experienced administrators. If you
want ejabberd to be started automatically at boot time, go to the
Windows service settings and set ejabberd to be automatically
started. Note that the Windows service is a feature still in
development, and for example it doesn't read the file
<code>ejabberdctl.cfg</code>.</p>

<p>On Microsoft Windows, the Erlang processes for ejabberd are named
<code>erl.exe</code> and <code>epmd.exe</code>.</p>

<h2 id="installingejabberdwithoperatingsystemspecificpackages">Installing ejabberd with Operating System Specific Packages</h2>

<!-- TODO: Update with mention to our links and RPMs -->

<p>Some Operating Systems provide a specific <code>ejabberd</code> package adapted
to the system architecture and libraries. It usually also checks
dependencies and performs basic configuration tasks like creating the
initial administrator account. Some examples are Debian and
Gentoo. Consult the resources provided by your Operating System for
more information.</p>

<p>Usually those packages create a script like <code>/etc/init.d/ejabberd</code> to
start and stop <code>ejabberd</code> as a service at boot time.</p>

<p>ProcessOne now provides RPM and DEB all in one packages as well, since
ejabberd version 15.06. This is self-sufficient packages also
containing a minimal Erlang distribution. It ensures that it does not
interfere with your existing Erlang version. This is also a good way
to make sure ejabberd will run with the latest Erlang version. You can
download the packages from <a href="http://www.process-one.net/en/ejabberd/downloads">ejabberd Downloads</a>.</p>

<h2 id="installingejabberdfromsourcecode">Installing ejabberd from Source Code</h2>

<p>The canonical form for distribution of <code>ejabberd</code> stable releases is
the source code package. Compiling <code>ejabberd</code> from source code is
quite easy in *nix systems, as long as your system have all the
dependencies.</p>

<h3 id="requirements">Requirements</h3>

<p>To compile <code>ejabberd</code> on a 'Unix-like' operating system, you need:</p>

<ul>
<li>GNU Make</li>
<li>GCC</li>
<li>Libexpat 1.95 or higher</li>
<li>Erlang/OTP R16B03 or higher.</li>
<li>Libyaml 0.1.4 or higher</li>
<li>OpenSSL 1.0.0 or higher, for STARTTLS, SASL and SSL encryption.</li>
<li>Zlib 1.2.3 or higher, for Stream Compression support (<a href="http://xmpp.org/extensions/xep-0138.html"><code>XEP-0138</code></a>). Optional.</li>
<li>PAM library. Optional. For Pluggable Authentication Modules (PAM). See section <a href="#pamauthentication">pam</a>.</li>
<li>GNU Iconv 1.8 or higher, for the IRC Transport (mod_irc). Optional. Not needed on systems with GNU Libc. See section <a href="#modirc">mod_irc</a>.</li>
<li>ImageMagick's Convert program. Optional. For CAPTCHA challenges. See section <a href="#captcha">captcha</a>.</li>
</ul>

<h3 id="downloadsourcecode">Download Source Code</h3>

<p>Released versions of <code>ejabberd</code> are available on ProcessOne
<a href="http://www.process-one.net/en/ejabberd/downloads"><code>ejabberd</code> downloads page</a>.</p>

<p>Alternatively, the latest development source code can be retrieved
from the Git repository using the commands:</p>

<pre><code>#!console
git clone git://github.com/processone/ejabberd.git ejabberd
cd ejabberd
./autogen.sh
</code></pre>

<h3 id="compile">Compile</h3>

<p>To compile <code>ejabberd</code> execute the commands:</p>

<pre><code>#!console
./configure --enable-mysql
make
</code></pre>

<p><em>Note</em>: To build ejabberd, you will need Internet access, as
 dependencies will by downloaded depending on the selected options in </p>

<p>The build configuration script allows several options. To get the full
list run the command:</p>

<pre><code>#!console
./configure --help
</code></pre>

<h4 id="configureoptions">Configure options</h4>

<p>Some options that you may be interested in modifying:</p>

<ul>
<li><p><strong><code>--prefix=/</code></strong>: Specify the path prefix where the files will be
 copied when running the <code>make install</code> command.</p></li>
<li><p><strong><code>--enable-user[=USER]</code></strong>: Allow this normal system user to execute
 the ejabberdctl script (see section??<a href="#ejabberdctl">ejabberdctl</a>), read the
 configuration files, read and write in the spool directory, read and
 write in the log directory. The account user and group must exist in
 the machine before running <code>make install</code>. This account doesn't need
 an explicit HOME directory, because <code>/var/lib/ejabberd/</code> will be
 used by default.</p></li>
<li><p><strong><code>--enable-pam</code></strong>: Enable the PAM authentication method (see section
 <a href="#pamauthentication">pam</a>).</p></li>
<li><p><strong><code>--enable-tools</code></strong>: Enable the use of development tools.</p></li>
<li><p><strong><code>--enable-mysql</code></strong>: Enable MySQL support (see section <a href="#relationaldatabases">databases</a>).</p></li>
<li><p><strong><code>--enable-pgsql</code></strong>: Enable PostgreSQL support (see section <a href="#relationaldatabases">databases</a>).</p></li>
<li><p><strong><code>--enable-sqlite</code></strong>: Enable SQLite support (see section <a href="#relationaldatabases">databases</a>).</p></li>
<li><p><strong><code>--enable-riak</code></strong>: Enable Riak database support (see section <a href="#relationaldatabases">databases</a>).</p></li>
<li><p><strong><code>--enable-redis</code></strong>: Enable Redis support to use for external session storage.</p></li>
<li><p><strong><code>--enable-zlib</code></strong>: Enable Stream Compression (XEP-0138) using zlib.</p></li>
<li><p><strong><code>--enable-lager</code></strong>: Use lager Erlang logging tool instead of
 standard error logger.</p></li>
<li><p><strong><code>--enable-iconv</code></strong>: Enable iconv support. This is needed for
 <code>mod_irc</code> (see section <a href="#modirc">mod_irc</a>).</p></li>
<li><p><strong><code>--enable-debug</code></strong>: Compile with <code>+debug_info</code> enabled.</p></li>
<li><p><strong><code>--enable-nif</code></strong>: Replaces some critical Erlang functions with
 equivalents written in C to improve performance.</p></li>
<li><p><strong><code>--enable-elixir</code></strong>: Build ejabberd with Elixir extension support.</p></li>
<li><p><strong><code>--enable-all</code></strong>: Enable all previous options.</p></li>
</ul>

<p>Here are other available options, that are experimental and not recommended:</p>

<ul>
<li><p><strong><code>--enable-json</code></strong>: Enable JSON support for mod_bosh. This allow to
 use JSON instead of XML packet format from the browser.</p></li>
<li><p><strong><code>--disable-transient-supervisors</code></strong>: Disable the use of Erlang/OTP
 supervision for transient processes.</p></li>
<li><p><strong><code>--enable-full-xml</code></strong>: Enable the use of XML based
 optimisations. It will for example use CDATA to escape characters in
 the XMPP stream. Use this option only if you are sure your XMPP
 clients include a fully compliant XML parser.</p></li>
<li><p><strong><code>--enable-hipe</code></strong>: Compile natively with HiPE, not recommended.</p></li>
</ul>

<h3 id="install">Install</h3>

<p>To install <code>ejabberd</code> in the destination directories, run the command:</p>

<pre><code>#!console
make install
</code></pre>

<p>Note that you probably need administrative privileges in the system to
install <code>ejabberd</code>.</p>

<p>The files and directories created are, by default:</p>

<!-- TODO: Check we are up to date -->

<ul>
<li><p><code>/etc/ejabberd/</code>: Configuration directory:</p>

<ul>
<li><code>ejabberd.yml</code>: ejabberd configuration file</li>
<li><code>ejabberdctl.cfg</code>: Configuration file of the administration script</li>
<li><code>inetrc</code>: Network DNS configuration file for Erlang</li>
</ul></li>
<li><p><code>/lib/ejabberd/</code>:</p>

<ul>
<li><code>ebin/</code>: Erlang binary files (*.beam)</li>
<li><code>include/</code>: Erlang header files (*.hrl)</li>
<li><code>priv/</code>: Additional files required at runtime</li>
<li><code>bin/</code>: Executable programs</li>
<li><code>lib/</code>: Binary system libraries (*.so)</li>
<li><code>msgs/</code>: Translation files (*.msgs)</li>
</ul></li>
<li><p><code>/sbin/ejabberdctl</code>: Administration script (see section??<a href="#ejabberdctl">ejabberdctl</a>)</p></li>
<li><p><code>/share/doc/ejabberd/</code>: Documentation of ejabberd</p></li>
<li><p><code>/var/lib/ejabberd/</code>: Spool directory:</p></li>
<li><p><code>.erlang.cookie</code>: Erlang cookie file (see section <a href="#erlangcookie">cookie</a>)</p></li>
<li><p><code>acl.DCD, ...</code>: Mnesia database spool files (*.DCD, *.DCL, *.DAT)</p></li>
<li><p><code>/var/log/ejabberd/</code>: Log directory (see section??<a href="#logfiles">logfiles</a>):</p>

<ul>
<li><code>ejabberd.log</code>: ejabberd service log</li>
<li><code>erlang.log</code>: Erlang/OTP system log</li>
</ul></li>
</ul>

<h3 id="start">Start</h3>

<p>You can use the <code>ejabberdctl</code> command line administration script to
start and stop <code>ejabberd</code>. If you provided the configure option
<code>-enable-user=USER</code> (see <a href="#compile">compile</a>), you can execute <code>ejabberdctl</code>
with either that system account or root.</p>

<p>Usage example:</p>

<pre><code>#!console
prompt&gt; ejabberdctl start

prompt&gt; ejabberdctl status
The node ejabberd@localhost is started with status: started
ejabberd is running in that node

prompt&gt; ejabberdctl stop
</code></pre>

<p>If <code>ejabberd</code> doesn't start correctly and a crash dump is generated,
there was a severe problem. You can try starting <code>ejabberd</code> with the
command <code>ejabberdctl live</code> to see the error message provided by Erlang
and can identify what is exactly the problem.</p>

<p>Please refer to the section??<a href="#ejabberdctl">ejabberdctl</a> for details about
<code>ejabberdctl</code>, and configurable options to fine tune the Erlang
runtime system.</p>

<!-- TODO: What about systemd -->

<p>If you want ejabberd to be started as daemon at boot time, copy
<code>ejabberd.init</code> to something like <code>/etc/init.d/ejabberd</code> (depending on
your distribution). Create a system user called <code>ejabberd</code>; it will be
used by the script to start the server. Then you can call
<code>/etc/inid.d/ejabberd start</code> as root to start the server.</p>

<h3 id="specificnotes">Specific Notes</h3>

<h4 id="specificnotesforosx">Specific Notes for OSX</h4>

<p>On OS X, you need to tell ejabberd to use OpenSSL for the build. The
best approach is to use homebrew to install openssl and to build
ejabberd with Homebrew installed OpenSSL.</p>

<p>Here is an example command to build ejabberd with brew-installed OpenSSL:</p>

<pre><code>#!console
LDFLAGS=-L/usr/local/opt/openssl/lib CFLAGS=-I/usr/local/opt/openssl/include ./configure --enable-all
LDFLAGS=-L/usr/local/opt/openssl/lib CFLAGS=-I/usr/local/opt/openssl/include make
</code></pre>

<p>Note: Reference to custom OpenSSL needs at the moment to be passed to
<code>make</code> command. This is because make command download, configure and
build dependencies. The reference is also needed in that context.</p>

<h4 id="specificnotesforbsd">Specific Notes for BSD</h4>

<p>The command to compile <code>ejabberd</code> in BSD systems is:</p>

<pre><code>#!console
gmake
</code></pre>

<h4 id="specificnotesforsunsolaris">Specific Notes for Sun Solaris</h4>

<!-- TODO: Is this still valid ? -->

<p>You need to have <code>GNU install</code>, but it isn't included in Solaris. It
can be easily installed if your Solaris system is set up for
<a href="http://www.blastwave.org/"><code>blastwave.org</code></a> package repository. Make sure <code>/opt/csw/bin</code> is
in your <code>PATH</code> and run:</p>

<pre><code>#!console
pkg-get -i fileutils
</code></pre>

<p>If that program is called <code>ginstall</code>, modify the <code>ejabberd</code> <code>Makefile</code>
script to suit your system, for example:</p>

<pre><code>#!console
cat Makefile | sed s/install/ginstall/ &gt; Makefile.gi
</code></pre>

<p>And finally install <code>ejabberd</code> with:</p>

<pre><code>#!console
gmake -f Makefile.gi ginstall
</code></pre>

<h2 id="post-installoperations">Post-install Operations</h2>

<h3 id="creatinganxmppaccountforadministration">Creating an XMPP Account for Administration</h3>

<p><code>ejabberd</code> binary installer prompt you for an admin account. However,
if you use another way of installing ejabberd you may need to create
an admin XMPP account.</p>

<p>You need an XMPP account and grant him administrative privileges to
enter the <code>ejabberd</code> Web Admin. Here are the steps to create it:</p>

<ol>
<li><p>Register an XMPP account on your <code>ejabberd</code> server, for example
<code>admin1@example.org</code>. There are two ways to register an XMPP
account:</p>

<ol>
<li><p>Using <code>ejabberdctl</code> (see section??<a href="#ejabberdctl">ejabberdctl</a>):</p>

<pre><code>#!console
ejabberdctl register admin1 example.org FgT5bk3
</code></pre></li>
<li><p>Using an XMPP client and In-Band Registration (see section??<a href="#mod_register">mod_register</a>).</p></li>
</ol></li>
<li><p>Edit the <code>ejabberd</code> configuration file to give administration
rights to the XMPP account you created:</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      - &quot;admin1&quot;: &quot;example.org&quot;
access:
  configure:
    admin: allow
</code></pre>

<p>You can grant administrative privileges to many XMPP accounts, and
also to accounts in other XMPP servers.</p></li>
<li><p>Restart <code>ejabberd</code> to load the new configuration.</p></li>
<li><p>Open the Web Admin (usually <code>http://localhost:5280/admin/</code>) in your favourite
browser. Make sure to enter the <em>full</em> JID as username (in this
example: <code>admin1@example.org</code>). The reason that you also need to
enter the suffix, is because <code>ejabberd</code>'s virtual hosting support.</p></li>
</ol>

<h3 id="upgradingejabberd">Upgrading ejabberd</h3>

<p>To upgrade an ejabberd installation to a new version, simply uninstall
the old version, and then install the new one. Of course, it is
important that the configuration file and Mnesia database spool
directory are not removed.</p>

<p><code>ejabberd</code> automatically updates the Mnesia table definitions at
startup when needed. If you also use an external database for storage
of some modules, check if the release notes of the new ejabberd
version indicates you need to also update those tables.</p>

<h1 id="configuringejabberd">Configuring ejabberd</h1>

<p>Here are the main entry points to learn more about ejabberd
configuration. ejabberd is extremely powerful and can be configured in
many ways with many options.</p>

<p>Do not let this complexity scare you. Most of you will be fine with
default config file (or light changes).</p>

<hr />

<h2 id="configfileformatting">Config File Formatting</h2>

<h3 id="yamlconfigurationfileformat">Yaml Configuration File Format</h3>

<p>The configuration file will be loaded the first time you start
<code>ejabberd</code>. The configuration file name MUST have &quot;.yml&quot; or &quot;.yaml&quot;
extension. This helps ejabberd to differentiate between the new and
legacy file formats (see
section??<a href="#legacyconfigurationfile">Legacy Configuration File</a>).</p>

<p>The configuration file is written in <a href="http://en.wikipedia.org/wiki/YAML"><code>YAML</code></a>. However, different
scalars are treated as different types:</p>

<ul>
<li><p>unquoted or single-quoted strings. The type is called <code>atom()</code> in
this document. Examples: <code>dog</code>, <code>'Jupiter'</code>, <code>'3.14159'</code>, <code>YELLOW</code>.</p></li>
<li><p>numeric literals. The type is called <code>integer()</code>, <code>float()</code> or, if
both are allowed, <code>number()</code>. Examples: <code>3</code>, <code>-45.0</code>, <code>.0</code></p></li>
<li><p>double-quoted or folded strings. The type is called <code>string()</code>.
Examples of a double-quoted string: <code>&quot;Lizzard&quot;</code>, <code>&quot;orange&quot;</code>,
<code>&quot;3.14159&quot;</code>. Examples of a folded string:</p>

<pre><code>&gt; Art thou not Romeo,
  and a Montague?

| Neither, fair saint,
  if either thee dislike.
</code></pre>

<p>For associative arrays (&quot;mappings&quot;) and lists you can use both
outline indentation and compact syntax (aka &quot;JSON style&quot;). For
example, the following is equivalent:</p>

<pre><code>{param1: [&quot;val1&quot;, &quot;val2&quot;], param2: [&quot;val3&quot;, &quot;val4&quot;]}
</code></pre>

<p>and</p>

<pre><code>param1:
  - &quot;val1&quot;
  - &quot;val2&quot;
param2:
  - &quot;val3&quot;
  - &quot;val4&quot;
</code></pre>

<p>Note that both styles are used in this document.</p></li>
</ul>

<p>Note that <code>ejabberd</code> never edits the configuration file. If you are
changing parameter from web admin interface, you will need to apply
them to configuration file manually. This is to prevent messing up
with your config file comments, syntax, etc.</p>

<p>Please, consult <code>ejabberd.log</code> for configuration errors. <code>ejabberd</code> will
report syntax related errors, as well as complains about unknown options.
The later error typically looks like this:</p>

<pre><code>17:10:52.858 [error] unknown option 'db_typ' for module 'mod_roster' will be likely ignored, available options are: 'access', 'db_type', 'iqdisc', 'managers', 'store_current_id', 'versioning'
</code></pre>

<p>Unknown options are not ignored at the moment in order to make legacy
third-party modules work. Make sure you respect indentation (YAML is
sensitive to this) or you will get pretty cryptic errors.</p>

<h3 id="legacyconfigurationfile">Legacy Configuration File</h3>

<p>In previous <code>ejabberd</code> version the configuration file should be
written in Erlang terms. The format is still supported, but it is
highly recommended to convert it to the new YAML format using
<code>convert_to_yaml</code> command from <code>ejabberdctl</code> (see??<a href="#ejabberdctl">ejabberdctl</a>
and <a href="#listofejabberdcommands">List of ejabberd Commands</a> for details).</p>

<p>If you want to specify some options using the old Erlang format, you
can set them in an additional cfg file, and include it using the
<code>include_config_file</code> option, see
<a href="#includeadditionalconfigurationfiles">Include Additional Configuration Files </a> for the option
description and a related example in
<a href="#restrictexecutionwithaccesscommands">Restrict Execution with AccessCommands</a>.</p>

<p>If you just want to provide an erlang term inside an option, you can
use the <code>&gt; erlangterm.</code> syntax for embedding erlang terms in a YAML
file, for example:</p>

<pre><code>#!yaml
modules:
  mod_cron:
    tasks:
      - time: 10
        units: seconds
        module: mnesia
        function: info
        arguments: &quot;&gt; [].&quot;
      - time: 3
        units: seconds
        module: ejabberd_auth
        function: try_register
        arguments: &quot;&gt; [\&quot;user1\&quot;, \&quot;localhost\&quot;, \&quot;pass\&quot;].&quot;
</code></pre>

<h2 id="configuringoneorseveralxmppdomains">Configuring One or Several XMPP Domains</h2>

<h3 id="hostnames">Host Names</h3>

<p><code>ejabberd</code> supports managing several independant XMPP domains on a
single ejabberd instance, using a feature called virtual hosting.</p>

<p>The option <code>hosts</code> defines a list containing one or more domains that
<code>ejabberd</code> will serve.</p>

<p>Of course, the <code>hosts</code> list can contain just one domain if you do not
want to host multiple XMPP domains on the same instance.</p>

<p>The syntax is: <code>[&quot;HostName1&quot;, &quot;Hostname2&quot;]</code></p>

<p>Examples:</p>

<ul>
<li><p>Serving one domain:</p>

<pre><code>#!yaml
hosts: [&quot;example.org&quot;]
</code></pre></li>
<li><p>Serving three domains:</p>

<pre><code>#!yaml
hosts:
  - &quot;example.net&quot;
  - &quot;example.com&quot;
  - &quot;jabber.somesite.org&quot;
</code></pre></li>
</ul>

<h3 id="virtualhosting">Virtual Hosting</h3>

<p>When managing several XMPP domains in a single instance, those domains
are truly independant. It means they can even have different
configuration parameters.</p>

<p>Options can be defined separately for every virtual host using the
<code>host_config</code> option.</p>

<p>The syntax is: <code>{HostName: [Option, ...]}</code></p>

<p>Examples:</p>

<ul>
<li><p>Domain <code>example.net</code> is using the internal authentication method
while domain <code>example.com</code> is using the LDAP server running on the
domain <code>localhost</code> to perform authentication:</p>

<pre><code>#!yaml
host_config:
  &quot;example.net&quot;
    auth_method: internal
  &quot;example.com&quot;:
    auth_method: ldap
    ldap_servers:
      - &quot;localhost&quot;
    ldap_uids:
      - &quot;uid&quot;
    ldap_rootdn: &quot;dc=localdomain&quot;
    ldap_rootdn: &quot;dc=example,dc=com&quot;
    ldap_password: &quot;&quot;
</code></pre></li>
<li><p>Domain <code>example.net</code> is using ODBC to perform authentication while
domain <code>example.com</code> is using the LDAP servers running on the
domains <code>localhost</code> and <code>otherhost</code>:</p>

<pre><code>#!yaml
host_config:
  &quot;example.net&quot;:
    auth_method: odbc
    odbc_type: odbc
    odbc_server: &quot;DSN=ejabberd;UID=ejabberd;PWD=ejabberd&quot;
  &quot;example.com&quot;:
    auth_method: ldap
    ldap_servers:
      - &quot;localhost&quot;
      - &quot;otherhost&quot;
    ldap_uids:
      - &quot;uid&quot;
    ldap_rootdn: &quot;dc=localdomain&quot;
    ldap_rootdn: &quot;dc=example,dc=com&quot;
    ldap_password: &quot;&quot;
</code></pre></li>
</ul>

<p>To define specific ejabberd modules in a virtual host, you can define
the global <code>modules</code> option with the common modules, and later add
specific modules to certain virtual hosts. To accomplish that, instead
of defining each option in <code>host_config</code> use <code>append_host_config</code> with
the same syntax.</p>

<p>In this example three virtual hosts have some similar modules, but there
are also other different modules for some specific virtual hosts:</p>

<pre><code>#!yaml
## This ejabberd server has three vhosts:
hosts:
  - &quot;one.example.org&quot;
  - &quot;two.example.org&quot;
  - &quot;three.example.org&quot;

## Configuration of modules that are common to all vhosts
modules:
  mod_roster:    {}
  mod_configure: {}
  mod_disco:     {}
  mod_private:   {}
  mod_time:      {}
  mod_last:      {}
  mod_version:   {}

## Add some modules to vhost one:
append_host_config:
  &quot;one.example.org&quot;:
    modules:
      mod_echo:
        host: &quot;echo-service.one.example.org&quot;
      mod_http_bind: {}
      mod_logxml: {}

## Add a module just to vhost two:
append_host_config:
  &quot;two.example.org&quot;:
    modules:
      mod_echo:
        host: &quot;mirror.two.example.org&quot;
</code></pre>

<h2 id="basicconfiguration">Basic Configuration</h2>

<h3 id="logging">Logging</h3>

<p><code>ejabberd</code> configuration can help a lot by having the right amount of logging set up.</p>

<p>Here is a few general option to configure logging:</p>

<dl>
<dt><code>loglevel: Number</code></dt>
<dd>Verbosity of log files generated by ejabberd. Available levels are.</dd>
</dl>

<ul>
<li>0: No ejabberd log at all (not recommended)</li>
<li>1: Critical</li>
<li>2: Error</li>
<li>3: Warning</li>
<li>4: Info</li>
<li>5: Debug</li>
</ul>

<dl>
<dt><code>log_rotate: size, date and count</code></dt>
<dd>The <em>rotation</em> parameters describe how to rotate logs. Either size and/or date can trigger
 log rotation. Setting count to N keeps N rotated logs. Setting count to 0
 does not disable rotation, it instead rotates the file and keeps no previous
 versions around. Setting size to X rotate log when it reaches X bytes.
 To disable rotation set the size to 0 and the date to &quot;&quot;
 Date syntax is taken from the syntax newsyslog uses in newsyslog.conf.</dd>
</dl>

<p>Here are some examples:</p>

<ul>
<li>$D0 rotate every night at midnight</li>
<li>$D23 rotate every day at 23:00 hr</li>
<li>$W0D23 rotate every week on Sunday at 23:00 hr</li>
<li>$W5D16 rotate every week on Friday at 16:00 hr</li>
<li>$M1D0 rotate on the first day of every month at midnight</li>
<li>$M5D6 rotate on every 5th day of the month at 6:00 hr</li>
</ul>

<p>The values in default configuration file are:</p>

<pre><code>log_rotate_size: 0
log_rotate_date: &quot;\$D0&quot;
log_rotate_count: 1
</code></pre>

<dl>
<dt><code>log_rate_limit: Number</code></dt>
<dd>This option is used for overload protection: If you want to limit
 the number of messages per second allowed from error_logger, which is
 a good idea if you want to avoid a flood of messages when system is
 overloaded, you can set a limit. Default value is 100.</dd>
</dl>

<p>For example:</p>

<pre><code>log_rate_limit: 100
</code></pre>

<dl>
<dt><code>hide_sensitive_log_data: Boolean</code></dt>
<dd>We have a privacy option to ensure we do not log IP address or
 sensitive data. Default value is false for backward compatibility.</dd>
</dl>

<p>For example:</p>

<pre><code>hide_sensitive_log_data: false
</code></pre>

<h3 id="listeningports">Listening Ports</h3>

<p>The option <code>listen</code> defines for which ports, addresses and network
protocols <code>ejabberd</code> will listen and what services will be run on them.
Each element of the list is an associative array with the following
elements:</p>

<ul>
<li><p>Port number. Optionally also the IP address and/or a transport
protocol.</p></li>
<li><p>Listening module that serves this port.</p></li>
<li><p>Options for the TCP socket and for the listening module.</p></li>
</ul>

<p>The option syntax is:</p>

<dl>
<dt><code>[Listener, ...]</code></dt>
<dd></dd>
</dl>

<p>Example:</p>

<pre><code>#!yaml
listen:
  -
    port: 5222
    module: ejabberd_c2s
    starttls: true
    certfile: &quot;/path/to/certfile.pem&quot;
  -
    port: 5269
    module: ejabberd_s2s_in
    transport: tcp
</code></pre>

<h4 id="portnumberipaddressandtransportprotocol">Port Number, IP Address and Transport Protocol</h4>

<p>The port number defines which port to listen for incoming connections.
It can be a Jabber/XMPP standard port (see section [firewall]) or any
other valid port number.</p>

<p>The IP address can be represented as a string. The socket will listen
only in that network interface. It is possible to specify a generic
address (&quot;0.0.0.0&quot; for IPv4 or &quot;::&quot; for IPv6), so <code>ejabberd</code> will listen
in all addresses. Depending on the type of the IP address, IPv4 or IPv6
will be used. When the IP address is not specified, it will listen on
all IPv4 network addresses.</p>

<p>Note that on some operating systems and/or OS configurations, listening
on &quot;::&quot; will mean listening for IPv4 traffic as well as IPv6 traffic.</p>

<p>Some example values for IP address:</p>

<ul>
<li><p><code>&quot;0.0.0.0&quot;</code> to listen in all IPv4 network interfaces. This is the
default value when no IP is specified.</p></li>
<li><p><code>&quot;::&quot;</code> to listen in all IPv6 network interfaces</p></li>
<li><p><code>&quot;10.11.12.13&quot;</code> is the IPv4 address <code>10.11.12.13</code></p></li>
<li><p><code>&quot;::FFFF:127.0.0.1&quot;</code> is the IPv6 address <code>::FFFF:127.0.0.1/128</code></p></li>
</ul>

<p>The transport protocol can be <code>tcp</code> or <code>udp</code>. Default is <code>tcp</code>.</p>

<h4 id="listeningmodule">Listening Module</h4>

<p>The available modules, their purpose and the options allowed by each one
are:</p>

<dl>
<dt><code>ejabberd_c2s</code></dt>
<dd>Handles c2s connections.<br/>
 Options: <code>access</code>, <code>certfile</code>, <code>ciphers</code>, <code>dhfile</code>, <code>protocol_options</code>
 <code>max_ack_queue</code>, <code>max_fsm_queue</code>, <code>max_stanza_size</code>,
 <code>resend_on_timeout</code>, <code>resume_timeout</code>, <code>shaper</code>, <code>starttls</code>,
 <code>starttls_required</code>, <code>stream_management</code>, <code>tls</code>, <code>zlib</code>,
 <code>tls_compression</code></dd>

<dt><code>ejabberd_s2s_in</code></dt>
<dd>Handles incoming s2s connections.<br/>
 Options: <code>max_stanza_size</code>, <code>shaper</code>, <code>tls_compression</code></dd>

<dt><code>ejabberd_service</code></dt>
<dd>Interacts with an
 <a href="http://www.ejabberd.im/tutorialstransports"><code>external component</code></a>
 (as defined in the Jabber Component Protocol
 (<a href="http://xmpp.org/extensions/xep0114.html"><code>XEP-0114</code></a>).<br/>
 Options: <code>access</code>, <code>hosts</code>, <code>max_fsm_queue</code>, <code>service_check_from</code>,
 <code>shaper_rule</code></dd>

<dt><code>ejabberd_sip</code></dt>
<dd>Handles SIP requests as defined in
 <a href="http://tools.ietf.org/html/rfc3261"><code>RFC 3261</code></a>.<br/>
 Options: <code>certfile</code>, <code>tls</code></dd>

<dt><code>ejabberd_stun</code></dt>
<dd>Handles STUN/TURN requests as defined in
 <a href="http://tools.ietf.org/html/rfc5389"><code>RFC 5389</code></a> and
 <a href="http://tools.ietf.org/html/rfc5766"><code>RFC 5766</code></a>.<br/>
 Options: <code>certfile</code>, <code>tls</code>, <code>use_turn</code>, <code>turn_ip</code>,
 <code>turn_port_range</code>, <code>turn_max_allocations</code>, <code>turn_max_permissions</code>,
 <code>shaper</code>, <code>server_name</code>, <code>auth_realm</code>, <code>auth_type</code></dd>

<dt><code>ejabberd_http</code></dt>
<dd>Handles incoming HTTP connections. This module is responsible for serving Web Admin, but also XMPP Bosh and Websocket with proper request handler configured.
 Options: <code>captcha</code>, <code>certfile</code>, <code>default_host</code>, <code>dhfile</code>, <code>http_bind</code>,
 <code>http_poll</code>, <code>request_handlers</code>, <code>tls</code>, <code>tls_compression</code>,
 <code>trusted_proxies</code>, <code>web_admin</code></dd>

<dt><code>ejabberd_xmlrpc</code></dt>
<dd>Handles XML-RPC requests to execute ejabberd commands
 ([eja-commands]).<br/>
 Options: <code>access_commands</code>, <code>maxsessions</code>, <code>timeout</code>.<br/>
 You can find option explanations, example configuration in old and
 new format, and example calls in several languages in the old
 <a href="http://www.ejabberd.im/ejabberd_xmlrpc"><code>ejabberd_xmlrpc documentation</code></a>.</dd>
</dl>

<h4 id="options">Options</h4>

<p>This is a detailed description of each option allowed by the listening
modules:</p>

<dl>
<dt><code>access: AccessName</code></dt>
<dd>This option defines access to the port. The default value is <code>all</code>.</dd>

<dt><code>backlog: Value</code></dt>
<dd>The backlog value defines the maximum length that the queue of
 pending connections may grow to. This should be increased if the
 server is going to handle lots of new incoming connections as they
 may be dropped if there is no space in the queue (and ejabberd was
 not able to accept them immediately). Default value is 5.</dd>

<dt><code>captcha: true|false</code></dt>
<dd>Simple web page that allows a user to fill a CAPTCHA challenge (see
 section <a href="#captcha">captcha</a>).</dd>

<dt><code>certfile: Path</code></dt>
<dd>Full path to a file containing the default SSL certificate. To
 define a certificate file specific for a given domain, use the
 global option <code>domain_certfile</code>.</dd>

<dt><code>ciphers: Ciphers</code></dt>
<dd>OpenSSL ciphers list in the same format accepted by
 '<code>openssl ciphers</code>' command.</dd>

<dt><code>protocol_options: ProtocolOpts</code></dt>
<dd>List of general options relating to SSL/TLS. These map to
 <a href="https://www.openssl.org/docs/ssl/SSL_CTX_set_options.html"><code>OpenSSL's set_options()</code></a>.
 For a full list of options available in ejabberd,
 <a href="https://github.com/processone/tls/blob/master/c_src/options.h"><code>see the source</code></a>.
 The default entry is: <code>&quot;no_sslv2&quot;</code></dd>

<dt><code>default_host: undefined|HostName}</code></dt>
<dd>If the HTTP request received by ejabberd contains the HTTP header
 <code>Host</code> with an ambiguous virtual host that doesn't match any one
 defined in ejabberd (see <a href="#hostnames">hostnames</a>), then this configured HostName
 is set as the request Host. The default value of this option is:
 <code>undefined</code>.</dd>

<dt><code>dhfile: Path</code></dt>
<dd>Full path to a file containing custom parameters for Diffie-Hellman key
 exchange. Such a file could be created with the command
 <code>openssl dhparam -out dh.pem 2048</code>. If this option is not specified,
 default parameters will be used, which might not provide the same level
 of security as using custom parameters.</dd>

<dt><code>hosts: {Hostname: [HostOption, ...]}</code></dt>
<dd>The external Jabber component that connects to this
 <code>ejabberd_service</code> can serve one or more hostnames. As <code>HostOption</code>
 you can define options for the component; currently the only allowed
 option is the password required to the component when attempt to
 connect to ejabberd: <span><code>password: Secret</code></span>. Note that you
 cannot define in a single <code>ejabberd_service</code> components of different
 services: add an <code>ejabberd_service</code> for each service, as seen in an
 example below.</dd>

<dt><code>http_bind: true|false</code></dt>
<dd>
<p>This option enables HTTP Binding
 (<a href="http://xmpp.org/extensions/xep0124.html"><code>XEP-0124</code></a> and
 <a href="http://xmpp.org/extensions/xep0206.html"><code>XEP-0206</code></a>) support.
 HTTP Bind enables access via HTTP requests to <code>ejabberd</code> from behind
 firewalls which do not allow outgoing sockets on port 5222.</p>

<p>Remember that you must also install and enable the module
mod_http_bind.</p>

<p>If HTTP Bind is enabled, it will be available at
<code>http://server:port/http-bind/</code>. Be aware that support for HTTP Bind
is also needed in the XMPP client. Remark also that HTTP Bind can be
interesting to host a web-based XMPP client such as
<a href="http://jwchat.sourceforge.net/"><code>JWChat</code></a> (check the tutorials to
install JWChat with ejabberd and an
<a href="http://www.ejabberd.im/jwchatlocalserver"><code>embedded local web server</code></a>
or <a href="http://www.ejabberd.im/jwchatapache"><code>Apache</code></a>).</p></dd>

<dt><code>http_poll: true|false</code></dt>
<dd>
<p>This option enables HTTP Polling
 (<a href="http://xmpp.org/extensions/xep0025.html"><code>XEP-0025</code></a>) support.
 HTTP Polling enables access via HTTP requests to <code>ejabberd</code> from
 behind firewalls which do not allow outgoing sockets on port 5222.</p>

<p>If HTTP Polling is enabled, it will be available at
<code>http://server:port/http-poll/</code>. Be aware that support for HTTP
Polling is also needed in the XMPP client. Remark also that HTTP
Polling can be interesting to host a web-based XMPP client such as
<a href="http://jwchat.sourceforge.net/"><code>JWChat</code></a>.</p>

<p>The maximum period of time to keep a client session active without
an incoming POST request can be configured with the global option
<code>http_poll_timeout</code>. The default value is five minutes. The option
can be defined in <code>ejabberd.yml</code>, expressing the time in seconds:
<code>{http_poll_timeout, 300}.</code></p></dd>

<dt><code>max_ack_queue: Size</code></dt>
<dd>This option specifies the maximum number of unacknowledged stanzas
 queued for possible retransmission if <code>stream_management</code> is
 enabled. When the limit is exceeded, the client session is
 terminated. This option can be specified for <code>ejabberd_c2s</code>
 listeners. The allowed values are positive integers and <code>infinity</code>.
 Default value: <code>1000</code>.</dd>

<dt><code>max_fsm_queue: Size</code></dt>
<dd>This option specifies the maximum number of elements in the queue of
 the FSM (Finite State Machine). Roughly speaking, each message in
 such queues represents one XML stanza queued to be sent into its
 relevant outgoing stream. If queue size reaches the limit (because,
 for example, the receiver of stanzas is too slow), the FSM and the
 corresponding connection (if any) will be terminated and error
 message will be logged. The reasonable value for this option depends
 on your hardware configuration. However, there is no much sense to
 set the size above 1000 elements. This option can be specified for
 <code>ejabberd_service</code> and <code>ejabberd_c2s</code> listeners, or also globally
 for <code>ejabberd_s2s_out</code>. If the option is not specified for
 <code>ejabberd_service</code> or <code>ejabberd_c2s</code> listeners, the globally
 configured value is used. The allowed values are integers and
 'undefined'. Default value: 'undefined'.</dd>

<dt><code>max_stanza_size: Size</code></dt>
<dd>This option specifies an approximate maximum size in bytes of XML
 stanzas. Approximate, because it is calculated with the precision of
 one block of read data. For example <code>{max_stanza_size, 65536}</code>. The
 default value is <code>infinity</code>. Recommended values are 65536 for c2s
 connections and 131072 for s2s connections. s2s max stanza size must
 always much higher than c2s limit. Change this value with extreme
 care as it can cause unwanted disconnect if set too low.</dd>

<dt><code>request_handlers: {Path: Module}</code></dt>
<dd>
<p>To define one or several handlers that will serve HTTP requests. The
 Path is a string; so the URIs that start with that Path will be
 served by Module. For example, if you want <code>mod_foo</code> to serve the
 URIs that start with <code>/a/b/</code>, and you also want <code>mod_http_bind</code> to
 serve the URIs <code>/http-bind/</code>, use this option:</p>

<pre><code>request_handlers:
  /&quot;a&quot;/&quot;b&quot;: mod_foo
  /&quot;http-bind&quot;: mod_http_bind
</code></pre></dd>

<dt><code>resend_on_timeout: true|false|if_offline</code></dt>
<dd>If <code>stream_management</code> is enabled and this option is set to <code>true</code>,
 any stanzas that weren't acknowledged by the client will be resent
 on session timeout. This behavior might often be desired, but could
 have unexpected results under certain circumstances. For example, a
 message that was sent to two resources might get resent to one of
 them if the other one timed out. Therefore, the default value for
 this option is <code>false</code>, which tells ejabberd to generate an error
 message instead. As an alternative, the option may be set to
 <code>if_offline</code>. In this case, unacknowledged stanzas are resent only
 if no other resource is online when the session times out.
 Otherwise, error messages are generated. The option can be specified
 for <code>ejabberd_c2s</code> listeners.</dd>

<dt><code>resume_timeout: Seconds</code></dt>
<dd>This option configures the number of seconds until a session times
 out if the connection is lost. During this period of time, a client
 may resume the session if <code>stream_management</code> is enabled. This
 option can be specified for <code>ejabberd_c2s</code> listeners. Setting it to
 <code>0</code> effectively disables session resumption. The default value is
 <code>300</code>.</dd>

<dt><code>service_check_from: true|false</code></dt>
<dd>This option can be used with <code>ejabberd_service</code> only.
 <a href="http://xmpp.org/extensions/xep0114.html"><code>XEP-0114</code></a> requires that
 the domain must match the hostname of the component. If this option
 is set to <code>false</code>, <code>ejabberd</code> will allow the component to send
 stanzas with any arbitrary domain in the 'from' attribute. Only use
 this option if you are completely sure about it. The default value
 is <code>true</code>, to be compliant with
 <a href="http://xmpp.org/extensions/xep0114.html"><code>XEP-0114</code></a>.</dd>

<dt><code>shaper: none|ShaperName</code></dt>
<dd>This option defines a shaper for the port (see section??<a href="#shapers">shapers</a>).
 The default value is <code>none</code>.</dd>

<dt><code>shaper_rule: none|ShaperRule</code></dt>
<dd>This option defines a shaper rule for the <code>ejabberd_service</code> (see
 section??<a href="#shapers">shapers</a>). The recommended value is <code>fast</code>.</dd>

<dt><code>starttls: true|false</code></dt>
<dd>This option specifies that STARTTLS encryption is available on
 connections to the port. You should also set the <code>certfile</code> option.
 You can define a certificate file for a specific domain using the
 global option <code>domain_certfile</code>.</dd>

<dt><code>starttls_required: true|false</code></dt>
<dd>This option specifies that STARTTLS encryption is required on
 connections to the port. No unencrypted connections will be allowed.
 You should also set the <code>certfile</code> option. You can define a
 certificate file for a specific domain using the global option
 <code>domain_certfile</code>.</dd>

<dt><code>stream_management: true|false</code></dt>
<dd>Setting this option to <code>false</code> disables ejabberd's support for
 Stream Management
 (<a href="http://xmpp.org/extensions/xep0198.html"><code>XEP-0198</code></a>). It can be
 specified for <code>ejabberd_c2s</code> listeners. The default value is <code>true</code>.</dd>

<dt><code>timeout: Integer</code></dt>
<dd>Timeout of the connections, expressed in milliseconds. Default: 5000</dd>

<dt><code>tls: true|false</code></dt>
<dd>This option specifies that traffic on the port will be encrypted
 using SSL immediately after connecting. This was the traditional
 encryption method in the early Jabber software, commonly on port
 5223 for client-to-server communications. But this method is
 nowadays deprecated and not recommended. The preferable encryption
 method is STARTTLS on port 5222, as defined
 <a href="http://xmpp.org/rfcs/rfc6120.html#tls"><code>RFC 6120: XMPP Core</code></a>,
 which can be enabled in <code>ejabberd</code> with the option <code>starttls</code>. If
 this option is set, you should also set the <code>certfile</code> option. The
 option <code>tls</code> can also be used in <code>ejabberd_http</code> to support HTTPS.</dd>

<dt><code>tls_compression: true|false</code></dt>
<dd>Whether to enable or disable TLS compression. The default value is
 <code>true</code>.</dd>

<dt><code>trusted_proxies: all | [IpString]</code></dt>
<dd>Specify what proxies are trusted when an HTTP request contains the
 header <code>X-Forwarded-For</code> You can specify <code>all</code> to allow all proxies,
 or specify a list of IPs in string format. The default value is:
 <code>[127.0.0.1]</code></dd>

<dt><code>web_admin: true|false</code></dt>
<dd>This option enables the Web Admin for <code>ejabberd</code> administration
 which is available at <code>http://server:port/admin/</code>. Login and
 password are the username and password of one of the registered
 users who are granted access by the 'configure' access rule.</dd>

<dt><code>zlib: true|false</code></dt>
<dd>This option specifies that Zlib stream compression (as defined in
 <a href="http://xmpp.org/extensions/xep0138.html"><code>XEP-0138</code></a>) is available
 on connections to the port.</dd>
</dl>

<p>There are some additional global options that can be specified in the
ejabberd configuration file (outside <code>listen</code>):</p>

<dl>
<dt><code>s2s_use_starttls: false|optional|required|required_trusted</code></dt>
<dd>This option defines if s2s connections don't use STARTTLS
 encryption; if STARTTLS can be used optionally; if STARTTLS is
 required to establish the connection; or if STARTTLS is required and
 the remote certificate must be valid and trusted. The default value
 is to not use STARTTLS: <code>false</code>.</dd>

<dt><code>s2s_certfile: Path</code></dt>
<dd>Full path to a file containing a SSL certificate.</dd>

<dt><code>s2s_dhfile: Path</code></dt>
<dd>Full path to a file containing custom DH parameters. Such a file could be
 created with the command <code>openssl dhparam -out dh.pem 2048</code>. If this
 option is not specified, default parameters will be used, which might
 not provide the same level of security as using custom parameters.</dd>

<dt><code>domain_certfile: Path</code></dt>
<dd>Full path to the file containing the SSL certificate for a specific
 domain.</dd>

<dt><code>s2s_ciphers: Ciphers</code></dt>
<dd>OpenSSL ciphers list in the same format accepted by
 '<code>openssl ciphers</code>' command.</dd>

<dt><code>s2s_protocol_options: ProtocolOpts</code></dt>
<dd>List of general options relating to SSL/TLS. These map to
 <a href="https://www.openssl.org/docs/ssl/SSL_CTX_set_options.html"><code>OpenSSL's set_options()</code></a>.
 For a full list of options available in ejabberd,
 <a href="https://github.com/processone/tls/blob/master/c_src/options.h"><code>see the source</code></a>.
 The default entry is: <code>&quot;no_sslv2&quot;</code></dd>

<dt><code>outgoing_s2s_families: [Family, ...]</code></dt>
<dd>Specify which address families to try, in what order. By default it
 first tries connecting with IPv4, if that fails it tries using IPv6.</dd>

<dt><code>outgoing_s2s_timeout: Timeout</code></dt>
<dd>The timeout in milliseconds for outgoing S2S connection attempts.</dd>

<dt><code>s2s_access: Access</code></dt>
<dd>The policy for incoming and outgoing s2s connections to other XMPP
 servers. The default value is <code>all</code>.</dd>

<dt><code>s2s_dns_timeout: Timeout</code></dt>
<dd>The timeout in seconds for DNS resolving. The default value is <code>10</code>.</dd>

<dt><code>s2s_dns_retries: Number</code></dt>
<dd>DNS resolving retries in seconds. The default value is <code>2</code>.</dd>

<dt><code>s2s_max_retry_delay: Seconds</code></dt>
<dd>The maximum allowed delay for retry to connect after a failed
 connection attempt. Specified in seconds. The default value is 300
 seconds (5 minutes).</dd>

<dt><code>s2s_tls_compression: true|false</code></dt>
<dd>Whether to enable or disable TLS compression for s2s connections.
 The default value is <code>true</code>.</dd>

<dt><code>max_fsm_queue: Size</code></dt>
<dd>This option specifies the maximum number of elements in the queue of
 the FSM (Finite State Machine). Roughly speaking, each message in
 such queues represents one XML stanza queued to be sent into its
 relevant outgoing stream. If queue size reaches the limit (because,
 for example, the receiver of stanzas is too slow), the FSM and the
 corresponding connection (if any) will be terminated and error
 message will be logged. The reasonable value for this option depends
 on your hardware configuration. However, there is no much sense to
 set the size above 1000 elements. This option can be specified for
 <code>ejabberd_service</code> and <code>ejabberd_c2s</code> listeners, or also globally
 for <code>ejabberd_s2s_out</code>. If the option is not specified for
 <code>ejabberd_service</code> or <code>ejabberd_c2s</code> listeners, the globally
 configured value is used. The allowed values are integers and
 'undefined'. Default value: 'undefined'.</dd>

<dt><code>route_subdomains: local|s2s</code></dt>
<dd>Defines if ejabberd must route stanzas directed to subdomains
 locally (compliant with
 <a href="http://xmpp.org/rfcs/rfc6120.html\#ruleslocal"><code>RFC 6120 Local Domain rules</code></a>),
 or to foreign server using S2S (compliant with
 <a href="http://xmpp.org/rfcs/rfc6120.html\#rulesremote"><code>RFC 6120 Remote Domain rules</code></a>).</dd>
</dl>

<h4 id="examples">Examples</h4>

<p>For example, the following simple configuration defines:</p>

<ul>
<li><p>There are three domains. The default certificate file is
<code>server.pem</code>. However, the c2s and s2s connections to the domain
<code>example.com</code> use the file <code>example_com.pem</code>.</p></li>
<li><p>Port 5222 listens for c2s connections with STARTTLS, and also allows
plain connections for old clients.</p></li>
<li><p>Port 5223 listens for c2s connections with the old SSL.</p></li>
<li><p>Port 5269 listens for s2s connections with STARTTLS. The socket is
set for IPv6 instead of IPv4.</p></li>
<li><p>Port 3478 listens for STUN requests over UDP.</p></li>
<li><p>Port 5280 listens for HTTP requests, and serves the HTTP Poll
service.</p></li>
<li><p>Port 5281 listens for HTTP requests, using HTTPS to serve HTTP-Bind
(BOSH) and the Web Admin as explained in <a href="../managing/#webadmin">Managing: Web Admin</a>. The
socket only listens connections to the IP address 127.0.0.1.</p></li>
</ul>

<!-- -->

<pre><code>#!yaml
hosts:
  - &quot;example.com&quot;
  - &quot;example.org&quot;
  - &quot;example.net&quot;

listen:
  - 
    port: 5222
    module: ejabberd_c2s
    access: c2s
    shaper: c2s_shaper
    starttls: true
    certfile: &quot;/etc/ejabberd/server.pem&quot;
    max_stanza_size: 65536
  - 
    port: 5223
    module: ejabberd_c2s
    access: c2s
    shaper: c2s_shaper
    tls: true
    certfile: &quot;/etc/ejabberd/server.pem&quot;
    max_stanza_size: 65536
  - 
    port: 5269
    ip: &quot;::&quot;
    module: ejabberd_s2s_in
    shaper: s2s_shaper
    max_stanza_size: 131072
  - 
    port: 3478
    transport: udp
    module: ejabberd_stun
  - 
    port: 5280
    module: ejabberd_http
    http_poll: true
  - 
    port: 5281
    ip: &quot;127.0.0.1&quot;
    module: ejabberd_http
    web_admin: true
    http_bind: true
    tls: true
    certfile: &quot;/etc/ejabberd/server.pem&quot;

s2s_use_starttls: optional
s2s_certfile: &quot;/etc/ejabberd/server.pem&quot;
host_config:
  &quot;example.com&quot;:
    domain_certfile: &quot;/etc/ejabberd/example_com.pem&quot;
outgoing_s2s_families:
  - ipv4
  - ipv6
outgoing_s2s_timeout: 10000
</code></pre>

<p>In this example, the following configuration defines that:</p>

<ul>
<li><p>c2s connections are listened for on port 5222 (all IPv4 addresses)
and on port 5223 (SSL, IP 192.168.0.1 and fdca:8ab6:a243:75ef::1)
and denied for the user called '<code>bad</code>'.</p></li>
<li><p>s2s connections are listened for on port 5269 (all IPv4 addresses)
with STARTTLS for secured traffic strictly required, and the
certificates are verified. Incoming and outgoing connections of
remote XMPP servers are denied, only two servers can connect:
&quot;jabber.example.org&quot; and &quot;example.com&quot;.</p></li>
<li><p>Port 5280 is serving the Web Admin and the HTTP Polling service in
all the IPv4 addresses. Note that it is also possible to serve them
on different ports. The second example in section??<a href="#webadmin">webadmin</a> shows
how exactly this can be done.</p></li>
<li><p>All users except for the administrators have a traffic of limit
1,000Bytes/second</p></li>
<li><p>The <a href="http://www.ejabberd.im/pyaimt"><code>AIM transport</code></a>
<code>aim.example.org</code> is connected to port 5233 on localhost IP
addresses (127.0.0.1 and ::1) with password '<code>aimsecret</code>'.</p></li>
<li><p>The ICQ transport JIT (<code>icq.example.org</code> and <code>sms.example.org</code>) is
connected to port 5234 with password '<code>jitsecret</code>'.</p></li>
<li><p>The <a href="http://www.ejabberd.im/pymsnt"><code>MSN transport</code></a>
<code>msn.example.org</code> is connected to port 5235 with password
'<code>msnsecret</code>'.</p></li>
<li><p>The <a href="http://www.ejabberd.im/yahoo-transport-2"><code>Yahoo! transport</code></a>
<code>yahoo.example.org</code> is connected to port 5236 with password
'<code>yahoosecret</code>'.</p></li>
<li><p>The
<a href="http://www.ejabberd.im/jabber-gg-transport"><code>Gadu-Gadu transport</code></a>
<code>gg.example.org</code> is connected to port 5237 with password
'<code>ggsecret</code>'.</p></li>
<li><p>The <a href="http://www.ejabberd.im/jmc"><code>Jabber Mail Component</code></a>
<code>jmc.example.org</code> is connected to port 5238 with password
'<code>jmcsecret</code>'.</p></li>
<li><p>The service custom has enabled the special option to avoiding
checking the <code>from</code> attribute in the packets send by this component.
The component can send packets in behalf of any users from the
server, or even on behalf of any server.</p></li>
</ul>

<!-- -->

<pre><code>#!yaml
acl: 
  blocked: 
    user: &quot;bad&quot;
  trusted_servers: 
    server:
      - &quot;example.com&quot;
      - &quot;jabber.example.org&quot;
  xmlrpc_bot: 
    user: 
      - &quot;xmlrpc-robot&quot;: &quot;example.org&quot;
shaper: 
  normal: 1000
access: 
  c2s: 
    blocked: deny
    all: allow
  c2s_shaper: 
    admin: none
    all: normal
  xmlrpc_access: 
    xmlrpc_bot: allow
  s2s:
    trusted_servers: allow
    all: deny
s2s_certfile: &quot;/path/to/ssl.pem&quot;
s2s_access: s2s
s2s_use_starttls: required_trusted
listen: 
  - 
    port: 5222
    module: ejabberd_c2s
    shaper: c2s_shaper
    access: c2s
  - 
    ip: &quot;192.168.0.1&quot;
    port: 5223
    module: ejabberd_c2s
    certfile: &quot;/path/to/ssl.pem&quot;
    tls: true
    access: c2s
  - 
    ip: &quot;FDCA:8AB6:A243:75EF::1&quot;
    port: 5223
    module: ejabberd_c2s
    certfile: &quot;/path/to/ssl.pem&quot;
    tls: true
    access: c2s
  - 
    port: 5269
    module: ejabberd_s2s_in
  - 
    port: 5280
    module: ejabberd_http
    web_admin: true
    http_poll: true
  - 
    port: 4560
    module: ejabberd_xmlrpc
  - 
    ip: &quot;127.0.0.1&quot;
    port: 5233
    module: ejabberd_service
    hosts: 
      &quot;aim.example.org&quot;: 
        password: &quot;aimsecret&quot;
  - 
    ip: &quot;::1&quot;
    port: 5233
    module: ejabberd_service
    hosts: 
      &quot;aim.example.org&quot;: 
        password: &quot;aimsecret&quot;
  - 
    port: 5234
    module: ejabberd_service
    hosts: 
      &quot;icq.example.org&quot;: 
        password: &quot;jitsecret&quot;
      &quot;sms.example.org&quot;: 
        password: &quot;jitsecret&quot;
  - 
    port: 5235
    module: ejabberd_service
    hosts: 
      &quot;msn.example.org&quot;: 
        password: &quot;msnsecret&quot;
  - 
    port: 5236
    module: ejabberd_service
    hosts: 
      &quot;yahoo.example.org&quot;: 
        password: &quot;yahoosecret&quot;
  - 
    port: 5237
    module: ejabberd_service
    hosts: 
      &quot;gg.example.org&quot;: 
        password: &quot;ggsecret&quot;
  - 
    port: 5238
    module: ejabberd_service
    hosts: 
      &quot;jmc.example.org&quot;: 
        password: &quot;jmcsecret&quot;
  - 
    port: 5239
    module: ejabberd_service
    service_check_from: false
    hosts: 
      &quot;custom.example.org&quot;: 
        password: &quot;customsecret&quot;
</code></pre>

<p>Note, that for services based in jabberd14 or WPJabber you have to make
the transports log and do XDB by themselves:</p>

<pre><code>#!xml
&lt;!--
   You have to add elogger and rlogger entries here when using ejabberd.
   In this case the transport will do the logging.
--&gt;

&lt;log id='logger'&gt;
  &lt;host/&gt;
  &lt;logtype/&gt;
  &lt;format&gt;%d: [%t] (%h): %s&lt;/format&gt;
  &lt;file&gt;/var/log/jabber/service.log&lt;/file&gt;
&lt;/log&gt;

&lt;!--
   Some XMPP server implementations do not provide
   XDB services (for example, jabberd2 and ejabberd).
   xdb_file.so is loaded in to handle all XDB requests.
--&gt;

&lt;xdb id=&quot;xdb&quot;&gt;
  &lt;host/&gt;
  &lt;load&gt;
    &lt;!-- this is a lib of wpjabber or jabberd14 --&gt;
    &lt;xdb_file&gt;/usr/lib/jabber/xdb_file.so&lt;/xdb_file&gt;
    &lt;/load&gt;
  &lt;xdb_file xmlns=&quot;jabber:config:xdb_file&quot;&gt;
    &lt;spool&gt;&lt;jabberd:cmdline flag='s'&gt;/var/spool/jabber&lt;/jabberd:cmdline&gt;&lt;/spool&gt;
  &lt;/xdb_file&gt;
&lt;/xdb&gt;
</code></pre>

<h3 id="authentication">Authentication</h3>

<p>The option <code>auth_method</code> defines the authentication methods that are
used for user authentication. The syntax is:</p>

<dl>
<dt><code>[Method, ...]</code></dt>
<dd></dd>
</dl>

<p>The following authentication methods are supported by <code>ejabberd</code>:</p>

<ul>
<li><p>internal - See section??<a href="#internal">Internal</a>.</p></li>
<li><p>external - See section??<a href="#externalscript">External Script</a>.</p></li>
<li><p>ldap - See section?? <a href="#ldap">LDAP</a>.</p></li>
<li><p>odbc - See section <a href="#relationaldatabases">Relational Databases</a>.</p></li>
<li><p>anonymous - See section??<a href="#anonymousloginandsaslanonymous">Anonymous Login and SASL Anonymous</a>.</p></li>
<li><p>pam - See section??<a href="#pamauthentication">Pam Authentication</a>.</p></li>
</ul>

<p>When the option is omitted, ejabberd will rely upon the default database which is configured in <code>default_db</code> option. If this option is not set neither the default authentication method will be <code>internal</code>.</p>

<p>Account creation is only supported by internal, external and odbc methods.</p>

<p>The option <code>resource_conflict</code> defines the action when a client attempts
to login to an account with a resource that is already connected. The
option syntax is:</p>

<dl>
<dt><code>resource_conflict: setresource|closenew|closeold</code></dt>
<dd></dd>
</dl>

<p>The possible values match exactly the three possibilities described in
<a href="http://tools.ietf.org/html/rfc6120#section-7.7.2.2"><code>XMPP Core: section 7.7.2.2</code></a>.
The default value is <code>closeold</code>. If the client uses old Jabber Non-SASL
authentication (<a href="http://xmpp.org/extensions/xep-0078.html"><code>XEP-0078</code></a>),
then this option is not respected, and the action performed is
<code>closeold</code>.</p>

<p>The option <code>fqdn</code> allows you to define the Fully Qualified Domain Name
of the machine, in case it isn't detected automatically. The FQDN is
used to authenticate some clients that use the DIGEST-MD5 SASL
mechanism. The option syntax is:</p>

<dl>
<dt><code>fqdn: undefined|FqdnString|[FqdnString]</code></dt>
<dd></dd>
</dl>

<p>The option <code>disable_sasl_mechanisms</code> specifies a list of SASL mechanisms
that should <em>not</em> be offered to the client. The mechanisms can be listed
as lowercase or uppercase strings. The option syntax is:</p>

<dl>
<dt><code>disable_sasl_mechanisms: [Mechanism, ...]</code></dt>
<dd></dd>
</dl>

<h4 id="internal">Internal</h4>

<p><code>ejabberd</code> uses its internal Mnesia database as the default
authentication method. The value <code>internal</code> will enable the internal
authentication method.</p>

<p>The option <code>auth_password_format: plain|scram</code> defines in what format
the users passwords are stored:</p>

<dl>
<dt><code>plain</code></dt>
<dd>The password is stored as plain text in the database. This is risky
 because the passwords can be read if your database gets compromised.
 This is the default value. This format allows clients to
 authenticate using: the old Jabber Non-SASL
 (<a href="http://xmpp.org/extensions/xep0078.html"><code>XEP-0078</code></a>),
 <code>SASL PLAIN</code>, <code>SASL DIGEST-MD5</code>, and <code>SASL SCRAM-SHA-1</code>.</dd>

<dt><code>scram</code></dt>
<dd>The password is not stored, only some information that allows to
 verify the hash provided by the client. It is impossible to obtain
 the original plain password from the stored information; for this
 reason, when this value is configured it cannot be changed to
 <code>plain</code> anymore. This format allows clients to authenticate using:
 <code>SASL PLAIN</code> and <code>SASL SCRAM-SHA-1</code>.</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>To use internal authentication on <code>example.org</code> and LDAP
authentication on <code>example.net</code>:</p>

<pre><code>#!yaml
host_config:
  &quot;example.org&quot;:
    auth_method: [internal]
  &quot;example.net&quot;:
    auth_method: [ldap]
</code></pre></li>
<li><p>To use internal authentication with hashed passwords on all virtual
hosts:</p>

<pre><code>#!yaml
auth_method: internal
auth_password_format: scram
</code></pre></li>
</ul>

<h4 id="externalscript">External Script</h4>

<p>In this authentication method, when <code>ejabberd</code> starts, it start a
script, and calls it to perform authentication tasks.</p>

<p>The server administrator can write the external authentication script in
any language. The details on the interface between ejabberd and the
script are described in the <code>ejabberd Developers Guide</code>. There are also
<a href="http://www.ejabberd.im/extauth"><code>several example authentication scripts</code></a>.</p>

<p>These are the specific options:</p>

<dl>
<dt><code>extauth_program: PathToScript</code></dt>
<dd>Indicate in this option the full path to the external authentication
 script. The script must be executable by ejabberd.</dd>

<dt><code>extauth_instances: Integer</code></dt>
<dd>Indicate how many instances of the script to run simultaneously to
 serve authentication in the virtual host. The default value is the
 minimum number: 1.</dd>

<dt><code>extauth_cache: false|CacheTimeInteger</code></dt>
<dd>The value <code>false</code> disables the caching feature, this is the default.
 The integer <code>0</code> (zero) enables caching for statistics, but doesn't
 use that cached information to authenticate users. If another
 integer value is set, caching is enabled both for statistics and for
 authentication: the CacheTimeInteger indicates the number of seconds
 that ejabberd can reuse the authentication information since the
 user last disconnected, to verify again the user authentication
 without querying again the extauth script. Note: caching should not
 be enabled in a host if internal auth is also enabled. If caching is
 enabled, <code>mod_last</code> must be enabled also in that vhost.</dd>
</dl>

<p>This example sets external authentication, the extauth script, enables
caching for 10 minutes, and starts three instances of the script for
each virtual host defined in ejabberd:</p>

<pre><code>#!yaml
auth_method: [external]
extauth_program: &quot;/etc/ejabberd/JabberAuth.class.php&quot;
extauth_cache: 600
extauth_instances: 3
</code></pre>

<h4 id="anonymousloginandsaslanonymous">Anonymous Login and SASL Anonymous</h4>

<p>The <code>anonymous</code> authentication method enables two modes for anonymous
authentication:</p>

<dl>
<dt><code>Anonymous login:</code></dt>
<dd>This is a standard login, that use the classical login and password
 mechanisms, but where password is accepted or preconfigured for all
 anonymous users. This login is compliant with SASL authentication,
 password and digest non-SASL authentication, so this option will
 work with almost all XMPP clients</dd>

<dt><code>SASL Anonymous:</code></dt>
<dd>This is a special SASL authentication mechanism that allows to login
 without providing username or password (see
 <a href="http://xmpp.org/extensions/xep0175.html"><code>XEP-0175</code></a>). The main
 advantage of SASL Anonymous is that the protocol was designed to
 give the user a login. This is useful to avoid in some case, where
 the server has many users already logged or registered and when it
 is hard to find a free username. The main disavantage is that you
 need a client that specifically supports the SASL Anonymous
 protocol.</dd>
</dl>

<p>The anonymous authentication method can be configured with the following
options. Remember that you can use the <code>host_config</code> option to set
virtual host specific options (see section??[virtualhost]).</p>

<dl>
<dt><code>allow_multiple_connections: false|true</code></dt>
<dd>This option is only used when the anonymous mode is enabled. Setting
 it to <code>true</code> means that the same username can be taken multiple
 times in anonymous login mode if different resource are used to
 connect. This option is only useful in very special occasions. The
 default value is <code>false</code>.</dd>

<dt><code>anonymous_protocol: login_anon | sasl_anon | both</code></dt>
<dd><code>login_anon</code> means that the anonymous login method will be used.
 <code>sasl_anon</code> means that the SASL Anonymous method will be used.
 <code>both</code> means that SASL Anonymous and login anonymous are both
 enabled.</dd>
</dl>

<p>Those options are defined for each virtual host with the <code>host_config</code>
parameter (see section??[virtualhost]).</p>

<p>Examples:</p>

<ul>
<li><p>To enable anonymous login on all virtual hosts:</p>

<pre><code>#!yaml
auth_method: [anonymous]
anonymous_protocol: login_anon
</code></pre></li>
<li><p>Similar as previous example, but limited to <code>public.example.org</code>:</p>

<pre><code>#!yaml
host_config:
  &quot;public.example.org&quot;:
    auth_method: [anonymous]
    anonymous_protoco: login_anon
</code></pre></li>
<li><p>To enable anonymous login and internal authentication on a virtual
host:</p>

<pre><code>#!yaml
host_config:
  &quot;public.example.org&quot;:
    auth_method:
      - internal
      - anonymous
    anonymous_protocol: login_anon
</code></pre></li>
<li><p>To enable SASL Anonymous on a virtual host:</p>

<pre><code>#!yaml
host_config:
  &quot;public.example.org&quot;:
    auth_method: [anonymous]
    anonymous_protocol: sasl_anon
</code></pre></li>
<li><p>To enable SASL Anonymous and anonymous login on a virtual host:</p>

<pre><code>#!yaml
host_config:
  &quot;public.example.org&quot;:
    auth_method: [anonymous]
    anonymous_protocol: both
</code></pre></li>
<li><p>To enable SASL Anonymous, anonymous login, and internal
authentication on a virtual host:</p>

<pre><code>#!yaml
host_config:
  &quot;public.example.org&quot;:
    auth_method:
      - internal
      - anonymous
    anonymous_protocol: both
</code></pre></li>
</ul>

<p>There are more configuration examples and XMPP client example stanzas in
<a href="http://www.ejabberd.im/Anonymous-users-support"><code>Anonymous users support</code></a>.</p>

<h4 id="pamauthentication">PAM Authentication</h4>

<p><code>ejabberd</code> supports authentication via Pluggable Authentication Modules
(PAM). PAM is currently supported in AIX, FreeBSD, HP-UX, Linux, Mac OS
X, NetBSD and Solaris. PAM authentication is disabled by default, so you
have to configure and compile <code>ejabberd</code> with PAM support enabled:</p>

<pre><code>#!console
./configure --enable-pam &amp;&amp; make install
</code></pre>

<p>Options:</p>

<dl>
<dt><code>pam_service: Name</code></dt>
<dd>This option defines the PAM service name. Default is <code>ejabberd</code>.
 Refer to the PAM documentation of your operation system for more
 information.</dd>

<dt><code>pam_userinfotype: username|jid</code></dt>
<dd>This option defines what type of information about the user ejabberd
 provides to the PAM service: only the username, or the user JID.
 Default is <code>username</code>.</dd>
</dl>

<p>Example:</p>

<pre><code>#!yaml
auth_method: [pam]
pam_service: &quot;ejabberd&quot;
</code></pre>

<p>Though it is quite easy to set up PAM support in <code>ejabberd</code>, PAM itself
introduces some security issues:</p>

<ul>
<li><p>To perform PAM authentication <code>ejabberd</code> uses external C-program
called <code>epam</code>. By default, it is located in
<code>/var/lib/ejabberd/priv/bin/</code> directory. You have to set it root on
execution in the case when your PAM module requires root privileges
(<code>pam_unix.so</code> for example). Also you have to grant access for
<code>ejabberd</code> to this file and remove all other permissions from it.
Execute with root privileges:</p>

<pre><code>#!console
chown root:ejabberd /var/lib/ejabberd/priv/bin/epam
chmod 4750 /var/lib/ejabberd/priv/bin/epam
</code></pre></li>
<li><p>Make sure you have the latest version of PAM installed on your
system. Some old versions of PAM modules cause memory leaks. If you
are not able to use the latest version, you can <code>kill(1)</code> <code>epam</code>
process periodically to reduce its memory consumption: <code>ejabberd</code>
will restart this process immediately.</p></li>
<li><p><code>epam</code> program tries to turn off delays on authentication failures.
However, some PAM modules ignore this behavior and rely on their own
configuration options. You can create a configuration file
<code>ejabberd.pam</code>. This example shows how to turn off delays in
<code>pam_unix.so</code> module:</p>

<pre><code>#%PAM-1.0
auth        sufficient  pam_unix.so likeauth nullok nodelay
account     sufficient  pam_unix.so
</code></pre>

<p>That is not a ready to use configuration file: you must use it as a
hint when building your own PAM configuration instead. Note that if
you want to disable delays on authentication failures in the PAM
configuration file, you have to restrict access to this file, so a
malicious user can't use your configuration to perform brute-force
attacks.</p></li>
<li><p>You may want to allow login access only for certain users.
<code>pam_listfile.so</code> module provides such functionality.</p></li>
<li><p>If you use <code>pam_winbind</code> to authorise against a Windows Active
Directory, then <code>/etc/nsswitch.conf</code> must be configured to use
<code>winbind</code> as well.</p></li>
</ul>

<h3 id="accessrules">Access Rules</h3>

<h4 id="acldefinition">ACL Definition</h4>

<p>Access control in <code>ejabberd</code> is performed via Access Control Lists
(ACLs). The declarations of ACLs in the configuration file have the
following syntax:</p>

<dl>
<dt><code>acl: { ACLName: { ACLType: ACLValue } }</code></dt>
<dd></dd>
</dl>

<p><code>ACLType: ACLValue</code> can be one of the following:</p>

<dl>
<dt><code>all</code></dt>
<dd>
<p>Matches all JIDs. Example:</p>

<pre><code>#!yaml
acl:
  world: all
</code></pre></dd>

<dt><code>user: Username</code></dt>
<dd>
<p>Matches the user with the name <code>Username</code> at the first virtual host.
 Example:</p>

<pre><code>#!yaml
acl:
  admin:
    user: &quot;yozhik&quot;
</code></pre></dd>

<dt><code>user: {Username: Server}</code></dt>
<dd>
<p>Matches the user with the JID <code>Username@Server</code> and any resource.
 Example:</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      &quot;yozhik&quot;: &quot;example.org&quot;
</code></pre></dd>

<dt><code>server: Server</code></dt>
<dd>
<p>Matches any JID from server <code>Server</code>. Example:</p>

<pre><code>#!yaml
acl:
  exampleorg:
    server: &quot;example.org&quot;
</code></pre></dd>

<dt><code>resource: Resource</code></dt>
<dd>
<p>Matches any JID with a resource <code>Resource</code>. Example:</p>

<pre><code>#!yaml
acl:
  mucklres:
   resource: &quot;muckl&quot;
</code></pre></dd>

<dt><code>shared_group: Groupname</code></dt>
<dd>
<p>Matches any member of a Shared Roster Group with name <code>Groupname</code> in
 the virtual host. Example:</p>

<pre><code>#!yaml
acl:
  techgroupmembers:
    shared_group: &quot;techteam&quot;
</code></pre></dd>

<dt><code>shared_group: {Groupname: Server}</code></dt>
<dd>
<p>Matches any member of a Shared Roster Group with name <code>Groupname</code> in
 the virtual host <code>Server</code>. Example:</p>

<pre><code>#!yaml
acl:
  techgroupmembers:
    shared_group:
      &quot;techteam&quot;: &quot;example.org&quot;
</code></pre></dd>

<dt><code>ip: Network</code></dt>
<dd>
<p>Matches any IP address from the <code>Network</code>. Example:</p>

<pre><code>#!yaml
acl:
  loopback:
    ip:
      - &quot;127.0.0.0/8&quot;
      - &quot;::1&quot;
</code></pre></dd>

<dt><code>user_regexp: Regexp</code></dt>
<dd>
<p>Matches any local user with a name that matches <code>Regexp</code> on local
 virtual hosts. Example:</p>

<pre><code>#!yaml
acl:
  tests:
    user_regexp: &quot;^test[0-9]*$&quot;
</code></pre></dd>

<dt><code>user_regexp: {Regexp: Server}</code></dt>
<dd>
<p>Matches any user with a name that matches <code>Regexp</code> at server
 <code>Server</code>. Example:</p>

<pre><code>#!yaml
acl:
  tests:
    user_regexp:
      &quot;^test&quot;: &quot;example.org&quot;
</code></pre></dd>

<dt><code>server_regexp: Regexp</code></dt>
<dd>
<p>Matches any JID from the server that matches <code>Regexp</code>. Example:</p>

<pre><code>#!yaml
acl:
  icq:
    server_regexp: &quot;^icq\\.&quot;
</code></pre></dd>

<dt><code>resource_regexp: Regexp</code></dt>
<dd>
<p>Matches any JID with a resource that matches <code>Regexp</code>. Example:</p>

<pre><code>#!yaml
acl:
  icq:
    resource_regexp: &quot;^laptop\\.&quot;
</code></pre></dd>

<dt><code>node_regexp: {UserRegexp: ServerRegexp}</code></dt>
<dd>
<p>Matches any user with a name that matches <code>UserRegexp</code> at any server
 that matches <code>ServerRegexp</code>. Example:</p>

<pre><code>#!yaml
acl:
  yozhik:
    node_regexp:
      &quot;^yozhik$&quot;: &quot;^example.(com|org)$&quot;
</code></pre></dd>

<dt><code>user_glob: Glob}</code></dt>
<dd></dd>

<dt><code>user_glob: {Glob: Server}</code></dt>
<dd></dd>

<dt><code>server_glob: Glob</code></dt>
<dd></dd>

<dt><code>resource_glob: Glob</code></dt>
<dd></dd>

<dt><code>node_glob: {UserGlob: ServerGlob}</code></dt>
<dd>
<p>This is the same as above. However, it uses shell glob patterns
 instead of regexp. These patterns can have the following special
 characters:</p>

<dl>
<dt><code>*</code></dt>
<dd>matches any string including the null string.</dd>

<dt><code>?</code></dt>
<dd>matches any single character.</dd>

<dt><code>[...]</code></dt>
<dd>matches any of the enclosed characters. Character ranges are
 specified by a pair of characters separated by a <code>-</code>. If the
 first character after <code>[</code> is a <code>!</code>, any character not enclosed
 is matched.</dd>
</dl></dd>
</dl>

<p>The following <code>ACLName</code> are pre-defined:</p>

<dl>
<dt><code>all</code></dt>
<dd>Matches any JID.</dd>

<dt><code>none</code></dt>
<dd>Matches no JID.</dd>
</dl>

<h4 id="accessrights">Access Rights</h4>

<p>An entry allowing or denying access to different services. The syntax
is:</p>

<dl>
<dt><code>access: { AccessName: { ACLName: allow|deny } }</code></dt>
<dd></dd>
</dl>

<p>When a JID is checked to have access to <code>Accessname</code>, the server
sequentially checks if that JID matches any of the ACLs that are named
in the first elements of the tuples in the list. If it matches, the
second element of the first matched tuple is returned, otherwise the
value '<code>deny</code>' is returned.</p>

<p>If you define specific Access rights in a virtual host, remember that
the globally defined Access rights have precedence over those. This
means that, in case of conflict, the Access granted or denied in the
global server is used and the Access of a virtual host doesn't have
effect.</p>

<p>Example:</p>

<pre><code>#!yaml
access:
  configure:
    admin: allow
  something
    badmans: deny
    all: allow
</code></pre>

<p>The following <code>AccessName</code> are pre-defined:</p>

<dl>
<dt><code>all</code></dt>
<dd>Always returns the value '<code>allow</code>'.</dd>

<dt><code>none</code></dt>
<dd>Always returns the value '<code>deny</code>'.</dd>
</dl>

<h4 id="limitingopenedsessionswithacl">Limiting Opened Sessions with ACL</h4>

<p>The special access <code>max_user_sessions</code> specifies the maximum number of
sessions (authenticated connections) per user. If a user tries to open
more sessions by using different resources, the first opened session
will be disconnected. The error <code>session replaced</code> will be sent to the
disconnected session. The value for this option can be either a number,
or <code>infinity</code>. The default value is <code>infinity</code>.</p>

<p>The syntax is:</p>

<dl>
<dt><code>{ max_user_sessions: { ACLName: MaxNumber } }</code></dt>
<dd></dd>
</dl>

<p>This example limits the number of sessions per user to 5 for all users,
and to 10 for admins:</p>

<pre><code>#!yaml
access:
  max_user_sessions:
    admin: 10
    all: 5
</code></pre>

<h4 id="severalconnectionstoaremotexmppserverwithacl">Several connections to a remote XMPP server with ACL</h4>

<p>The special access <code>max_s2s_connections</code> specifies how many simultaneous
S2S connections can be established to a specific remote XMPP server. The
default value is <code>1</code>. There's also available the access
<code>max_s2s_connections_per_node</code>.</p>

<p>The syntax is:</p>

<dl>
<dt><code>{ max_s2s_connections: { ACLName: MaxNumber } }</code></dt>
<dd></dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>Allow up to 3 connections with each remote server:</p>

<pre><code>#!yaml
access:
  max_s2s_connections:
    all: 3
</code></pre></li>
</ul>

<h3 id="shapers">Shapers</h3>

<p>Shapers enable you to limit connection traffic. The syntax is:</p>

<dl>
<dt><code>shaper: { ShaperName: Rate }</code></dt>
<dd></dd>
</dl>

<p>where <code>Rate</code> stands for the maximum allowed incoming rate in bytes per
second. When a connection exceeds this limit, <code>ejabberd</code> stops reading
from the socket until the average rate is again below the allowed
maximum.</p>

<p>Examples:</p>

<ul>
<li><p>To define a shaper named '<code>normal</code>' with traffic speed limited to
1,000bytes/second:</p>

<pre><code>#!yaml
shaper:
  normal: 1000
</code></pre></li>
<li><p>To define a shaper named '<code>fast</code>' with traffic speed limited to
50,000bytes/second:</p>

<pre><code>#!yaml
shaper:
  fast: 50000
</code></pre></li>
</ul>

<h3 id="defaultlanguage">Default Language</h3>

<p>The option <code>language</code> defines the default language of server strings
that can be seen by XMPP clients. If a XMPP client does not support
<code>xml:lang</code>, the specified language is used.</p>

<p>The option syntax is:</p>

<dl>
<dt><code>language: Language</code></dt>
<dd></dd>
</dl>

<p>The default value is <code>en</code>. In order to take effect there must be a
translation file <code>Language.msg</code> in <code>ejabberd</code>'s <code>msgs</code> directory.</p>

<p>For example, to set Russian as default language:</p>

<pre><code>#!yaml
language: &quot;ru&quot;
</code></pre>

<p>Appendix [i18ni10n] provides more details about internationalization and
localization.</p>

<h3 id="captcha">CAPTCHA</h3>

<p>Some <code>ejabberd</code> modules can be configured to require a CAPTCHA challenge
on certain actions. If the client does not support CAPTCHA Forms
(<a href="http://xmpp.org/extensions/xep-0158.html"><code>XEP-0158</code></a>), a web link is
provided so the user can fill the challenge in a web browser.</p>

<p>An example script is provided that generates the image using
ImageMagick's Convert program.</p>

<p>Note: we do not provide example scripts to support image generation on
Microsoft Windows. Captcha will not work with ejabberd Windows
installer.</p>

<p>The configurable options are:</p>

<dl>
<dt><code>captcha_cmd: Path</code></dt>
<dd>Full path to a script that generates the image. The default value
 disables the feature: <code>undefined</code></dd>

<dt><code>captcha_host: ProtocolHostPort</code></dt>
<dd>ProtocolHostPort is a string with the host, and optionally the
 Protocol and Port number. It must identify where ejabberd listens
 for CAPTCHA requests. The URL sent to the user is formed by:
 <code>Protocol://Host:Port/captcha/</code> The default value is: protocol
 <code>http</code>, the first hostname configured, and port <code>80</code>. If you specify
 a port number that does not match exactly an ejabberd listener
 (because you are using a reverse proxy or other port-forwarding
 tool), then you must specify the transfer protocol, as seen in the
 example below.</dd>
</dl>

<p>Additionally, an <code>ejabberd_http</code> listener must be enabled with the
<code>captcha</code> option. See section <a href="#listeningmodule">Listening Module</a>.</p>

<p>Example configuration:</p>

<pre><code>#!yaml
hosts: [&quot;example.org&quot;]

captcha_cmd: &quot;/lib/ejabberd/priv/bin/captcha.sh&quot;
captcha_host: &quot;example.org:5280&quot;
## captcha_host: &quot;https://example.org:443&quot;
## captcha_host: &quot;http://example.com&quot;

listen:
  ...
  -
    port: 5280
    module: ejabberd_http
    captcha: true
  ...
</code></pre>

<h3 id="nodesettings">Node settings</h3>

<dl>
<dt><code>net_ticktime: 60</code></dt>
<dd>This option can be used to tune tick time parameter of
 net_kernel. It tells <code>erlang</code> VM how often nodes should check if
 intra-node communication was not interruped. This option must have
 identical value on all nodes, or it will lead to subtle bugs. Usually
 leaving default value of this is option is best, tweak it only if you
 know what are you doing.</dd>
</dl>

<h3 id="stunandturn">STUN and TURN</h3>

<p><code>ejabberd</code> is able to act as a stand-alone STUN/TURN server
(<a href="http://tools.ietf.org/html/rfc5389"><code>RFC 5389</code></a>/<a href="http://tools.ietf.org/html/rfc5766"><code>RFC 5766</code></a>).
In that role <code>ejabberd</code> helps clients with ICE
(<a href="http://tools.ietf.org/html/rfc5245"><code>RFC 5245</code></a>) or Jingle ICE
(<a href="http://xmpp.org/extensions/xep-0176.html"><code>XEP-0176</code></a>) support to
discover their external addresses and ports and to relay media traffic
when it is impossible to establish direct peer-to-peer connection.</p>

<p>You should configure <code>ejabberd_stun</code> listening module as described in
[listened] section. The specific configurable options are:</p>

<dl>
<dt><code>tls: true|false</code></dt>
<dd>If enabled, <code>certfile</code> option must be set, otherwise <code>ejabberd</code> will
 not be able to accept TLS connections. Obviously, this option makes
 sense for <code>tcp</code> transport only. The default is <code>false</code>.</dd>

<dt><code>certfile: Path</code></dt>
<dd>Path to the certificate file. Only makes sense when <code>tls</code> is set.</dd>

<dt><code>use_turn: true|false</code></dt>
<dd>Enables/disables TURN (media relay) functionality. The default is
 <code>false</code>.</dd>

<dt><code>turn_ip: String</code></dt>
<dd>The IPv4 address advertised by your TURN server. The address should
 not be NAT'ed or firewalled. There is not default, so you should set
 this option explicitly. Implies <code>use_turn</code>.</dd>

<dt><code>turn_min_port: Integer</code></dt>
<dd>Together with <code>turn_max_port</code> forms port range to allocate from. The
 default is 49152. Implies <code>use_turn</code>.</dd>

<dt><code>turn_max_port: Integer</code></dt>
<dd>Together with <code>turn_min_port</code> forms port range to allocate from. The
 default is 65535. Implies <code>use_turn</code>.</dd>

<dt><code>turn_max_allocations: Integer|infinity</code></dt>
<dd>Maximum number of TURN allocations available from the particular IP
 address. The default value is 10. Implies <code>use_turn</code>.</dd>

<dt><code>turn_max_permissions: Integer|infinity</code></dt>
<dd>Maximum number of TURN permissions available from the particular IP
 address. The default value is 10. Implies <code>use_turn</code>.</dd>

<dt><code>auth_type: user|anonymous</code></dt>
<dd>Which authentication type to use for TURN allocation requests. When
 type <code>user</code> is set, ejabberd authentication backend is used. For
 <code>anonymous</code> type no authentication is performed (not recommended for
 public services). The default is <code>user</code>. Implies <code>use_turn</code>.</dd>

<dt><code>auth_realm: String</code></dt>
<dd>When <code>auth_type</code> is set to <code>user</code> and you have several virtual hosts
 configured you should set this option explicitly to the virtual host
 you want to serve on this particular listening port. Implies
 <code>use_turn</code>.</dd>

<dt><code>shaper: Atom</code></dt>
<dd>For <code>tcp</code> transports defines shaper to use. The default is <code>none</code>.</dd>

<dt><code>server_name: String</code></dt>
<dd>Defines software version to return with every response. The default
 is the STUN library version.</dd>
</dl>

<p>Example configuration with disabled TURN functionality (STUN only):</p>

<pre><code>#!yaml
listen:
  ...
  - 
    port: 3478
    transport: udp
    module: ejabberd_stun
  - 
    port: 3478
    module: ejabberd_stun
  -
    port: 5349
    module: ejabberd_stun
    certfile: &quot;/etc/ejabberd/server.pem&quot;
  ...
</code></pre>

<p>Example configuration with TURN functionality. Note that STUN is always
enabled if TURN is enabled. Here, only UDP section is shown:</p>

<pre><code>#!yaml
listen:
  ...
  - 
    port: 3478
    transport: udp
    use_turn: true
    turn_ip: &quot;10.20.30.1&quot;
    module: ejabberd_stun
  ...
</code></pre>

<p>You also need to configure DNS SRV records properly so clients can
easily discover a STUN/TURN server serving your XMPP domain. Refer to
section
<a href="http://tools.ietf.org/html/rfc5389#section-9"><code>DNS Discovery of a Server</code></a>
of <a href="http://tools.ietf.org/html/rfc5389"><code>RFC 5389</code></a> and section
<a href="http://tools.ietf.org/html/rfc5766#section-6"><code>Creating an Allocation</code></a>
of <a href="http://tools.ietf.org/html/rfc5766"><code>RFC 5766</code></a> for details.</p>

<p>Example DNS SRV configuration for STUN only:</p>

<pre><code>_stun._udp   IN SRV  0 0 3478 stun.example.com.
_stun._tcp   IN SRV  0 0 3478 stun.example.com.
_stuns._tcp  IN SRV  0 0 5349 stun.example.com.
</code></pre>

<p>And you should also add these in the case if TURN is enabled:</p>

<pre><code>_turn._udp   IN SRV  0 0 3478 turn.example.com.
_turn._tcp   IN SRV  0 0 3478 turn.example.com.
_turns._tcp  IN SRV  0 0 5349 turn.example.com.
</code></pre>

<h3 id="sip">SIP</h3>

<p><code>ejabberd</code> has built-in SIP support. In order to activate it you need to
add listeners for it, configure DNS properly and enable <code>mod_sip</code> for
the desired virtual host.</p>

<p>To add a listener you should configure <code>ejabberd_sip</code> listening module
as described in [listened] section. If option <code>tls</code> is specified, option
<code>certfile</code> must be specified as well, otherwise incoming TLS connections
would fail.</p>

<p>Example configuration with standard ports (as per
<a href="http://tools.ietf.org/html/rfc3261"><code>RFC 3261</code></a>):</p>

<pre><code>#!yaml
listen:
  ...
  - 
    port: 5060
    transport: udp
    module: ejabberd_sip
  - 
    port: 5060
    module: ejabberd_sip
  -
    port: 5061
    module: ejabberd_sip
    tls: true
    certfile: &quot;/etc/ejabberd/server.pem&quot;
  ...
</code></pre>

<p>Note that there is no StartTLS support in SIP and
<a href="http://en.wikipedia.org/wiki/Server_Name_Indication"><code>SNI</code></a> support is
somewhat tricky, so for TLS you have to configure different virtual
hosts on different ports if you have different certificate files for
them.</p>

<p>Next you need to configure DNS SIP records for your virtual domains.
Refer to <a href="http://tools.ietf.org/html/rfc3263"><code>RFC 3263</code></a> for the
detailed explanation. Simply put, you should add NAPTR and SRV records
for your domains. Skip NAPTR configuration if your DNS provider doesn't
support this type of records. It's not fatal, however, highly
recommended.</p>

<p>Example configuration of NAPTR records:</p>

<pre><code>example.com IN NAPTR 10  0 &quot;s&quot; &quot;SIPS+D2T&quot; &quot;&quot; _sips._tcp.example.com.
example.com IN NAPTR 20  0 &quot;s&quot; &quot;SIP+D2T&quot; &quot;&quot; _sip._tcp.example.com.
example.com IN NAPTR 30  0 &quot;s&quot; &quot;SIP+D2U&quot; &quot;&quot; _sip._udp.example.com.
</code></pre>

<p>Example configuration of SRV records with standard ports (as per
<a href="http://tools.ietf.org/html/rfc3261"><code>RFC 3261</code></a>):</p>

<pre><code>_sip._udp   IN SRV  0 0 5060 sip.example.com.
_sip._tcp   IN SRV  0 0 5060 sip.example.com.
_sips._tcp  IN SRV  0 0 5061 sip.example.com.
</code></pre>

<h3 id="includeadditionalconfigurationfiles">Include Additional Configuration Files</h3>

<p>The option <code>include_config_file</code> in a configuration file instructs
<code>ejabberd</code> to include other configuration files immediately.</p>

<p>The basic syntax is:</p>

<dl>
<dt><code>include_config_file: [Filename]</code></dt>
<dd></dd>
</dl>

<p>It is possible to specify suboptions using the full syntax:</p>

<dl>
<dt><code>include_config_file: { Filename: [Suboption, ...] }</code></dt>
<dd></dd>
</dl>

<p>The filename can be indicated either as an absolute path, or relative to
the main <code>ejabberd</code> configuration file. It isn't possible to use
wildcards. The file must exist and be readable.</p>

<p>The allowed suboptions are:</p>

<dl>
<dt><code>disallow: [Optionname, ...]</code></dt>
<dd>Disallows the usage of those options in the included configuration
 file. The options that match this criteria are not accepted. The
 default value is an empty list: <code>[]</code></dd>

<dt><code>allow_only: [Optionname, ...]</code></dt>
<dd>Allows only the usage of those options in the included configuration
 file. The options that do not match this criteria are not accepted.
 The default value is: <code>all</code></dd>
</dl>

<p>This is a basic example:</p>

<pre><code>include_config_file: &quot;/etc/ejabberd/additional.yml&quot;
</code></pre>

<p>In this example, the included file is not allowed to contain a <code>listen</code>
option. If such an option is present, the option will not be accepted.
The file is in a subdirectory from where the main configuration file is.</p>

<pre><code>include_config_file:
  &quot;./example.org/additional_not_listen.yml&quot;:
    disallow: [listen]
</code></pre>

<p>In this example, <code>ejabberd.yml</code> defines some ACL and Access rules, and
later includes another file with additional rules:</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      - &quot;admin&quot;: &quot;localhost&quot;
access:
  announce:
    admin: allow
include_config_file:
  &quot;/etc/ejabberd/acl_and_access.yml&quot;:
    allow_only:
      - acl
      - access
</code></pre>

<p>and content of the file <code>acl_and_access.yml</code> can be, for example:</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      - &quot;bob&quot;: &quot;localhost&quot;
      - &quot;jan&quot;: &quot;localhost&quot;
</code></pre>

<h3 id="optionmacrosinconfigurationfile">Option Macros in Configuration File</h3>

<p>In the <code>ejabberd</code> configuration file, it is possible to define a macro
for a value and later use this macro when defining an option.</p>

<p>A macro is defined with this syntax:</p>

<dl>
<dt><code>define_macro: { 'MACRO': Value }</code></dt>
<dd></dd>
</dl>

<p>The <code>MACRO</code> must be surrounded by single quotation marks, and all
letters in uppercase; check the examples bellow. The <code>value</code> can be any
valid arbitrary Erlang term.</p>

<p>The first definition of a macro is preserved, and additional definitions
of the same macro are forgotten.</p>

<p>Macros are processed after additional configuration files have been
included, so it is possible to use macros that are defined in
configuration files included before the usage.</p>

<p>It isn't possible to use a macro in the definition of another macro.</p>

<p>This example shows the basic usage of a macro:</p>

<pre><code>#!yaml
define_macro:
  'LOG_LEVEL_NUMBER': 5
loglevel: 'LOG_LEVEL_NUMBER'
</code></pre>

<p>The resulting option interpreted by <code>ejabberd</code> is: <code>loglevel: 5</code>.</p>

<p>This example shows that values can be any arbitrary Erlang term:</p>

<pre><code>#!yaml
define_macro:
  'USERBOB':
    user:
      - &quot;bob&quot;: &quot;localhost&quot;
acl:
  admin: 'USERBOB'
</code></pre>

<p>The resulting option interpreted by <code>ejabberd</code> is:</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      - &quot;bob&quot;: &quot;localhost&quot;
</code></pre>

<p>This complex example:</p>

<pre><code>#!yaml
define_macro:
  'NUMBER_PORT_C2S': 5222
  'NUMBER_PORT_HTTP': 5280
listen:
  - 
    port: 'NUMBER_PORT_C2S'
    module: ejabberd_c2s
  - 
    port: 'NUMBER_PORT_HTTP'
    module: ejabberd_http
</code></pre>

<p>produces this result after being interpreted:</p>

<pre><code>#!yaml
listen:
  - 
    port: 5222
    module: ejabberd_c2s
  - 
    port: 5280
    module: ejabberd_http
</code></pre>

<h2 id="databaseandldapconfiguration">Database and LDAP Configuration</h2>

<p><code>ejabberd</code> uses its internal Mnesia database by default. However, it is
possible to use a relational database, key-value storage or an LDAP
server to store persistent, long-living data. <code>ejabberd</code> is very
flexible: you can configure different authentication methods for
different virtual hosts, you can configure different authentication
mechanisms for the same virtual host (fallback), you can set different
storage systems for modules, and so forth.</p>

<p>The following databases are supported by <code>ejabberd</code>:</p>

<ul>
<li><p><a href="http://www.erlang.org/doc/apps/mnesia/index.html"><code>Mnesia</code></a></p></li>
<li><p><a href="http://www.mysql.com/"><code>MySQL</code></a></p></li>
<li><p><a href="http://en.wikipedia.org/wiki/Open_Database_Connectivity"><code>Any ODBC compatible database</code></a></p></li>
<li><p><a href="http://www.postgresql.org/"><code>PostgreSQL</code></a></p></li>
<li><p><a href="http://basho.com/riak/"><code>Riak</code></a></p></li>
<li><p><a href="http://redis.io/"><code>Redis</code></a> (only for transient data)</p></li>
</ul>

<p>The following LDAP servers are tested with <code>ejabberd</code>:</p>

<ul>
<li><p><a href="http://www.microsoft.com/activedirectory/"><code>Active Directory</code></a> (see
section??[ad])</p></li>
<li><p><a href="http://www.openldap.org/"><code>OpenLDAP</code></a></p></li>
<li><p><a href="http://www.communigate.com/"><code>CommuniGate Pro</code></a></p></li>
<li><p>Normally any LDAP compatible server should work; inform us about
your success with a not-listed server so that we can list it here.</p></li>
</ul>

<p>Important note about virtual hosting: if you define several domains in
ejabberd.yml (see section <a href="#hostnames">hostnames</a>), you probably want that each
virtual host uses a different configuration of database, authentication
and storage, so that usernames do not conflict and mix between different
virtual hosts. For that purpose, the options described in the next
sections must be set inside a <code>host_config</code> for each vhost (see section
[virtualhost]). For example:</p>

<pre><code>#!yaml
host_config:
  &quot;public.example.org&quot;:
    odbc_type: pgsql
    odbc_server: &quot;localhost&quot;
    odbc_database: &quot;database-public-example-org&quot;
    odbc_username: &quot;ejabberd&quot;
    odbc_password: &quot;password&quot;
    auth_method: [odbc]
</code></pre>

<h3 id="relationaldatabases">Relational Databases</h3>

<p>The actual database access is defined in the options with <code>odbc_</code>
prefix. The values are used to define if we want to use ODBC, or one of
the two native interface available, PostgreSQL or MySQL.</p>

<p>The following paramaters are available:</p>

<dl>
<dt><code>odbc_type: mysql | pgsql | odbc</code></dt>
<dd>The type of an ODBC connection. The default is <code>odbc</code>.</dd>

<dt><code>odbc_server: String</code></dt>
<dd>A hostname of the ODBC server. The default is <code>localhost</code>.</dd>

<dt><code>odbc_port: Port</code></dt>
<dd>The port where the ODBC server is accepting connections. The option
 is only valid for <code>mysql</code> and <code>pgsql</code>. The default is <code>3306</code> and
 <code>5432</code> respectively.</dd>

<dt><code>odbc_database: String</code></dt>
<dd>The database name. The default is <code>ejabberd</code>. The option is only
 valid for <code>mysql</code> and <code>pgsql</code>.</dd>

<dt><code>odbc_username: String</code></dt>
<dd>The username. The default is <code>ejabberd</code>. The option is only valid
 for <code>mysql</code> and <code>pgsql</code>.</dd>

<dt><code>odbc_password: String</code></dt>
<dd>The password. The default is empty string. The option is only valid
 for <code>mysql</code> and <code>pgsql</code>.</dd>

<dt><code>odbc_pool_size: N</code></dt>
<dd>By default <code>ejabberd</code> opens 10 connections to the database for each
 virtual host. You can change this number by using this option.</dd>

<dt><code>odbc_keepalive_interval: N</code></dt>
<dd>You can configure an interval to make a dummy SQL request to keep
 alive the connections to the database. The default value is
 'undefined', so no keepalive requests are made. Specify in seconds:
 for example 28800 means 8 hours.</dd>

<dt><code>odbc_start_interval: N</code></dt>
<dd>If the connection to the database fails, <code>ejabberd</code> waits 30 seconds
 before retrying. You can modify this interval with this option.</dd>
</dl>

<p>Example of plain ODBC connection:</p>

<pre><code>#!yaml
odbc_server: &quot;DSN=database;UID=ejabberd;PWD=password&quot;
</code></pre>

<p>Example of MySQL connection:</p>

<pre><code>#!yaml
odbc_type: mysql
odbc_server: &quot;server.company.com&quot;
odbc_port: 3306 # the default
odbc_database: &quot;mydb&quot;
odbc_username: &quot;user1&quot;
odbc_password: &quot;**********&quot;
odbc_pool_size: 5
</code></pre>

<h4 id="storage">Storage</h4>

<p>An ODBC compatible database also can be used to store information into
from several <code>ejabberd</code> modules. See section??[modoverview] to see which
modules can be used with relational databases like MySQL. To enable
storage to your database, just make sure that your database is running
well (see previous sections), and add the module option <code>db_type: odbc</code>
or set <code>default_db: odbc</code> globally if you want to use ODBC for all modules.</p>

<h3 id="ldap">LDAP</h3>

<p><code>ejabberd</code> has built-in LDAP support. You can authenticate users against
LDAP server and use LDAP directory as vCard storage.</p>

<p>Usually <code>ejabberd</code> treats LDAP as a read-only storage: it is possible to
consult data, but not possible to create accounts or edit vCard that is
stored in LDAP. However, it is possible to change passwords if
<code>mod_register</code> module is enabled and LDAP server supports
<a href="http://tools.ietf.org/html/rfc3062"><code>RFC 3062</code></a>.</p>

<h4 id="connection">Connection</h4>

<p>Two connections are established to the LDAP server per vhost, one for
authentication and other for regular calls.</p>

<p>Parameters:</p>

<dl>
<dt><code>ldap_servers: [Servers, ...]</code></dt>
<dd>List of IP addresses or DNS names of your LDAP servers. This option
 is required.</dd>

<dt><code>ldap_encrypt: none|tls</code></dt>
<dd>Type of connection encryption to the LDAP server. Allowed values
 are: <code>none</code>, <code>tls</code>. The value <code>tls</code> enables encryption by using LDAP
 over SSL. Note that STARTTLS encryption is not supported. The
 default value is: <code>none</code>.</dd>

<dt><code>ldap_tls_verify: false|soft|hard</code></dt>
<dd>This option specifies whether to verify LDAP server certificate or
 not when TLS is enabled. When <code>hard</code> is enabled <code>ejabberd</code> doesn't
 proceed if a certificate is invalid. When <code>soft</code> is enabled
 <code>ejabberd</code> proceeds even if check fails. The default is <code>false</code>
 which means no checks are performed.</dd>

<dt><code>ldap_tls_cacertfile: Path</code></dt>
<dd>Path to file containing PEM encoded CA certificates. This option is
 needed (and required) when TLS verification is enabled.</dd>

<dt><code>ldap_tls_depth: Number</code></dt>
<dd>Specifies the maximum verification depth when TLS verification is
 enabled, i.e. how far in a chain of certificates the verification
 process can proceed before the verification is considered to fail.
 Peer certificate = 0, CA certificate = 1, higher level CA
 certificate = 2, etc. The value 2 thus means that a chain can at
 most contain peer cert, CA cert, next CA cert, and an additional CA
 cert. The default value is 1.</dd>

<dt><code>ldap_port: Number</code></dt>
<dd>Port to connect to your LDAP server. The default port is??389 if
 encryption is disabled; and 636 if encryption is enabled. If you
 configure a value, it is stored in <code>ejabberd</code>'s database. Then, if
 you remove that value from the configuration file, the value
 previously stored in the database will be used instead of the
 default port.</dd>

<dt><code>ldap_rootdn: RootDN</code></dt>
<dd>Bind DN. The default value is??`` which means 'anonymous connection'.</dd>

<dt><code>ldap_password: Password</code></dt>
<dd>Bind password. The default value is ``.</dd>

<dt><code>ldap_deref_aliases: never|always|finding|searching</code></dt>
<dd>Whether or not to dereference aliases. The default is <code>never</code>.</dd>
</dl>

<p>Example:</p>

<pre><code>#!yaml
auth_method: [ldap]
ldap_servers:
  - &quot;ldap1.example.org&quot;
ldap_port: 389
ldap_rootdn: &quot;cn=Manager,dc=domain,dc=org&quot;
ldap_password: &quot;**********&quot;
</code></pre>

<h4 id="authentication">Authentication</h4>

<p>You can authenticate users against an LDAP directory. Note that current
LDAP implementation does not support SASL authentication.</p>

<p>Available options are:</p>

<dl>
<dt><code>ldap_base: Base</code></dt>
<dd>LDAP base directory which stores users accounts. This option is
 required.</dd>

<dt><code>ldap_uids: [ ldap_uidattr | {ldap_uidattr: ldap_uidattr_format} ]</code></dt>
<dd>
<p>LDAP attribute which holds a list of attributes to use as
 alternatives for getting the JID. The default attributes are
 <code>[{uid, %u}]</code>. The attributes are of the form: <code>[{ldap_uidattr}]</code> or
 <code>[{ldap_uidattr, ldap_uidattr_format}]</code>. You can use as many comma
 separated attributes as needed. The values for <code>ldap_uidattr</code> and
 <code>ldap_uidattr_format</code> are described as follow:</p>

<dl>
<dt><code>ldap_uidattr</code></dt>
<dd>LDAP attribute which holds the user's part of a JID. The default
 value is <code>uid</code>.</dd>

<dt><code>ldap_uidattr_format</code></dt>
<dd>Format of the <code>ldap_uidattr</code> variable. The format <em>must</em> contain
 one and only one pattern variable <code>%u</code> which will be replaced by
 the user's part of a JID. For example, <code>%u@example.org</code>. The
 default value is <code>%u</code>.</dd>
</dl></dd>

<dt><code>ldap_filter: Filter</code></dt>
<dd><a href="http://tools.ietf.org/html/rfc4515"><code>RFC 4515</code></a> LDAP filter. The
 default Filter value is: <code>undefined</code>. Example:
 <code>(&amp;(objectClass=shadowAccount)(memberOf=Jabber Users))</code>. Please, do
 not forget to close brackets and do not use superfluous whitespaces.
 Also you <em>must not</em> use <code>ldap_uidattr</code> attribute in filter because
 this attribute will be substituted in LDAP filter automatically.</dd>

<dt><code>ldap_dn_filter: { Filter: FilterAttrs }</code></dt>
<dd>
<p>This filter is applied on the results returned by the main filter.
 This filter performs additional LDAP lookup to make the complete
 result. This is useful when you are unable to define all filter
 rules in <code>ldap_filter</code>. You can define <code>%u</code>, <code>%d</code>, <code>%s</code> and <code>%D</code>
 pattern variables in Filter: <code>%u</code> is replaced by a user's part of a
 JID, <code>%d</code> is replaced by the corresponding domain (virtual host),
 all <code>%s</code> variables are consecutively replaced by values of
 FilterAttrs attributes and <code>%D</code> is replaced by Distinguished Name.
 By default <code>ldap_dn_filter</code> is undefined. Example:</p>

<pre><code>#!yaml
ldap_dn_filter:
  &quot;(&amp;(name=%s)(owner=%D)(user=%u@%d))&quot;: [&quot;sn&quot;]
</code></pre>

<p>Since this filter makes additional LDAP lookups, use it only in the
last resort: try to define all filter rules in <code>ldap_filter</code> if
possible.</p></dd>

<dt><code>{ldap_local_filter, Filter}</code></dt>
<dd>
<p>If you can't use <code>ldap_filter</code> due to performance reasons (the LDAP
 server has many users registered), you can use this local filter.
 The local filter checks an attribute in ejabberd, not in LDAP, so
 this limits the load on the LDAP directory. The default filter is:
 <code>undefined</code>. Example values:</p>

<pre><code>{ldap_local_filter, {notequal, {&quot;accountStatus&quot;,[&quot;disabled&quot;]}}}.
{ldap_local_filter, {equal, {&quot;accountStatus&quot;,[&quot;enabled&quot;]}}}.
{ldap_local_filter, undefined}.
</code></pre></dd>
</dl>

<h4 id="examples">Examples</h4>

<h5 id="commonexample">Common example</h5>

<p>Let's say <code>ldap.example.org</code> is the name of our LDAP server. We have
users with their passwords in <code>ou=Users,dc=example,dc=org</code> directory.
Also we have addressbook, which contains users emails and their
additional infos in <code>ou=AddressBook,dc=example,dc=org</code> directory. The
connection to the LDAP server is encrypted using TLS, and using the
custom port 6123. Corresponding authentication section should looks like
this:</p>

<pre><code>#!yaml
## Authentication method
auth_method: [ldap]
## DNS name of our LDAP server
ldap_servers: [&quot;ldap.example.org&quot;]
## Bind to LDAP server as &quot;cn=Manager,dc=example,dc=org&quot; with password &quot;secret&quot;
ldap_rootdn: &quot;cn=Manager,dc=example,dc=org&quot;
ldap_password: &quot;secret&quot;
ldap_encrypt: tls
ldap_port: 6123
## Define the user's base
ldap_base: &quot;ou=Users,dc=example,dc=org&quot;
## We want to authorize users from 'shadowAccount' object class only
ldap_filter: &quot;(objectClass=shadowAccount)&quot;
</code></pre>

<p>Now we want to use users LDAP-info as their vCards. We have four
attributes defined in our LDAP schema: <code>mail</code> - email address,
<code>givenName</code> - first name, <code>sn</code> - second name, <code>birthDay</code> - birthday.
Also we want users to search each other. Let's see how we can set it up:</p>

<pre><code>#!yaml
modules:
  ...
  mod_vcard_ldap:
    ## We use the same server and port, but want to bind anonymously because
    ## our LDAP server accepts anonymous requests to
    ## &quot;ou=AddressBook,dc=example,dc=org&quot; subtree.
    ldap_rootdn: &quot;&quot;
    ldap_password: &quot;&quot;
    ## define the addressbook's base
    ldap_base: &quot;ou=AddressBook,dc=example,dc=org&quot;
    ## uidattr: user's part of JID is located in the &quot;mail&quot; attribute
    ## uidattr_format: common format for our emails
    ldap_uids:
      &quot;mail&quot;: &quot;%u@mail.example.org&quot;
    ## We have to define empty filter here, because entries in addressbook does not
    ## belong to shadowAccount object class
    ldap_filter: &quot;&quot;
    ## Now we want to define vCard pattern
    ldap_vcard_map:
     &quot;NICKNAME&quot;: {&quot;%u&quot;: []} # just use user's part of JID as his nickname
     &quot;GIVEN&quot;: {&quot;%s&quot;: [&quot;givenName&quot;]}
     &quot;FAMILY&quot;: {&quot;%s&quot;: [&quot;sn&quot;]}
     &quot;FN&quot;: {&quot;%s, %s&quot;: [&quot;sn&quot;, &quot;givenName&quot;]}, # example: &quot;Smith, John&quot;
     &quot;EMAIL&quot;: {&quot;%s&quot;: [&quot;mail&quot;]}
     &quot;BDAY&quot;: {&quot;%s&quot;: [&quot;birthDay&quot;]}]}
    ## Search form
    ldap_search_fields:
      &quot;User&quot;: &quot;%u&quot;
      &quot;Name&quot;: &quot;givenName&quot;
      &quot;Family Name&quot;: &quot;sn&quot;
      &quot;Email&quot;: &quot;mail&quot;
      &quot;Birthday&quot;: &quot;birthDay&quot;
    ## vCard fields to be reported
    ## Note that JID is always returned with search results
    ldap_search_reported:
      &quot;Full Name&quot;: &quot;FN&quot;
      &quot;Nickname&quot;: &quot;NICKNAME&quot;
      &quot;Birthday&quot;: &quot;BDAY&quot;
  ...
</code></pre>

<p>Note that <code>mod_vcard_ldap</code> module checks for the existence of the user
before searching in his information in LDAP.</p>

<h5 id="activedirectory">Active Directory</h5>

<p>Active Directory is just an LDAP-server with predefined attributes. A
sample configuration is shown below:</p>

<pre><code>#!yaml
auth_method: [ldap]
ldap_servers: [&quot;office.org&quot;]  # List of LDAP servers
ldap_base: &quot;DC=office,DC=org&quot; # Search base of LDAP directory
ldap_rootdn: &quot;CN=Administrator,CN=Users,DC=office,DC=org&quot; # LDAP manager
ldap_password: &quot;*******&quot; # Password to LDAP manager
ldap_uids: [&quot;sAMAccountName&quot;]
ldap_filter: &quot;(memberOf=*)&quot;

modules: 
  ...
  mod_vcard_ldap: 
    ldap_vcard_map: 
      &quot;NICKNAME&quot;: {&quot;%u&quot;, []}
      &quot;GIVEN&quot;: {&quot;%s&quot;, [&quot;givenName&quot;]}
      &quot;MIDDLE&quot;: {&quot;%s&quot;, [&quot;initials&quot;]}
      &quot;FAMILY&quot;: {&quot;%s&quot;, [&quot;sn&quot;]}
      &quot;FN&quot;: {&quot;%s&quot;, [&quot;displayName&quot;]}
      &quot;EMAIL&quot;: {&quot;%s&quot;, [&quot;mail&quot;]}
      &quot;ORGNAME&quot;: {&quot;%s&quot;, [&quot;company&quot;]}
      &quot;ORGUNIT&quot;: {&quot;%s&quot;, [&quot;department&quot;]}
      &quot;CTRY&quot;: {&quot;%s&quot;, [&quot;c&quot;]}
      &quot;LOCALITY&quot;: {&quot;%s&quot;, [&quot;l&quot;]}
      &quot;STREET&quot;: {&quot;%s&quot;, [&quot;streetAddress&quot;]}
      &quot;REGION&quot;: {&quot;%s&quot;, [&quot;st&quot;]}
      &quot;PCODE&quot;: {&quot;%s&quot;, [&quot;postalCode&quot;]}
      &quot;TITLE&quot;: {&quot;%s&quot;, [&quot;title&quot;]}
      &quot;URL&quot;: {&quot;%s&quot;, [&quot;wWWHomePage&quot;]}
      &quot;DESC&quot;: {&quot;%s&quot;, [&quot;description&quot;]}
      &quot;TEL&quot;: {&quot;%s&quot;, [&quot;telephoneNumber&quot;]}]}
    ldap_search_fields: 
      &quot;User&quot;: &quot;%u&quot;
      &quot;Name&quot;: &quot;givenName&quot;
      &quot;Family Name&quot;: &quot;sn&quot;
      &quot;Email&quot;: &quot;mail&quot;
      &quot;Company&quot;: &quot;company&quot;
      &quot;Department&quot;: &quot;department&quot;
      &quot;Role&quot;: &quot;title&quot;
      &quot;Description&quot;: &quot;description&quot;
      &quot;Phone&quot;: &quot;telephoneNumber&quot;
    ldap_search_reported: 
      &quot;Full Name&quot;: &quot;FN&quot;
      &quot;Nickname&quot;: &quot;NICKNAME&quot;
      &quot;Email&quot;: &quot;EMAIL&quot;
  ...
</code></pre>

<h3 id="riak">Riak</h3>

<p><a href="http://basho.com/riak/"><code>Riak</code></a> is a distributed NoSQL key-value data
store. The actual database access is defined in the options with <code>riak_</code>
prefix.</p>

<h4 id="connection">Connection</h4>

<p>The following paramaters are available:</p>

<dl>
<dt><code>riak_server: String</code></dt>
<dd>A hostname of the Riak server. The default is <code>localhost</code>.</dd>

<dt><code>riak_port: Port</code></dt>
<dd>The port where the Riak server is accepting connections. The defalt
 is 8087.</dd>

<dt><code>riak_pool_size: N</code></dt>
<dd>By default <code>ejabberd</code> opens 10 connections to the Riak server. You
 can change this number by using this option.</dd>

<dt><code>riak_start_interval: N</code></dt>
<dd>If the connection to the Riak server fails, <code>ejabberd</code> waits 30
 seconds before retrying. You can modify this interval with this
 option.</dd>
</dl>

<p>Example configuration:</p>

<pre><code>#!yaml
riak_server: &quot;riak.server.com&quot;
riak_port: 9097
</code></pre>

<h4 id="storage">Storage</h4>

<p>Several <code>ejabberd</code> modules can be used to store information in Riak
database. Refer to the corresponding module documentation to see if it
supports such ability. To enable storage to Riak database, just make
sure that your database is running well (see the next section), and add
the module option <code>db_type: riak</code> or set <code>default_db: riak</code> globally
if you want to use Riak for all modules.</p>

<h4 id="riakconfiguration">Riak Configuration</h4>

<p>First, you need to configure Riak to use
<a href="http://en.wikipedia.org/wiki/LevelDB"><code>LevelDB</code></a> as a database backend.</p>

<p>If you are using Riak 2.x and higher, configure <code>storage_backend</code> option
of <code>/etc/riak/riak.conf</code> as follows:</p>

<pre><code>#!yaml
...
storage_backend = leveldb
...
</code></pre>

<p>If you are using Riak 1.4.x and older, configure <code>storage_backend</code>
option of <code>/etc/riak/app.config</code> in the section <code>riak_kv</code> as follows:</p>

<pre><code>#!yaml
...
 {riak_kv, [
            ...
            {storage_backend, riak_kv_eleveldb_backend},
...
</code></pre>

<p>Second, Riak should be pointed to <code>ejabberd</code> Erlang binary files
(*.beam). As described in <a href="#install">install</a>, by default those are located in
<code>/lib/ejabberd/ebin</code> directory. So you should add the following to
<code>/etc/riak/vm.args</code>:</p>

<pre><code>#!yaml
...
## Path to ejabberd beams in order to make map/reduce
-pz /lib/ejabberd/ebin
...
</code></pre>

<p>Important notice: make sure Riak has at least read access to that
directory. Otherwise its startup will likely fail.</p>

<h3 id="redis">Redis</h3>

<p><a href="http://redis.io/"><code>Redis</code></a> is an advanced key-value cache and store. You can
use it to store transient data, such as records for C2S (client) sessions.
There are several options available:</p>

<dl>
<dt><code>redis_server: String</code></dt>
<dd>A hostname of the Redis server. The default is <code>localhost</code>.</dd>

<dt><code>redis_port: Port</code></dt>
<dd>The port where the Redis server is accepting connections. The defalt
 is 6379.</dd>

<dt><code>redis_password: String</code></dt>
<dd>The password to the Redis server. The default is an empty string,
 i.e. no password.</dd>

<dt><code>redis_db: N</code></dt>
<dd>Redis database number. The default is 0.</dd>

<dt><code>redis_reconnect_timeout: N</code></dt>
<dd>A number of seconds to wait before next connection attempt to the Redis server.
 The default is 1 second.</dd>

<dt><code>redis_connect_timeout: N</code></dt>
<dd>A number of seconds to wait for the connection to be established to the Redis
 server. The default is 1 second.</dd>
</dl>

<p>Example configuration:</p>

<pre><code>#!yaml
redis_server: &quot;redis.server.com&quot;
redis_db: 1
</code></pre>

<h3 id="defaultdatabaseconfiguration">Default database configuration</h3>

<p>You can simplify the configuration by setting the default database. This can be done with <code>default_db</code> option:</p>

<p><code>default_db: mnesia|odbc|riak</code>: This will define the default database for a module lacking <code>db_type</code> option or if <code>auth_method</code> option is not set.</p>

<h2 id="sessionmanagement">Session Management</h2>

<p>By default pointers to C2S sessions are kept in Mnesia. You may want to
use another database backend for this. The option is:</p>

<dl>
<dt><code>sm_db_type: mnesia|odbc|redis</code></dt>
<dd>Note that for <code>odbc</code> or <code>redis</code> you should have them configured. See sections
 <a href="#relationaldatabases">Relational Databases</a> or <a href="#redis">Redis</a>.</dd>
</dl>

<h2 id="modulesconfiguration">Modules Configuration</h2>

<p>The option <code>modules</code> defines the list of modules that will be loaded
after <code>ejabberd</code>'s startup. Each entry in the list is a tuple in which
the first element is the name of a module and the second is a list of
options for that module.</p>

<p>The syntax is:</p>

<dl>
<dt><code>modules: { ModuleName: ModuleOptions }</code></dt>
<dd></dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>In this example only the module <code>mod_echo</code> is loaded and no module
options are specified between the square brackets:</p>

<pre><code>#!yaml
modules:
  mod_echo: {}
</code></pre></li>
<li><p>In the second example the modules <code>mod_echo</code>, <code>mod_time</code>, and
<code>mod_version</code> are loaded without options.</p>

<pre><code>#!yaml
modules:
  mod_echo:      {}
  mod_time:      {}
  mod_version:   {}
</code></pre></li>
</ul>

<h3 id="modulesoverview">Modules Overview</h3>

<p>The following table lists all modules included in <code>ejabberd</code>.</p>

<table>
<colgroup>
<col style="text-align:left;"/>
<col style="text-align:left;"/>
<col style="text-align:left;"/>
</colgroup>

<thead>
<tr>
	<th style="text-align:left;"><span><strong>Module</strong></span></th>
	<th style="text-align:left;"><span><strong>Feature</strong></span></th>
	<th style="text-align:left;"><span><strong>Dependencies</strong></span></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;">mod_adhoc</td>
	<td style="text-align:left;">Ad-Hoc Commands (<a href="http://xmpp.org/extensions/xep-0050.html"><code>XEP-0050</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modannounce">mod_announce</a></td>
	<td style="text-align:left;">Manage announcements</td>
	<td style="text-align:left;">recommends <code>mod_adhoc</code></td>
</tr>
<tr>
	<td style="text-align:left;">mod_blocking</td>
	<td style="text-align:left;">Simple Communications Blocking (<a href="http://xmpp.org/extensions/xep-0191.html"><code>XEP-0191</code></a>)</td>
	<td style="text-align:left;"><code>mod_privacy</code></td>
</tr>
<tr>
	<td style="text-align:left;">mod_caps</td>
	<td style="text-align:left;">Entity Capabilities (<a href="http://xmpp.org/extensions/xep-0115.html"><code>XEP-0115</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;">mod_carboncopy</td>
	<td style="text-align:left;">Message Carbons (<a href="http://xmpp.org/extensions/xep-0280.html"><code>XEP-0280</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modclientstate">mod_client_state</a></td>
	<td style="text-align:left;">Filter stanzas for inactive clients</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;">mod_configure</td>
	<td style="text-align:left;">Server configuration using Ad-Hoc</td>
	<td style="text-align:left;"><code>mod_adhoc</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#moddisco">mod_disco</a></td>
	<td style="text-align:left;">Service Discovery (<a href="http://xmpp.org/extensions/xep-0030.html"><code>XEP-0030</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modecho">mod_echo</a></td>
	<td style="text-align:left;">Echoes XMPP stanzas</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modfail2ban">mod_fail2ban</a></td>
	<td style="text-align:left;">Bans IPs that show the malicious signs</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modhttpbind">mod_http_bind</a></td>
	<td style="text-align:left;">XMPP over Bosh service (HTTP Binding)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modhttpfileserver">mod_http_fileserver</a></td>
	<td style="text-align:left;">Small HTTP file server</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modirc">mod_irc</a></td>
	<td style="text-align:left;">IRC transport</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modlast">mod_last</a></td>
	<td style="text-align:left;">Last Activity (<a href="http://xmpp.org/extensions/xep-0012.html"><code>XEP-0012</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modmam">mod_mam</a></td>
	<td style="text-align:left;">Message Archive Management (<a href="http://xmpp.org/extensions/xep-0313.html"><code>XEP-0313</code></a>)</td>
	<td style="text-align:left;"><code>mod_mam</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modmuc">mod_muc</a></td>
	<td style="text-align:left;">Multi-User Chat (<a href="http://xmpp.org/extensions/xep-0045.html"><code>XEP-0045</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;">mod_muc_admin</td>
	<td style="text-align:left;">Administrative commands for Multi-User Chat</td>
	<td style="text-align:left;"><code>mod_muc</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modmuclog">mod_muc_log</a></td>
	<td style="text-align:left;">Multi-User Chat room logging</td>
	<td style="text-align:left;"><code>mod_muc</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modmulticast">mod_multicast</a></td>
	<td style="text-align:left;">Extended Stanza Addressing (<a href="http://xmpp.org/extensions/xep-0033.html"><code>XEP-0033</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modoffline">mod_offline</a></td>
	<td style="text-align:left;">Offline message storage (<a href="http://xmpp.org/extensions/xep-0160.html"><code>XEP-0160</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modping">mod_ping</a></td>
	<td style="text-align:left;">XMPP Ping and periodic keepalives (<a href="http://xmpp.org/extensions/xep-0199.html"><code>XEP-0199</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modprescounter">mod_pres_counter</a></td>
	<td style="text-align:left;">Detect presence subscription flood</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modprivacy">mod_privacy</a></td>
	<td style="text-align:left;">Blocking Communication (<a href="http://xmpp.org/extensions/xep-0016.html"><code>XEP-0016</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modprivate">mod_private</a></td>
	<td style="text-align:left;">Private XML Storage (<a href="http://xmpp.org/extensions/xep-0049.html"><code>XEP-0049</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modproxy65">mod_proxy65</a></td>
	<td style="text-align:left;">SOCKS5 Bytestreams (<a href="http://xmpp.org/extensions/xep-0065.html"><code>XEP-0065</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modpubsub">mod_pubsub</a></td>
	<td style="text-align:left;">Pub-Sub (<a href="http://xmpp.org/extensions/xep-0060.html"><code>XEP-0060</code></a>), PEP (<a href="http://xmpp.org/extensions/xep-0163.html"><code>XEP-0163</code></a>)</td>
	<td style="text-align:left;"><code>mod_caps</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modpubsubodbc">mod_pubsub_odbc</a></td>
	<td style="text-align:left;">Pub-Sub (<a href="http://xmpp.org/extensions/xep-0060.html"><code>XEP-0060</code></a>), PEP (<a href="http://xmpp.org/extensions/xep-0163.html"><code>XEP-0163</code></a>)</td>
	<td style="text-align:left;">supported DB (*) and <code>mod_caps</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modregister">mod_register</a></td>
	<td style="text-align:left;">In-Band Registration (<a href="http://xmpp.org/extensions/xep-0077.html"><code>XEP-0077</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modregisterweb">mod_register_web</a></td>
	<td style="text-align:left;">Web for Account Registrations</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modroster">mod_roster</a></td>
	<td style="text-align:left;">Roster management (XMPP IM)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modservicelog">mod_service_log</a></td>
	<td style="text-align:left;">Copy user messages to logger service</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modsharedroster">mod_shared_roster</a></td>
	<td style="text-align:left;">Shared roster management</td>
	<td style="text-align:left;"><code>mod_roster</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modsharedrosterldap">mod_shared_roster_ldap</a></td>
	<td style="text-align:left;">LDAP Shared roster management</td>
	<td style="text-align:left;"><code>mod_roster</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modsic">mod_sic</a></td>
	<td style="text-align:left;">Server IP Check (<a href="http://xmpp.org/extensions/xep-0279.html"><code>XEP-0279</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modsip">mod_sip</a></td>
	<td style="text-align:left;">SIP Registrar/Proxy (<a href="http://tools.ietf.org/html/rfc3261"><code>RFC 3261</code></a>)</td>
	<td style="text-align:left;"><code>ejabberd_sip</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modstats">mod_stats</a></td>
	<td style="text-align:left;">Statistics Gathering (<a href="http://xmpp.org/extensions/xep-0039.html"><code>XEP-0039</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modtime">mod_time</a></td>
	<td style="text-align:left;">Entity Time (<a href="http://xmpp.org/extensions/xep-0202.html"><code>XEP-0202</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modvcard">mod_vcard</a></td>
	<td style="text-align:left;">vcard-temp (<a href="http://xmpp.org/extensions/xep-0054.html"><code>XEP-0054</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modvcardldap">mod_vcard_ldap</a></td>
	<td style="text-align:left;">vcard-temp (<a href="http://xmpp.org/extensions/xep-0054.html"><code>XEP-0054</code></a>)</td>
	<td style="text-align:left;">LDAP server</td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modvcardxupdate">mod_vcard_xupdate</a></td>
	<td style="text-align:left;">vCard-Based Avatars (<a href="http://xmpp.org/extensions/xep-0153.html"><code>XEP-0153</code></a>)</td>
	<td style="text-align:left;"><code>mod_vcard</code></td>
</tr>
<tr>
	<td style="text-align:left;"><a href="#modversion">mod_version</a></td>
	<td style="text-align:left;">Software Version (<a href="http://xmpp.org/extensions/xep-0092.html"><code>XEP-0092</code></a>)</td>
	<td style="text-align:left;"></td>
</tr>
</tbody>
</table>

<ul>
<li>(*) This module requires a supported database. For a list of
supported databases, see section <a href="#databaseandldapconfiguration">Database and LDAP Configuration</a>.</li>
</ul>

<p>You can see which database backend each module needs by looking at the
suffix:</p>

<ul>
<li><p>No suffix, this means that the module uses Erlang's built-in
database Mnesia as backend, Riak key-value store or ODBC database
(see??<a href="#databaseandldapconfiguration">Database and LDAP Configuration</a>).</p></li>
<li><p>'_ldap', this means that the module needs an LDAP server as
backend.</p></li>
</ul>

<p>You can find more
<a href="http://www.ejabberd.im/contributions"><code>contributed modules</code></a> on the
<code>ejabberd</code> website. Please remember that these contributions might not
work or that they can contain severe bugs and security leaks. Therefore,
use them at your own risk!</p>

<h3 id="commonoptions">Common Options</h3>

<p>The following options are used by many modules. Therefore, they are
described in this separate section.</p>

<h4 id="iqdisc">iqdisc</h4>

<p>Many modules define handlers for processing IQ queries of different
namespaces to this server or to a user (e.g.??to <code>example.org</code> or to
<code>user@example.org</code>). This option defines processing discipline for these
queries.</p>

<p>The syntax is:</p>

<dl>
<dt><code>iqdisc: Value</code></dt>
<dd></dd>
</dl>

<p>Possible <code>Value</code> are:</p>

<dl>
<dt><code>no_queue</code></dt>
<dd>All queries of a namespace with this processing discipline are
 processed directly. This means that the XMPP connection that sends
 this IQ query gets blocked: no other packets can be processed until
 this one has been completely processed. Hence this discipline is not
 recommended if the processing of a query can take a relatively long
 time.</dd>

<dt><code>one_queue</code></dt>
<dd>In this case a separate queue is created for the processing of IQ
 queries of a namespace with this discipline. In addition, the
 processing of this queue is done in parallel with that of other
 packets. This discipline is most recommended.</dd>

<dt><code>N</code></dt>
<dd>N separate queues are created to process the queries. The queries
 are thus processed in parallel, but in a controlled way.</dd>

<dt><code>parallel</code></dt>
<dd>For every packet with this discipline a separate Erlang process is
 spawned. Consequently, all these packets are processed in parallel.
 Although spawning of Erlang process has a relatively low cost, this
 can break the server's normal work, because the Erlang emulator has
 a limit on the number of processes (32000 by default).</dd>
</dl>

<p>Example:</p>

<pre><code>#!yaml
modules:
  ...
  mod_time:
    iqdisc: no_queue
  ...
</code></pre>

<h4 id="host">host</h4>

<p>This option defines the Jabber ID of a service provided by an <code>ejabberd</code>
module.</p>

<p>The syntax is:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd></dd>
</dl>

<p>If you include the keyword &quot;@HOST@&quot; in the HostName, it is replaced at
start time with the real virtual host string.</p>

<p>This example configures the echo module to provide its echoing service
in the Jabber ID <code>mirror.example.org</code>:</p>

<pre><code>#!yaml
modules:
  ...
  mod_echo:
    host: &quot;mirror.example.org&quot;
  ...
</code></pre>

<p>However, if there are several virtual hosts and this module is enabled
in all of them, the &quot;@HOST@&quot; keyword must be used:</p>

<pre><code>#!yaml
modules:
  ...
  mod_echo:
    host: &quot;mirror.@HOST@&quot;
  ...
</code></pre>

<h3 id="mod_admin_extra">mod_admin_extra</h3>

<p>Available option:</p>

<dl>
<dt><code>module_resource: Resource</code></dt>
<dd>Indicate the resource that the XMPP stanzas must use in the FROM or TO JIDs.
 This is only useful in the vcard set and get commands.
 The default value is &quot;mod_admin_extra&quot;.</dd>
</dl>

<p>In this example configuration, the users vcards can only be modified
by executing <code>mod_admin_extra</code> commands:</p>

<pre><code>#!yaml
acl:
  adminextraresource:
resource: &quot;modadminextraf8x,31ad&quot;
access:
  vcard_set:
adminextraresource: allow
all: deny
modules:
  mod_admin_extra:
module_resource: &quot;modadminextraf8x,31ad&quot;
  mod_vcard:
access_set: vcard_set
</code></pre>

<p>Description of some commands:</p>

<dl>
<dt><code>pushroster</code></dt>
<dd>
<p>The file used by <code>pushroster</code> and <code>pushroster-all</code> must be placed:
 - Windows: on the directory were you installed ejabberd:
 <code>C:/Program Files/ejabberd</code>
 - Other OS: on the same directory where the .beam files are.
 Example content for the roster file:</p>

<h1 id="erlang">!erlang</h1>

<p>[{&lt;&lt;&quot;bob&quot;&gt;&gt;, &lt;&lt;&quot;example.org&quot;&gt;&gt;, &lt;&lt;&quot;workers&quot;&gt;&gt;, &lt;&lt;&quot;Bob&quot;&gt;&gt;},
 {&lt;&lt;&quot;mart&quot;&gt;&gt;, &lt;&lt;&quot;example.org&quot;&gt;&gt;, &lt;&lt;&quot;workers&quot;&gt;&gt;, &lt;&lt;&quot;Mart&quot;&gt;&gt;},
 {&lt;&lt;&quot;Rich&quot;&gt;&gt;, &lt;&lt;&quot;example.org&quot;&gt;&gt;, &lt;&lt;&quot;bosses&quot;&gt;&gt;, &lt;&lt;&quot;Rich&quot;&gt;&gt;}].</p></dd>

<dt><code>srg-create</code></dt>
<dd>
<p>If you want to put a group Name with blankspaces, use the characters
 &quot;' and '&quot; to define when the Name starts and ends. For example:</p>

<h1 id="console">!console</h1>

<p>ejabberdctl srg-create g1 example.org &quot;'Group number 1'&quot; this_is_g1 g1</p></dd>

<dt><code>ban-account</code></dt>
<dd>This command kicks all the connected sessions of the account from the
 server. It also changes his password to another randomly
 generated, so he can't login anymore unless a server administrator
 changes him again the password.</dd>
</dl>

<p>It is possible to define the reason of the ban. The new password
 also includes the reason and the date and time of the ban.</p>

<p>For example, if this command is called:</p>

<pre><code>#!console
ejabberdctl vhost example.org ban-account boby Spammed several MUC rooms
</code></pre>

<p>then the sessions of the local account which JID is boby@example.org
 will be kicked, and its password will be set to something like this:</p>

<pre><code>#!console
BANNED_ACCOUNT--20080425T21:45:07--2176635--Spammed_several_MUC_rooms
</code></pre>

<h3 id="mod_announce">mod_announce</h3>

<p>This module enables configured users to broadcast announcements and to
set the message of the day (MOTD). Configured users can perform these
actions with a XMPP client either using Ad-hoc commands or sending
messages to specific JIDs.</p>

<p>The Ad-hoc commands are listed in the Server Discovery. For this feature
to work, <code>mod_adhoc</code> must be enabled.</p>

<p>The specific JIDs where messages can be sent are listed bellow. The
first JID in each entry will apply only to the specified virtual host
<code>example.org</code>, while the JID between brackets will apply to all virtual
hosts in ejabberd.</p>

<dl>
<dt><code>example.org/announce/all (example.org/announce/all-hosts/all)</code></dt>
<dd>The message is sent to all registered users. If the user is online
 and connected to several resources, only the resource with the
 highest priority will receive the message. If the registered user is
 not connected, the message will be stored offline in assumption that
 offline storage (see section??[modoffline]) is enabled.</dd>

<dt><code>example.org/announce/online (example.org/announce/all-hosts/online)</code></dt>
<dd>The message is sent to all connected users. If the user is online
 and connected to several resources, all resources will receive the
 message.</dd>

<dt><code>example.org/announce/motd (example.org/announce/all-hosts/motd)</code></dt>
<dd>The message is set as the message of the day (MOTD) and is sent to
 users when they login. In addition the message is sent to all
 connected users (similar to <code>announce/online</code>).</dd>

<dt><code>example.org/announce/motd/update (example.org/announce/all-hosts/motd/update)</code></dt>
<dd>The message is set as message of the day (MOTD) and is sent to users
 when they login. The message is <em>not sent</em> to any currently
 connected user.</dd>

<dt><code>example.org/announce/motd/delete (example.org/announce/all-hosts/motd/delete)</code></dt>
<dd>Any message sent to this JID removes the existing message of the day
 (MOTD).</dd>
</dl>

<p>Options:</p>

<dl>
<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>access: AccessName</code></dt>
<dd>This option specifies who is allowed to send announcements and to
 set the message of the day (by default, nobody is able to send such
 messages).</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>Only administrators can send announcements:</p>

<pre><code>#!yaml
access:
  announce:
    admin: allow

modules:
  ...
  mod_adhoc: {}
  mod_announce:
    access: announce
  ...
</code></pre></li>
<li><p>Administrators as well as the direction can send announcements:</p>

<pre><code>#!yaml
acl:
  direction:
    user:
      &quot;big_boss&quot;: &quot;example.org&quot;
      &quot;assistant&quot;: &quot;example.org&quot;
  admin:
    user:
      &quot;admin&quot;: &quot;example.org&quot;
access:
  announce:
    admin: allow
    direction: allow

modules:
  ...
  mod_adhoc: {}
  mod_announce:
    access: announce
  ...
</code></pre></li>
</ul>

<p>Note that <code>mod_announce</code> can be resource intensive on large deployments
as it can broadcast lot of messages. This module should be disabled for
instances of <code>ejabberd</code> with hundreds of thousands users.</p>

<h3 id="mod_client_state">mod_client_state</h3>

<p>This module allows for queueing or dropping certain types of stanzas
when a client indicates that the user is not actively using the client
at the moment (see
<a href="http://xmpp.org/extensions/xep-0352.html"><code>XEP-0352</code></a>). This can save
bandwidth and resources.</p>

<p>Options:</p>

<dl>
<dt><code>drop_chat_states: true|false</code></dt>
<dd>Drop most &quot;standalone&quot; Chat State Notifications (as defined in
 <a href="http://xmpp.org/extensions/xep0085.html"><code>XEP-0085</code></a>) while a
 client indicates inactivity. The default value is <code>false</code>.</dd>

<dt><code>queue_presence: true|false</code></dt>
<dd>While a client is inactive, queue presence stanzas that indicate
 (un)availability. The latest queued stanza of each contact is
 delivered as soon as the client becomes active again. The default
 value is <code>false</code>.</dd>
</dl>

<p>Example:</p>

<pre><code>#!yaml
modules:
  ...
  mod_client_state:
    drop_chat_states: true
    queue_presence: true
  ...
</code></pre>

<h3 id="mod_disco">mod_disco</h3>

<p>This module adds support for Service Discovery
(<a href="http://xmpp.org/extensions/xep-0030.html"><code>XEP-0030</code></a>). With this
module enabled, services on your server can be discovered by XMPP
clients. Note that <code>ejabberd</code> has no modules with support for the
superseded Jabber Browsing
(<a href="http://xmpp.org/extensions/xep-0011.html"><code>XEP-0011</code></a>) and Agent
Information (<a href="http://xmpp.org/extensions/xep-0094.html"><code>XEP-0094</code></a>).
Accordingly, XMPP clients need to have support for the newer Service
Discovery protocol if you want them be able to discover the services you
offer.</p>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Service Discovery
 (<code>http://jabber.org/protocol/disco#items</code> and
 <code>http://jabber.org/protocol/disco#info</code>) IQ queries (see
 section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>extra_domains: [Domain, ...]</code></dt>
<dd>With this option, you can specify a list of extra domains that are
 added to the Service Discovery item list.</dd>

<dt><code>server_info: [ { modules: Modules, name: Name, urls: [URL, ...] } ]</code></dt>
<dd>Specify additional information about the server, as described in
 Contact Addresses for XMPP Services
 (<a href="http://xmpp.org/extensions/xep0157.html"><code>XEP-0157</code></a>). <code>Modules</code>
 can be the keyword 'all', in which case the information is reported
 in all the services; or a list of <code>ejabberd</code> modules, in which case
 the information is only specified for the services provided by those
 modules. Any arbitrary <code>Name</code> and <code>URL</code> can be specified, not only
 contact addresses.</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>To serve a link to the Jabber User Directory on <code>jabber.org</code>:</p>

<pre><code>#!yaml
modules:
  ...
  mod_disco:
    extra_domains: [&quot;users.jabber.org&quot;]
  ...
</code></pre></li>
<li><p>To serve a link to the transports on another server:</p>

<pre><code>#!yaml
modules:
  ...
  mod_disco:
    extra_domains:
      - &quot;icq.example.com&quot;
      - &quot;msn.example.com&quot;
  ...
</code></pre></li>
<li><p>To serve a link to a few friendly servers:</p>

<pre><code>#!yaml
modules:
  ...
  mod_disco:
    extra_domains:
      - &quot;example.org&quot;
      - &quot;example.com&quot;
  ...
</code></pre></li>
<li><p>With this configuration, all services show abuse addresses, feedback
address on the main server, and admin addresses for both the main
server and the vJUD service:</p>

<pre><code>#!yaml
modules:
  ...
  mod_disco:
    server_info:
      - 
        modules: all
        name: &quot;abuse-addresses&quot;
        urls: [&quot;mailto:abuse@shakespeare.lit&quot;]
      - 
        modules: [mod_muc]
        name: &quot;Web chatroom logs&quot;
        urls: [&quot;http://www.example.org/muc-logs&quot;]
      - 
        modules: [mod_disco]
        name: &quot;feedback-addresses&quot;
        urls:
          - &quot;http://shakespeare.lit/feedback.php&quot;
          - &quot;mailto:feedback@shakespeare.lit&quot;
          - &quot;xmpp:feedback@shakespeare.lit&quot;
      - 
        modules:
          - mod_disco
          - mod_vcard
        name: &quot;admin-addresses&quot;
        urls:
          - &quot;mailto:xmpp@shakespeare.lit&quot;
          - &quot;xmpp:admins@shakespeare.lit&quot;
  ...
</code></pre></li>
</ul>

<h3 id="mod_echo">mod_echo</h3>

<p>This module simply echoes any XMPP packet back to the sender. This
mirror can be of interest for <code>ejabberd</code> and XMPP client debugging.</p>

<p>Options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>echo.</code>'. The keyword &quot;@HOST@&quot; is
 replaced at start time with the real virtual host name.</dd>
</dl>

<p>Example: Mirror, mirror, on the wall, who is the most beautiful of them
all?</p>

<pre><code>#!yaml
modules:
  ...
  mod_echo:
    host: &quot;mirror.example.org&quot;
  ...
</code></pre>

<h3 id="mod_fail2ban">mod_fail2ban</h3>

<p>The module bans IPs that show the malicious signs. Currently only C2S
authentication failures are detected.</p>

<p>Available options:</p>

<dl>
<dt><code>c2s_auth_ban_lifetime: Seconds</code></dt>
<dd>The lifetime of the IP ban caused by too many C2S authentication
 failures. The default is 3600, i.e. one hour.</dd>

<dt><code>c2s_max_auth_failures: Integer</code></dt>
<dd>The number of C2S authentication failures to trigger the IP ban. The
 default is 20.</dd>

<dt><code>access: AccessName</code></dt>
<dd>Specify an access rule for whitelisting IP addresses or networks. If
 the rule returns '<code>allow</code>' for a given IP address, that
 address will never be banned. The <code>AccessName</code> should be of type
 <code>ip</code>. The default value is <code>none</code>.</dd>
</dl>

<p>Example:</p>

<pre><code>#!yaml
modules:
  ...
  mod_fail2ban:
    c2s_auth_block_lifetime: 7200
    c2s_max_auth_failures: 50
  ...
</code></pre>

<h3 id="mod_http_bind">mod_http_bind</h3>

<p>This module implements XMPP over Bosh (formerly known as HTTP Binding)
as defined in <a href="http://xmpp.org/extensions/xep-0124.html"><code>XEP-0124</code></a> and
<a href="http://xmpp.org/extensions/xep-0206.html"><code>XEP-0206</code></a>. It extends
ejabberd's built in HTTP service with a configurable resource at which
this service will be hosted.</p>

<p>To use HTTP-Binding, enable the module:</p>

<pre><code>#!yaml
modules:
  ...
  mod_http_bind: {}
  ...
</code></pre>

<p>and add <code>http_bind</code> in the HTTP service. For example:</p>

<pre><code>#!yaml
listen:
  ...
  - 
    port: 5280
    module: ejabberd_http
    http_bind: true
    http_poll: true
    web_admin: true
  ...
</code></pre>

<p>With this configuration, the module will serve the requests sent to
<code>http://example.org:5280/http-bind/</code> Remember that this page is not
designed to be used by web browsers, it is used by XMPP clients that
support XMPP over Bosh.</p>

<p>If you want to set the service in a different URI path or use a
different module, you can configure it manually using the option
<code>request_handlers</code>. For example:</p>

<pre><code>#!yaml
listen:
  ...
  - 
    port: 5280
    module: ejabberd_http
    request_handlers:
       &quot;/http-bind&quot;: mod_http_bind
    http_poll: true
    web_admin: true
  ...
</code></pre>

<p>Options:</p>

<dl>
<dt><code>{max_inactivity, Seconds}</code></dt>
<dd>
<p>Define the maximum inactivity period in seconds. Default value is 30
 seconds. For example, to set 50 seconds:</p>

<pre><code>#!yaml
modules:
  ...
  mod_http_bind:
    max_inactivity: 50
  ...
</code></pre></dd>
</dl>

<h3 id="mod_http_fileserver">mod_http_fileserver</h3>

<p>This simple module serves files from the local disk over HTTP.</p>

<p>Options:</p>

<dl>
<dt><code>docroot: Path</code></dt>
<dd>Directory to serve the files.</dd>

<dt><code>accesslog: Path</code></dt>
<dd>File to log accesses using an Apache-like format. No log will be
 recorded if this option is not specified.</dd>

<dt><code>directory_indices: [Index, ...]</code></dt>
<dd>Indicate one or more directory index files, similarly to Apache's
 DirectoryIndex variable. When a web request hits a directory instead
 of a regular file, those directory indices are looked in order, and
 the first one found is returned.</dd>

<dt><code>custom_headers: {Name: Value}</code></dt>
<dd>Indicate custom HTTP headers to be included in all responses.
 Default value is: <code>[]</code></dd>

<dt><code>content_types: {Name: Type}</code></dt>
<dd>Specify mappings of extension to content type. There are several
 content types already defined, with this option you can add new
 definitions, modify or delete existing ones. To delete an existing
 definition, simply define it with a value: 'undefined'.</dd>

<dt><code>default_content_type: Type</code></dt>
<dd>Specify the content type to use for unknown extensions. Default
 value is 'application/octet-stream'.</dd>
</dl>

<p>This example configuration will serve the files from the local directory
<code>/var/www</code> in the address <code>http://example.org:5280/pub/archive/</code>. In
this example a new content type <code>ogg</code> is defined, <code>png</code> is redefined,
and <code>jpg</code> definition is deleted. To use this module you must enable it:</p>

<pre><code>#!yaml
modules:
  ...
  mod_http_fileserver:
    docroot: &quot;/var/www&quot;
    accesslog: &quot;/var/log/ejabberd/access.log&quot;
    directory_indices:
      - &quot;index.html&quot;
      - &quot;main.htm&quot;
    custom_headers:
      &quot;X-Powered-By&quot;: &quot;Erlang/OTP&quot;
      &quot;X-Fry&quot;: &quot;It's a widely-believed fact!&quot;
    content_types:
      &quot;.ogg&quot;: &quot;audio/ogg&quot;
      &quot;.png&quot;: &quot;image/png&quot;
      &quot;.jpg&quot;: undefined
    default_content_type: &quot;text/html&quot;
  ...
</code></pre>

<p>And define it as a handler in the HTTP service:</p>

<pre><code>#!yaml
listen:
  ...
  - 
    port: 5280
    module: ejabberd_http
    request_handlers:
      ...
      &quot;/pub/archive&quot;: mod_http_fileserver
      ...
  ...
</code></pre>

<h3 id="mod_http_ws">mod_http_ws</h3>

<p>This module enables xmpp communication over websocket connection as
described in <a href="http://tools.ietf.org/html/rfc7395"><code>RFC 7395</code></a>.</p>

<p>To enable this module it must have handler added to <code>request_handler</code>
section of <code>ejbberd_http</code> listener:</p>

<pre><code>#!yaml
listen:
  ...
  -
    port: 5280
    module: ejabberd_http
    request_handlers:
      ...
      &quot;/xmpp&quot;: ejabberd_http_ws
      ...
  ...
</code></pre>

<p>This module can be configured by using those options:</p>

<dl>
<dt><code>websocket_ping_interval: Seconds</code></dt>
<dd>Defines time between pings send by server to client (websocket level
protocol pings are used for this) to keep connection active. If client
won't respond to two corresponding pings connection will be assumed as
closed. Value of <code>0</code> can be used to disable it feature. Default value
of this option is set to 60.</dd>

<dt><code>websocket_timeout: Seconds</code></dt>
<dd>Amount of time without any communication after which connection
would be closed, setting this option 0 will disable this feature. This
option is set to 300.</dd>
</dl>

<h3 id="mod_irc">mod_irc</h3>

<p>This module is an IRC transport that can be used to join channels on IRC
servers.</p>

<p>End user information:</p>

<ul>
<li><p>A XMPP client with 'groupchat 1.0' support or Multi-User Chat
support (<a href="http://xmpp.org/extensions/xep-0045.html"><code>XEP-0045</code></a>) is
necessary to join IRC channels.</p></li>
<li><p>An IRC channel can be joined in nearly the same way as joining a
XMPP Multi-User Chat room. The difference is that the room name will
be 'channel%<code>irc.example.org</code>' in case <code>irc.example.org</code> is the IRC
server hosting 'channel'. And of course the host should point to the
IRC transport instead of the Multi-User Chat service.</p></li>
<li><p>You can register your nickame by sending 'IDENTIFY password' to<br/>
<code>nickserver!irc.example.org@irc.jabberserver.org</code>.</p></li>
<li><p>Entering your password is possible by sending 'LOGIN nick
password'<br/>
to <code>nickserver!irc.example.org@irc.jabberserver.org</code>.</p></li>
<li><p>The IRC transport provides Ad-Hoc Commands
(<a href="http://xmpp.org/extensions/xep-0050.html"><code>XEP-0050</code></a>) to join a
channel, and to set custom IRC username and encoding.</p></li>
<li><p>When using a popular XMPP server, it can occur that no connection
can be achieved with some IRC servers because they limit the number
of connections from one IP.</p></li>
</ul>

<p>Options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>irc.</code>'. The keyword &quot;@HOST@&quot; is
 replaced at start time with the real virtual host name.</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>access: AccessName</code></dt>
<dd>This option can be used to specify who may use the IRC transport
 (default value: <code>all</code>).</dd>

<dt><code>default_encoding: Encoding</code></dt>
<dd>Set the default IRC encoding. Default value: <code>iso8859-1</code></dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>In the first example, the IRC transport is available on (all) your
virtual host(s) with the prefix '<code>irc.</code>'. Furthermore, anyone is
able to use the transport. The default encoding is set to
&quot;iso8859-15&quot;.</p>

<pre><code>#!yaml
modules:
  ...
  mod_irc:
    access: all
    default_encoding: &quot;iso8859-15&quot;
  ...
</code></pre></li>
<li><p>In next example the IRC transport is available with JIDs with prefix
<code>irc-t.net</code>. Moreover, the transport is only accessible to two users
of <code>example.org</code>, and any user of <code>example.com</code>:</p>

<pre><code>#!yaml
acl:
  paying_customers:
    user:
      - &quot;customer1&quot;: &quot;example.org&quot;
      - &quot;customer2&quot;: &quot;example.org&quot;
    server: &quot;example.com&quot;

access:
  irc_users:
    paying_customers: allow
    all: deny

modules:
  ...
  mod_irc:
    access: irc_users
    host: &quot;irc.example.net&quot;
  ...
</code></pre></li>
</ul>

<h3 id="mod_last">mod_last</h3>

<p>This module adds support for Last Activity
(<a href="http://xmpp.org/extensions/xep-0012.html"><code>XEP-0012</code></a>). It can be used
to discover when a disconnected user last accessed the server, to know
when a connected user was last active on the server, or to query the
uptime of the <code>ejabberd</code> server.</p>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Last activity
 (<code>jabber:iq:last</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>
</dl>

<h3 id="mod_mam">mod_mam</h3>

<p>This module implements Message Archive Management as described in <a href="http://xmpp.org/extensions/xep-0313.html"><code>XEP-0313</code></a>. Versions 0.2 and 0.3 are supported at the moment. Compatible XMPP clients can use it to store their chat history on the server.</p>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Message Archive Management IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>db_type: mnesia|odbc</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>default: always|never|roster</code></dt>
<dd>The option defines default policy for chat history. When <code>always</code> is set every chat message is stored. With <code>roster</code> only chat history with contacts from user's roster is stored. <code>never</code> fully disables chat history. Note that a client can change its policy via protocol commands. The default is <code>never</code>.</dd>

<dt><code>cache_size: Integer</code></dt>
<dd>There is a cache which is used to improve performance for retrieving user's policy. This option will allow you to set the size of this cache. The default is 1000 items.</dd>

<dt><code>cache_lifetime: Seconds</code></dt>
<dd>Lifetime of the cached items in the cache described in the option <code>cache_size</code>. The default is 3600 seconds, i.e. one hour.</dd>
</dl>

<h3 id="mod_muc">mod_muc</h3>

<p>This module provides a Multi-User Chat
(<a href="http://xmpp.org/extensions/xep-0045.html"><code>XEP-0045</code></a>) service. Users
can discover existing rooms, join or create them. Occupants of a room
can chat in public or have private chats.</p>

<p>Some of the features of Multi-User Chat:</p>

<ul>
<li><p>Sending public and private messages to room occupants.</p></li>
<li><p>Inviting other users to a room.</p></li>
<li><p>Setting a room subject.</p></li>
<li><p>Creating password protected rooms.</p></li>
<li><p>Kicking and banning occupants.</p></li>
</ul>

<p>The MUC service allows any Jabber ID to register a nickname, so nobody
else can use that nickname in any room in the MUC service. To register a
nickname, open the Service Discovery in your XMPP client and register in
the MUC service.</p>

<p>This module supports clustering and load balancing. One module can be
started per cluster node. Rooms are distributed at creation time on all
available MUC module instances. The multi-user chat module is clustered
but the rooms themselves are not clustered nor fault-tolerant: if the
node managing a set of rooms goes down, the rooms disappear and they
will be recreated on an available node on first connection attempt.</p>

<p>Module options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>conference.</code>'. The keyword &quot;@HOST@&quot;
 is replaced at start time with the real virtual host name.</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>access: AccessName</code></dt>
<dd>You can specify who is allowed to use the Multi-User Chat service.
 By default everyone is allowed to use it.</dd>

<dt><code>access_create: AccessName</code></dt>
<dd>To configure who is allowed to create new rooms at the Multi-User
 Chat service, this option can be used. By default any account in the
 local ejabberd server is allowed to create rooms.</dd>

<dt><code>access_persistent: AccessName</code></dt>
<dd>To configure who is allowed to modify the 'persistent' room option.
 By default any account in the local ejabberd server is allowed to
 modify that option.</dd>

<dt><code>access_admin: AccessName</code></dt>
<dd>This option specifies who is allowed to administrate the Multi-User
 Chat service. The default value is <code>none</code>, which means that only the
 room creator can administer his room. The administrators can send a
 normal message to the service JID, and it will be shown in all
 active rooms as a service message. The administrators can send a
 groupchat message to the JID of an active room, and the message will
 be shown in the room as a service message.</dd>

<dt><code>history_size: Size</code></dt>
<dd>A small history of the current discussion is sent to users when they
 enter the room. With this option you can define the number of
 history messages to keep and send to users joining the room. The
 value is an integer. Setting the value to <code>0</code> disables the history
 feature and, as a result, nothing is kept in memory. The default
 value is <code>20</code>. This value is global and thus affects all rooms on
 the service.</dd>

<dt><code>max_users: Number</code></dt>
<dd>This option defines at the service level, the maximum number of
 users allowed per room. It can be lowered in each room configuration
 but cannot be increased in individual room configuration. The
 default value is 200.</dd>

<dt><code>max_users_admin_threshold: Number</code></dt>
<dd>This option defines the number of service admins or room owners
 allowed to enter the room when the maximum number of allowed
 occupants was reached. The default limit is 5.</dd>

<dt><code>max_user_conferences: Number</code></dt>
<dd>This option defines the maximum number of rooms that any given user
 can join. The default value is 10. This option is used to prevent
 possible abuses. Note that this is a soft limit: some users can
 sometimes join more conferences in cluster configurations.</dd>

<dt><code>max_room_id: Number</code></dt>
<dd>This option defines the maximum number of characters that Room ID
 can have when creating a new room. The default value is to not
 limit: <code>infinity</code>.</dd>

<dt><code>max_room_name: Number</code></dt>
<dd>This option defines the maximum number of characters that Room Name
 can have when configuring the room. The default value is to not
 limit: <code>infinity</code>.</dd>

<dt><code>max_room_desc: Number</code></dt>
<dd>This option defines the maximum number of characters that Room
 Description can have when configuring the room. The default value is
 to not limit: <code>infinity</code>.</dd>

<dt><code>min_message_interval: Number</code></dt>
<dd>This option defines the minimum interval between two messages send
 by an occupant in seconds. This option is global and valid for all
 rooms. A decimal value can be used. When this option is not defined,
 message rate is not limited. This feature can be used to protect a
 MUC service from occupant abuses and limit number of messages that
 will be broadcasted by the service. A good value for this minimum
 message interval is 0.4 second. If an occupant tries to send
 messages faster, an error is send back explaining that the message
 has been discarded and describing the reason why the message is not
 acceptable.</dd>

<dt><code>min_presence_interval: Number</code></dt>
<dd>This option defines the minimum of time between presence changes
 coming from a given occupant in seconds. This option is global and
 valid for all rooms. A decimal value can be used. When this option
 is not defined, no restriction is applied. This option can be used
 to protect a MUC service for occupants abuses. If an occupant tries
 to change its presence more often than the specified interval, the
 presence is cached by <code>ejabberd</code> and only the last presence is
 broadcasted to all occupants in the room after expiration of the
 interval delay. Intermediate presence packets are silently
 discarded. A good value for this option is 4 seconds.</dd>

<dt><code>max_users_presence: Number</code></dt>
<dd>This option defines after how many users in the room, it is
 considered overcrowded. When a MUC room is considered overcrowed,
 presence broadcasts are limited to reduce load, traffic and excessive
 presence 'storm' received by participants.</dd>

<dt><code>default_room_options: {OptionName: OptionValue}</code></dt>
<dd>
<p>This module option allows to define the desired default room
 options. Note that the creator of a room can modify the options of
 his room at any time using an XMPP client with MUC capability. The
 available room options and the default values are:</p>

<dl>
<dt><code>allow_change_subj: true|false</code></dt>
<dd>Allow occupants to change the subject.</dd>

<dt><code>allow_private_messages: true|false</code></dt>
<dd>Occupants can send private messages to other occupants.</dd>

<dt><code>allow_private_messages_from_visitors: anyone|moderators|nobody</code></dt>
<dd>Visitors can send private messages to other occupants.</dd>

<dt><code>allow_query_users: true|false</code></dt>
<dd>Occupants can send IQ queries to other occupants.</dd>

<dt><code>allow_user_invites: false|true</code></dt>
<dd>Allow occupants to send invitations.</dd>

<dt><code>allow_visitor_nickchange: true|false</code></dt>
<dd>Allow visitors to change nickname.</dd>

<dt><code>allow_visitor_status: true|false</code></dt>
<dd>Allow visitors to send status text in presence updates. If
 disallowed, the <code>status</code> text is stripped before broadcasting
 the presence update to all the room occupants.</dd>

<dt><code>anonymous: true|false</code></dt>
<dd>The room is anonymous: occupants don't see the real JIDs of
 other occupants. Note that the room moderators can always see
 the real JIDs of the occupants.</dd>

<dt><code>captcha_protected: false</code></dt>
<dd>When a user tries to join a room where he has no affiliation
 (not owner, admin or member), the room requires him to fill a
 CAPTCHA challenge (see section <a href="#captcha">captcha</a>) in order to accept her
 join in the room.</dd>

<dt><code>logging: false|true</code></dt>
<dd>The public messages are logged using <code>mod_muc_log</code>.</dd>

<dt><code>max_users: 200</code></dt>
<dd>Maximum number of occupants in the room.</dd>

<dt><code>members_by_default: true|false</code></dt>
<dd>The occupants that enter the room are participants by default,
 so they have 'voice'.</dd>

<dt><code>members_only: false|true</code></dt>
<dd>Only members of the room can enter.</dd>

<dt><code>moderated: true|false</code></dt>
<dd>Only occupants with 'voice' can send public messages.</dd>

<dt><code>password: roompass123</code></dt>
<dd>Password of the room. You may want to enable the next option
 too.</dd>

<dt><code>password_protected: false|true</code></dt>
<dd>The password is required to enter the room.</dd>

<dt><code>persistent: false|true</code></dt>
<dd>The room persists even if the last participant leaves.</dd>

<dt><code>public: true|false</code></dt>
<dd>The room is public in the list of the MUC service, so it can be
 discovered.</dd>

<dt><code>public_list: true|false</code></dt>
<dd>The list of participants is public, without requiring to enter
 the room.</dd>

<dt><code>title: Room Title</code></dt>
<dd>A human-readable title of the room.</dd>
</dl>

<p>All of those room options can be set to <code>true</code> or <code>false</code>, except
<code>password</code> and <code>title</code> which are strings, and <code>max_users</code> that is
integer.</p></dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>In the first example everyone is allowed to use the Multi-User Chat
service. Everyone will also be able to create new rooms but only the
user <code>admin@example.org</code> is allowed to administrate any room. In
this example he is also a global administrator. When
<code>admin@example.org</code> sends a message such as 'Tomorrow, the XMPP
server will be moved to new hardware. This will involve service
breakdowns around 23:00 UMT. We apologise for this inconvenience.'
to <code>conference.example.org</code>, it will be displayed in all active
rooms. In this example the history feature is disabled.</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      - &quot;admin&quot;: &quot;example.org&quot;

access:
  muc_admin:
    admin: allow

modules:
  ...
  mod_muc:
    access: all
    access_create: all
    access_admin: muc_admin
    history_size: 0
  ...
</code></pre></li>
<li><p>In the second example the Multi-User Chat service is only accessible
by paying customers registered on our domains and on other servers.
Of course the administrator is also allowed to access rooms. In
addition, he is the only authority able to create and administer
rooms. When <code>admin@example.org</code> sends a message such as 'Tomorrow,
the Jabber server will be moved to new hardware. This will involve
service breakdowns around 23:00 UMT. We apologise for this
inconvenience.' to <code>conference.example.org</code>, it will be displayed in
all active rooms. No <code>history_size</code> option is used, this means that
the feature is enabled and the default value of 20 history messages
will be send to the users.</p>

<pre><code>#!yaml
acl:
  paying_customers:
    user:
      - &quot;customer1&quot;: &quot;example.net&quot;
      - &quot;customer2&quot;: &quot;example.com&quot;
      - &quot;customer3&quot;: &quot;example.org&quot;
  admin:
    user:
      - &quot;admin&quot;: &quot;example.org&quot;

access:
  muc_admin
    admin: allow
    all: deny
  muc_access:
    paying_customers: allow
    admin: allow
    all: deny

modules:
  ...
  mod_muc:
    access: muc_access
    access_create: muc_admin
    access_admin: muc_admin
  ...
</code></pre></li>
<li><p>In the following example, MUC anti abuse options are used. An
occupant cannot send more than one message every 0.4 seconds and
cannot change its presence more than once every 4 seconds. The
length of Room IDs and Room Names are limited to 20 characters, and
Room Description to 300 characters. No ACLs are defined, but some
user restriction could be added as well:</p>

<pre><code>#!yaml
modules:
  ...
  mod_muc:
    min_message_interval: 0.4
    min_presence_interval: 4
    max_room_id: 20
    max_room_name: 20
    max_room_desc: 300
  ...
</code></pre></li>
<li><p>This example shows how to use <code>default_room_options</code> to make sure
the newly created rooms have by default those options.</p>

<pre><code>#!yaml
modules:
  ...
  mod_muc:
    access: muc_access
    access_create: muc_admin
    default_room_options:
      allow_change_subj: false
      allow_query_users: true
      allow_private_messages: true
      members_by_default: false
      title: &quot;New chatroom&quot;
      anonymous: false
    access_admin: muc_admin
  ...
</code></pre></li>
</ul>

<h3 id="mod_muc_log">mod_muc_log</h3>

<p>This module enables optional logging of Multi-User Chat (MUC) public
conversations to HTML. Once you enable this module, users can join a
room using a MUC capable XMPP client, and if they have enough
privileges, they can request the configuration form in which they can
set the option to enable room logging.</p>

<p>Features:</p>

<ul>
<li><p>Room details are added on top of each page: room title, JID, author,
subject and configuration.</p></li>
<li><p>The room JID in the generated HTML is a link to join the room (using
<a href="http://xmpp.org/rfcs/rfc5122.html"><code>XMPP URI</code></a>).</p></li>
<li><p>Subject and room configuration changes are tracked and displayed.</p></li>
<li><p>Joins, leaves, nick changes, kicks, bans and '/me' are tracked and
displayed, including the reason if available.</p></li>
<li><p>Generated HTML files are XHTML 1.0 Transitional and CSS compliant.</p></li>
<li><p>Timestamps are self-referencing links.</p></li>
<li><p>Links on top for quicker navigation: Previous day, Next day, Up.</p></li>
<li><p>CSS is used for style definition, and a custom CSS file can be used.</p></li>
<li><p>URLs on messages and subjects are converted to hyperlinks.</p></li>
<li><p>Timezone used on timestamps is shown on the log files.</p></li>
<li><p>A custom link can be added on top of each page.</p></li>
</ul>

<p>Options:</p>

<dl>
<dt><code>access_log: AccessName</code></dt>
<dd>This option restricts which occupants are allowed to enable or
 disable room logging. The default value is <code>muc_admin</code>. Note for
 this default setting you need to have an access rule for <code>muc_admin</code>
 in order to take effect.</dd>

<dt><code>cssfile: false|URL</code></dt>
<dd>With this option you can set whether the HTML files should have a
 custom CSS file or if they need to use the embedded CSS file.
 Allowed values are <code>false</code> and an URL to a CSS file. With the first
 value, HTML files will include the embedded CSS code. With the
 latter, you can specify the URL of the custom CSS file (for example:
 <code>http://example.com/my.css</code>). The default value is <code>false</code>.</dd>

<dt><code>dirname: room_jid|room_name</code></dt>
<dd>Allows to configure the name of the room directory. Allowed values
 are <code>room_jid</code> and <code>room_name</code>. With the first value, the room
 directory name will be the full room JID. With the latter, the room
 directory name will be only the room name, not including the MUC
 service name. The default value is <code>room_jid</code>.</dd>

<dt><code>dirtype: subdirs|plain</code></dt>
<dd>The type of the created directories can be specified with this
 option. Allowed values are <code>subdirs</code> and <code>plain</code>. With the first
 value, subdirectories are created for each year and month. With the
 latter, the names of the log files contain the full date, and there
 are no subdirectories. The default value is <code>subdirs</code>.</dd>

<dt><code>file_format: html|plaintext</code></dt>
<dd>Define the format of the log files: <code>html</code> stores in HTML format,
 <code>plaintext</code> stores in plain text. The default value is <code>html</code>.</dd>

<dt><code>file_permissions: {mode: Mode, group: Group}</code></dt>
<dd>Define the permissions that must be used when creating the log
 files: the number of the mode, and the numeric id of the group that
 will own the files. The default value is <code>{644, 33}</code>.</dd>

<dt><code>outdir: Path</code></dt>
<dd>This option sets the full path to the directory in which the HTML
 files should be stored. Make sure the <code>ejabberd</code> daemon user has
 write access on that directory. The default value is <code>www/muc</code>.</dd>

<dt><code>spam_prevention: true|false</code></dt>
<dd>To prevent spam, the <code>spam_prevention</code> option adds a special
 attribute to links that prevent their indexation by search engines.
 The default value is <code>true</code>, which mean that nofollow attributes
 will be added to user submitted links.</dd>

<dt><code>timezone: local|universal</code></dt>
<dd>The time zone for the logs is configurable with this option. Allowed
 values are <code>local</code> and <code>universal</code>. With the first value, the local
 time, as reported to Erlang by the operating system, will be used.
 With the latter, GMT/UTC time will be used. The default value is
 <code>local</code>.</dd>

<dt><code>top_link: {URL: Text}</code></dt>
<dd>With this option you can customize the link on the top right corner
 of each log file. The default value is <code>{/, Home}</code>.</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>In the first example any room owner can enable logging, and a custom
CSS file will be used (http://example.com/my.css). The names of the
log files will contain the full date, and there will be no
subdirectories. The log files will be stored in /var/www/muclogs,
and the time zone will be GMT/UTC. Finally, the top link will be
<code>&lt;a href=&quot;http://www.jabber.ru/&quot;&gt;Jabber.ru&lt;/a&gt;</code>.</p>

<pre><code>#!yaml
access: 
  muc: 
    all: allow

modules: 
  ...
  mod_muc_log: 
    access_log: muc
    cssfile: &quot;http://example.com/my.css&quot;
    dirtype: plain
    dirname: room_jid
    outdir: &quot;/var/www/muclogs&quot;
    timezone: universal
    spam_prevention: true
    top_link: 
      &quot;http://www.jabber.ru/&quot;: &quot;Jabber.ru&quot;
  ...
</code></pre></li>
<li><p>In the second example only <code>admin1@example.org</code> and
<code>admin2@example.net</code> can enable logging, and the embedded CSS file
will be used. The names of the log files will only contain the day
(number), and there will be subdirectories for each year and month.
The log files will be stored in /var/www/muclogs, and the local time
will be used. Finally, the top link will be the default
<code>&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;</code>.</p>

<pre><code>#!yaml
acl: 
  admin: 
    user: 
      - &quot;admin1&quot;: &quot;example.org&quot;
      - &quot;admin2&quot;: &quot;example.net&quot;
access: 
  muc_log: 
    admin: allow
    all: deny

modules: 
  ...
  mod_muc_log: 
    access_log: muc_log
    cssfile: false
    dirtype: subdirs
    file_permissions:
      mode: 644
      group: 33
    outdir: &quot;/var/www/muclogs&quot;
    timezone: local
  ...
</code></pre></li>
</ul>

<h3 id="mod_multicast">mod_multicast</h3>

<p>This module implements a service for Extended Stanza Addressing (<a href="http://xmpp.org/extensions/xep-0033.html"><code>XEP-0033</code></a>)</p>

<p>Configurable options:</p>

<dl>
<dt><code>host</code></dt>
<dd>Define the hostname of the service. Default value: &quot;multicast.SERVER&quot;</dd>

<dt><code>access</code></dt>
<dd>Specify who can send packets to the multicast service. Default value: all</dd>

<dt><code>limits</code></dt>
<dd>Specify a list of custom limits which override the default ones defined in XEP-0033.
 Limits are defined with this syntax: {Sender_type, Stanza_type, Number}
 Where:
 Sender_type can have values: local or remote.
 Stanza_type can have values: message or presence.
 Number can be a positive integer or the key word infinite.
 Default value: []</dd>
</dl>

<p>Example configuration:</p>

<pre><code>#!yaml
# Only admins can send packets to multicast service
access:
  multicast:
    admin: allow
    all: deny

# If you want to allow all your users:
access:
  multicast:
    all: allow

# This allows both admins and remote users to send packets,
# but does not allow local users
acl:
  allservers:
    server_glob: &quot;*&quot;
access:
  multicast:
    admin: allow
    local: deny
    allservers: allow

modules:
  mod_multicast:
     host: &quot;multicast.example.org&quot;
     access: multicast
     limits: &quot;&gt; [ {local,message,40}, {local,presence,infinite}, {remote,message,150} ].&quot;
</code></pre>

<h3 id="mod_offline">mod_offline</h3>

<p>This module implements offline message storage
(<a href="http://xmpp.org/extensions/xep-0160.html"><code>XEP-0160</code></a>). This means
that all messages sent to an offline user will be stored on the server
until that user comes online again. Thus it is very similar to how email
works. Note that <code>ejabberdctl</code> has a command to delete expired messages
(see section??<a href="#ejabberdctl">ejabberdctl</a>).</p>

<dl>
<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>access_max_user_messages: AccessName</code></dt>
<dd>This option defines which access rule will be enforced to limit the
 maximum number of offline messages that a user can have (quota).
 When a user has too many offline messages, any new messages that he
 receive are discarded, and a resource-constraint error is returned
 to the sender. The default value is <code>max_user_offline_messages</code>.
 Then you can define an access rule with a syntax similar to
 <code>max_user_sessions</code> (see [configmaxsessions]).</dd>

<dt><code>store_empty_body: true|false</code></dt>
<dd>Whether or not to store messages with empty <code>&lt;body/&gt;</code> element. The
 default value is <code>true</code>.</dd>

<dt><code>pool_size: Size</code></dt>
<dd>This option specifies the size of the worker pool for storing
 offline messages. The allowed values are positive integers.
 Default value: <code>16</code>.</dd>
</dl>

<p>This example allows power users to have as much as 5000 offline
messages, administrators up to 2000, and all the other users up to 100.</p>

<pre><code>#!yaml
acl: 
  admin: 
    user: 
      - &quot;admin1&quot;: &quot;localhost&quot;
      - &quot;admin2&quot;: &quot;example.org&quot;
  poweruser: 
    user: 
      - &quot;bob&quot;: &quot;example.org&quot;
      - &quot;jane&quot;: &quot;example.org&quot;

access: 
  max_user_offline_messages: 
    poweruser: 5000
    admin: 2000
    all: 100

modules: 
  ...
  mod_offline: 
    access_max_user_messages: max_user_offline_messages
  ...
</code></pre>

<h3 id="mod_ping">mod_ping</h3>

<p>This module implements support for XMPP Ping
(<a href="http://xmpp.org/extensions/xep-0199.html"><code>XEP-0199</code></a>) and periodic
keepalives. When this module is enabled ejabberd responds correctly to
ping requests, as defined in the protocol.</p>

<p>Configuration options:</p>

<dl>
<dt><code>send_pings: true|false</code></dt>
<dd>If this option is set to <code>true</code>, the server sends pings to connected
 clients that are not active in a given interval <code>ping_interval</code>.
 This is useful to keep client connections alive or checking
 availability. By default this option is disabled.</dd>

<dt><code>ping_interval: Seconds</code></dt>
<dd>How often to send pings to connected clients, if the previous option
 is enabled. If a client connection does not send or receive any
 stanza in this interval, a ping request is sent to the client. The
 default value is 60 seconds.</dd>

<dt><code>timeout_action: none|kill</code></dt>
<dd>What to do when a client does not answer to a server ping request in
 less than 32 seconds. The default is to do nothing.</dd>
</dl>

<p>This example enables Ping responses, configures the module to send pings
to client connections that are inactive for 4 minutes, and if a client
does not answer to the ping in less than 32 seconds, its connection is
closed:</p>

<pre><code>#!yaml
modules:
  ...
  mod_ping:
    send_pings: true
    ping_interval: 240
    timeout_action: kill
  ...
</code></pre>

<h3 id="mod_pres_counter">mod_pres_counter</h3>

<p>This module detects flood/spam in presence subscription stanza traffic.
If a user sends or receives more of those stanzas in a time interval,
the exceeding stanzas are silently dropped, and warning is logged.</p>

<p>Configuration options:</p>

<dl>
<dt><code>count: StanzaNumber</code></dt>
<dd>The number of subscription presence stanzas (subscribe, unsubscribe,
 subscribed, unsubscribed) allowed for any direction (input or
 output) per time interval. Please note that two users subscribing to
 each other usually generate 4 stanzas, so the recommended value is 4
 or more. The default value is: 5.</dd>

<dt><code>interval: Seconds</code></dt>
<dd>The time interval defined in seconds. The default value is 60.</dd>
</dl>

<p>This example enables the module, and allows up to 5 presence
subscription stanzas to be sent or received by the users in 60 seconds:</p>

<pre><code>#!yaml
modules:
  ...
  mod_pres_counter:
    count: 5
    interval: 60
  ...
</code></pre>

<h3 id="mod_privacy">mod_privacy</h3>

<p>This module implements
<a href="http://www.xmpp.org/extensions/xep-0016.html">XEP-0016: Privacy Lists`</a>. If
end users have support for it in their XMPP client, they will be able
to:</p>

<blockquote>
<ul>
<li><p>Retrieving one's privacy lists.</p></li>
<li><p>Adding, removing, and editing one's privacy lists.</p></li>
<li><p>Setting, changing, or declining active lists.</p></li>
<li><p>Setting, changing, or declining the default list (i.e., the list
 that is active by default).</p></li>
<li><p>Allowing or blocking messages based on JID, group, or subscription
 type (or globally).</p></li>
<li><p>Allowing or blocking inbound presence notifications based on JID,
 group, or subscription type (or globally).</p></li>
<li><p>Allowing or blocking outbound presence notifications based on JID,
 group, or subscription type (or globally).</p></li>
<li><p>Allowing or blocking IQ stanzas based on JID, group, or
 subscription type (or globally).</p></li>
<li><p>Allowing or blocking all communications based on JID, group, or
 subscription type (or globally).</p></li>
</ul>
</blockquote>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Blocking Communication
 (<code>jabber:iq:privacy</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>
</dl>

<h3 id="mod_private">mod_private</h3>

<p>This module adds support for Private XML Storage
(<a href="http://xmpp.org/extensions/xep-0049.html"><code>XEP-0049</code></a>):</p>

<blockquote>
<p>Using this method, XMPP entities can store private data on the server
and retrieve it whenever necessary. The data stored might be anything,
as long as it is valid XML. One typical usage for this namespace is
the server-side storage of client-specific preferences; another is
Bookmark Storage
(<a href="http://xmpp.org/extensions/xep-0048.html"><code>XEP-0048</code></a>).</p>
</blockquote>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Private XML Storage
 (<code>jabber:iq:private</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>
</dl>

<h3 id="mod_proxy65">mod_proxy65</h3>

<p>This module implements SOCKS5 Bytestreams
(<a href="http://xmpp.org/extensions/xep-0065.html"><code>XEP-0065</code></a>). It allows
<code>ejabberd</code> to act as a file transfer proxy between two XMPP clients.</p>

<p>Options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>proxy.</code>'. The keyword &quot;@HOST@&quot; is
 replaced at start time with the real virtual host name.</dd>

<dt><code>name: Text</code></dt>
<dd>Defines Service Discovery name of the service. Default is
 <code>SOCKS5 Bytestreams</code>.</dd>

<dt><code>ip: IP</code></dt>
<dd>This option specifies which network interface to listen for. Default
 is an IP address of the service's DNS name, or, if fails,
 <code>&quot;127.0.0.1&quot;</code>.</dd>

<dt><code>port: Number</code></dt>
<dd>This option defines port to listen for incoming connections. Default
 is??7777.</dd>

<dt><code>hostname: HostName</code></dt>
<dd>Defines a hostname advertised by the service when establishing a
 session with clients. This is useful when you run the service behind
 a NAT. The default is the value of <code>ip</code> option. Examples:
 <code>proxy.mydomain.org</code>, <code>200.150.100.50</code>. Note that not all clients
 understand domain names in stream negotiation, so you should think
 twice before setting domain name in this option.</dd>

<dt><code>auth_type: anonymous|plain</code></dt>
<dd>SOCKS5 authentication type. Possible values are <code>anonymous</code> and
 <code>plain</code>. Default is <code>anonymous</code>.</dd>

<dt><code>access: AccessName</code></dt>
<dd>Defines ACL for file transfer initiators. Default is <code>all</code>.</dd>

<dt><code>max_connections: Number</code></dt>
<dd>Maximum number of active connections per file transfer initiator. No
 limit by default.</dd>

<dt><code>shaper: none|ShaperName</code></dt>
<dd>This option defines shaper for the file transfer peers. Shaper with
 the maximum bandwidth will be selected. Default is <code>none</code>.</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>The simpliest configuration of the module:</p>

<pre><code>#!yaml
modules:
  ...
  mod_proxy65: {}
  ...
</code></pre></li>
<li><p>More complicated configuration.</p>

<pre><code>#!yaml
acl: 
  admin: 
    user: 
      - &quot;admin&quot;: &quot;example.org&quot;
  proxy_users: 
    server: 
      - &quot;example.org&quot;

access: 
  proxy65_access: 
    proxy_users: allow
    all: deny
  proxy65_shaper: 
    admin: none
    proxy_users: proxyrate

shaper: 
  proxyrate: 10240

modules: 
  ...
  mod_proxy65: 
    host: &quot;proxy1.example.org&quot;
    name: &quot;File Transfer Proxy&quot;
    ip: &quot;200.150.100.1&quot;
    port: 7778
    max_connections: 5
    access: proxy65_access
    shaper: proxy65_shaper
  ...
</code></pre></li>
</ul>

<h3 id="mod_pubsub">mod_pubsub</h3>

<p>This module offers a Publish-Subscribe Service
(<a href="http://xmpp.org/extensions/xep-0060.html"><code>XEP-0060</code></a>). The
functionality in <code>mod_pubsub</code> can be extended using plugins. The plugin
that implements PEP (Personal Eventing via Pubsub)
(<a href="http://xmpp.org/extensions/xep-0163.html"><code>XEP-0163</code></a>) is enabled in
the default ejabberd configuration file, and it requires <code>mod_caps</code>.</p>

<p>Options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>
<p>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>pubsub.</code>'. The keyword &quot;@HOST@&quot; is
 replaced at start time with the real virtual host name.</p>

<p>If you use <code>mod_pubsub_odbc</code>, please ensure the prefix contains only
one dot, for example '<code>pubsub.</code>', or '<code>publish.</code>',.</p></dd>

<dt><code>access_createnode: AccessName</code></dt>
<dd>This option restricts which users are allowed to create pubsub nodes
 using ACL and ACCESS. By default any account in the local ejabberd
 server is allowed to create pubsub nodes.</dd>

<dt><code>max_items_node: MaxItems</code></dt>
<dd>Define the maximum number of items that can be stored in a node.
 Default value is 10.</dd>

<dt><code>plugins: [ Plugin, ...]</code></dt>
<dd>To specify which pubsub node plugins to use. The first one in the
 list is used by default. If this option is not defined, the default
 plugins list is: <code>[flat]</code>. PubSub clients can define which plugin to
 use when creating a node: add <code>type='plugin-name'</code> attribute to the
 <code>create</code> stanza element.</dd>

<dt><code>nodetree: Nodetree</code></dt>
<dd>
<p>To specify which nodetree to use. If not defined, the default pubsub
 nodetree is used: &quot;tree&quot;. Only one nodetree can be used per host,
 and is shared by all node plugins.</p>

<p>The &quot;virtual&quot; nodetree does not store nodes on database. This saves
resources on systems with tons of nodes. If using the &quot;virtual&quot;
nodetree, you can only enable those node plugins: [&quot;flat&quot;,&quot;pep&quot;] or
[&quot;flat&quot;]; any other plugins configuration will not work. Also, all
nodes will have the defaut configuration, and this can not be
changed. Using &quot;virtual&quot; nodetree requires to start from a clean
database, it will not work if you used the default &quot;tree&quot; nodetree
before.</p>

<p>The &quot;dag&quot; nodetree provides experimental support for PubSub
Collection Nodes
(<a href="http://xmpp.org/extensions/xep0248.html"><code>XEP-0248</code></a>). In that
case you should also add &quot;dag&quot; node plugin as default, for example:
<code>plugins: [dag,flat,hometree,pep]</code></p></dd>

<dt><code>ignore_pep_from_offline: false|true</code></dt>
<dd>To specify whether or not we should get last published PEP items
 from users in our roster which are offline when we connect. Value is
 true or false. If not defined, pubsub assumes true so we only get
 last items of online contacts.</dd>

<dt><code>last_item_cache: false|true</code></dt>
<dd>To specify whether or not pubsub should cache last items. Value is
 true or false. If not defined, pubsub do not cache last items. On
 systems with not so many nodes, caching last items speeds up pubsub
 and allows to raise user connection rate. The cost is memory usage,
 as every item is stored in memory.</dd>

<dt><code>pep_mapping: {Key, Value}</code></dt>
<dd>
<p>This allow to define a Key-Value list to choose defined node plugins
 on given PEP namespace. The following example will use node_tune
 instead of node_pep for every PEP node with tune namespace:</p>

<pre><code>#!yaml
modules:
  ...
  mod_pubsub:
    pep_mapping:
      &quot;http://jabber.org/protocol/tune&quot;: &quot;tune&quot;
  ...
</code></pre></dd>
</dl>

<p>Example of configuration that uses flat nodes as default, and allows use
of flat, nodetree and pep nodes:</p>

<pre><code>#!yaml
modules:
  ...
  mod_pubsub:
    access_createnode: pubsub_createnode
    plugins:
      - &quot;flat&quot;
      - &quot;hometree&quot;
      - &quot;pep&quot;
  ...
</code></pre>

<p>Using ODBC database requires using mod_pubsub_odbc without option
changes. Only flat, hometree and pep plugins supports ODBC. The
following example shows previous configuration with ODBC usage:</p>

<pre><code>#!yaml
modules:
  ...
  mod_pubsub_odbc:
    access_createnode: pubsub_createnode
    plugins:
      - &quot;flat&quot;
      - &quot;hometree&quot;
      - &quot;pep&quot;
  ...
</code></pre>

<h3 id="mod_register">mod_register</h3>

<p>This module adds support for In-Band Registration
(<a href="http://xmpp.org/extensions/xep-0077.html"><code>XEP-0077</code></a>). This protocol
enables end users to use a XMPP client to:</p>

<ul>
<li><p>Register a new account on the server.</p></li>
<li><p>Change the password from an existing account on the server.</p></li>
<li><p>Delete an existing account on the server.</p></li>
</ul>

<p>Options:</p>

<dl>
<dt><code>access: AccessName</code></dt>
<dd>Specify rules to restrict what usernames can be registered and
 unregistered. If a rule returns 'deny' on the requested username,
 registration and unregistration of that user name is denied. There
 are no restrictions by default.</dd>

<dt><code>access_from: AccessName</code></dt>
<dd>By default, <code>ejabberd</code> doesn't allow to register new accounts from
 s2s or existing c2s sessions. You can change it by defining access
 rule in this option. Use with care: allowing registration from s2s
 leads to uncontrolled massive accounts creation by rogue users.</dd>

<dt><code>captcha_protected: false|true</code></dt>
<dd>Protect registrations with CAPTCHA (see section <a href="#captcha">captcha</a>). The
 default is <code>false</code>.</dd>

<dt><code>ip_access: AccessName</code></dt>
<dd>Define rules to allow or deny account registration depending on the
 IP address of the XMPP client. The <code>AccessName</code> should be of type
 <code>ip</code>. The default value is <code>all</code>.</dd>

<dt><code>password_strength: Entropy</code></dt>
<dd>This option sets the minimum informational entropy for passwords.
 The value <code>Entropy</code> is a number of bits of entropy. The recommended
 minimum is 32 bits. The default is 0, i.e. no checks are performed.</dd>

<dt><code>welcome_message: {subject: Subject, body: Body}</code></dt>
<dd>Set a welcome message that is sent to each newly registered account.
 The first string is the subject, and the second string is the
 message body.</dd>

<dt><code>registration_watchers: [ JID, ...]</code></dt>
<dd>This option defines a list of JIDs which will be notified each time
 a new account is registered.</dd>

<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for In-Band Registration
 (<code>jabber:iq:register</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>
</dl>

<p>This module reads also another option defined globally for the server:
<code>registration_timeout: Timeout</code>. This option limits the frequency of
registration from a given IP or username. So, a user that tries to
register a new account from the same IP address or JID during this
number of seconds after his previous registration will receive an error
<code>resource-constraint</code> with the explanation: &quot;Users are not allowed to
register accounts so quickly&quot;. The timeout is expressed in seconds, and
it must be an integer. To disable this limitation, instead of an integer
put a word like: <code>infinity</code>. Default value: 600 seconds.</p>

<p>Examples:</p>

<ul>
<li><p>Next example prohibits the registration of too short account names,
and allows to create accounts only to clients of the local network:</p>

<pre><code>#!yaml
acl: 
  loopback:
    ip:
      - &quot;127.0.0.0/8&quot;
      - &quot;::1&quot;
  shortname: 
    user_glob: 
      - &quot;?&quot;
      - &quot;??&quot;
    ## The same using regexp:
    ##user_regexp: &quot;^..?$&quot;

access: 
  mynetworks: 
    loopback: allow
    all: deny
  register: 
    shortname: deny
    all: allow

modules: 
  mod_register: 
    ip_access: mynetworks
    access: register
</code></pre></li>
<li><p>This configuration prohibits usage of In-Band Registration to create
or delete accounts, but allows existing accounts to change the
password:</p>

<pre><code>#!yaml
access:
  register:
    all: deny

modules:
  ...
  mod_register:
    access: register
  ...
</code></pre></li>
<li><p>This configuration disables all In-Band Registration functionality:
create, delete accounts and change password:</p>

<pre><code>#!yaml
modules:
  ...
  ## mod_register:
  ##   access: register
  ...
</code></pre></li>
<li><p>Define the welcome message and two registration watchers. Also
define a registration timeout of one hour:</p>

<pre><code>#!yaml
registration_timeout: 3600
modules:
  ...
  mod_register:
    welcome_message:
      subject: &quot;Welcome!&quot;
      body: |-
        Hi.
        Welcome to this Jabber server.
        Check http://www.jabber.org

        Bye
    registration_watchers:
      - &quot;admin1@example.org&quot;
      - &quot;boss@example.net&quot;
  ...
</code></pre></li>
</ul>

<h3 id="mod_register_web">mod_register_web</h3>

<p>This module provides a web page where people can:</p>

<ul>
<li><p>Register a new account on the server.</p></li>
<li><p>Change the password from an existing account on the server.</p></li>
<li><p>Delete an existing account on the server.</p></li>
</ul>

<p>This module supports CAPTCHA image to register a new account. To enable
this feature, configure the options captcha_cmd and captcha_host.</p>

<p>Options:</p>

<dl>
<dt><code>registration_watchers: [ JID, ...]</code></dt>
<dd>This option defines a list of JIDs which will be notified each time
 a new account is registered.</dd>
</dl>

<p>This example configuration shows how to enable the module and the web
handler:</p>

<pre><code>#!yaml
hosts: 
  - &quot;localhost&quot;
  - &quot;example.org&quot;
  - &quot;example.com&quot;
listen: 
  ...
  - 
    port: 5281
    module: ejabberd_http
    register: true
    certfile: &quot;/etc/ejabberd/certificate.pem&quot;
    tls: true
  ...

modules: 
  ...
  mod_register_web: {}
  ...
</code></pre>

<p>For example, the users of the host <code>example.org</code> can visit the page:
<code>https://example.org:5281/register/</code> It is important to include the last
/ character in the URL, otherwise the subpages URL will be incorrect.</p>

<h3 id="mod_roster">mod_roster</h3>

<p>This module implements roster management as defined in
<a href="http://tools.ietf.org/html/rfc6121#section-2"><code>RFC 6121: XMPP IM</code></a>. It
also supports Roster Versioning
(<a href="http://xmpp.org/extensions/xep-0237.html"><code>XEP-0237</code></a>).</p>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Roster Management
 (<code>jabber:iq:roster</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>versioning: false|true</code></dt>
<dd>Enables Roster Versioning. This option is disabled by default.</dd>

<dt><code>store_current_id: false|true</code></dt>
<dd>If this option is enabled, the current version number is stored on
 the database. If disabled, the version number is calculated on the
 fly each time. Enabling this option reduces the load for both
 ejabberd and the database. This option does not affect the client in
 any way. This option is only useful if Roster Versioning is enabled.
 This option is disabled by default. Important: if you use
 <code>mod_shared_roster</code> or <code>mod_shared_roster_ldap</code>, you must disable
 this option.</dd>

<dt><code>access</code></dt>
<dd>This option can be configured to specify rules to restrict roster
 management. If a rule returns 'deny' on the requested user name,
 that user cannot modify his personal roster: not add/remove/modify
 contacts, or subscribe/unsubscribe presence. By default there aren't
 restrictions.</dd>

<dt><code>managers</code></dt>
<dd>List of remote entities that can manage users rosters using Remote
 Roster Management
 (<a href="http://xmpp.org/extensions/xep0321.html"><code>XEP-0321</code></a>). The
 protocol sections implemented are:
 <code>4.2. The remote entity requests current user's roster</code>.
 <code>4.3. The user updates roster</code>.
 <code>4.4. The remote entity updates the user's roster</code>. A remote entity
 cab only get or modify roster items that have the same domain as the
 entity. Default value is: <code>[]</code>.</dd>
</dl>

<p>This example configuration enables Roster Versioning with storage of
current id. The ICQ and MSN transports can get ICQ and MSN contacts, add
them, or remove them for any local account:</p>

<pre><code>#!yaml
modules:
  ...
  mod_roster:
    versioning: true
    store_current_id: true
    managers:
     - &quot;icq.example.org&quot;
     - &quot;msn.example.org&quot;
  ...
</code></pre>

<p>With this example configuration, only admins can manage their rosters;
everybody else cannot modify the roster:</p>

<pre><code>#!yaml
acl:
  admin:
    user:
      - &quot;sarah&quot;: &quot;example.org&quot;
access:
  roster:
    admin: allow

modules:
  ...
  mod_roster:
    access: roster
  ...
</code></pre>

<h3 id="mod_service_log">mod_service_log</h3>

<p>This module adds support for logging end user packets via a XMPP message
auditing service such as
<a href="http://www.funkypenguin.info/project/bandersnatch/"><code>Bandersnatch</code></a>.
All user packets are encapsulated in a <code>&lt;route/&gt;</code> element and sent to
the specified service(s).</p>

<p>Options:</p>

<dl>
<dt><code>loggers: [Names, ...]</code></dt>
<dd>With this option a (list of) service(s) that will receive the
 packets can be specified.</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>To log all end user packets to the Bandersnatch service running on
<code>bandersnatch.example.com</code>:</p>

<pre><code>#!yaml
modules:
  ...
  mod_service_log:
    loggers: [&quot;bandersnatch.example.com&quot;]
  ...
</code></pre></li>
<li><p>To log all end user packets to the Bandersnatch service running on
<code>bandersnatch.example.com</code> and the backup service on
<code>bandersnatch.example.org</code>:</p>

<pre><code>#!yaml
modules:
  ...
  mod_service_log:
    loggers:
      - &quot;bandersnatch.example.com&quot;
      - &quot;bandersnatch.example.org&quot;
  ...
</code></pre></li>
</ul>

<h3 id="mod_shared_roster">mod_shared_roster</h3>

<p>This module enables you to create shared roster groups. This means that
you can create groups of people that can see members from (other) groups
in their rosters. The big advantages of this feature are that end users
do not need to manually add all users to their rosters, and that they
cannot permanently delete users from the shared roster groups. A shared
roster group can have members from any XMPP server, but the presence
will only be available from and to members of the same virtual host
where the group is created.</p>

<p>Options:</p>

<dl>
<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>
</dl>

<p>Shared roster groups can be edited <em>only</em> via the Web Admin. Each group
has a unique identification and the following parameters:</p>

<dl>
<dt>Name</dt>
<dd>The name of the group, which will be displayed in the roster.</dd>

<dt>Description</dt>
<dd>The description of the group. This parameter does not affect
 anything.</dd>

<dt>Members</dt>
<dd>A list of JIDs of group members, entered one per line in the Web
 Admin. The special member directive <code>@all@</code> represents all the
 registered users in the virtual host; which is only recommended for
 a small server with just a few hundred users. The special member
 directive <code>@online@</code> represents the online users in the virtual
 host.</dd>

<dt>Displayed groups</dt>
<dd>A list of groups that will be in the rosters of this group's
 members. A group of other vhost can be identified with
 <code>groupid@vhost</code></dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>Take the case of a computer club that wants all its members seeing
each other in their rosters. To achieve this, they need to create a
shared roster group similar to next table:</p>

<p><span>|l|l|</span> Identification&amp; Group '<code>club_members</code>'<br/>
Name&amp; Club Members<br/>
Description&amp; Members from the computer club<br/>
Members&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>member1@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>member2@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>member3@example.org</code></td>
</tr>
</tbody>
</table>

<p>Displayed groups&amp; <code>club_members</code> </p></li>
<li><p>In another case we have a company which has three divisions:
Management, Marketing and Sales. All group members should see all
other members in their rosters. Additionally, all managers should
have all marketing and sales people in their roster. Simultaneously,
all marketeers and the whole sales team should see all managers.
This scenario can be achieved by creating shared roster groups as
shown in the following table:</p>

<p><span>|l|l|l|l|</span> Identification&amp; Group '<code>management</code>'&amp; Group
'<code>marketing</code>'&amp; Group '<code>sales</code>'<br/>
Name&amp; Management&amp; Marketing&amp; Sales<br/>
Description&amp;<br/>
Members&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>manager1@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>manager2@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>manager3@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>manager4@example.org</code></td>
</tr>
</tbody>
</table>

<p>&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>marketeer1@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>marketeer2@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>marketeer3@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>marketeer4@example.org</code></td>
</tr>
</tbody>
</table>

<p>&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>saleswoman1@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>salesman1@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>saleswoman2@example.org</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>salesman2@example.org</code></td>
</tr>
</tbody>
</table>

<p>Displayed groups&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>management</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>marketing</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>sales</code></td>
</tr>
</tbody>
</table>

<p>&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>management</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>marketing</code></td>
</tr>
</tbody>
</table>

<p>&amp;</p>

<table>
<colgroup>
<col style="text-align:left;"/>
</colgroup>

<tbody>
<tr>
	<td style="text-align:left;"><code>management</code></td>
</tr>
<tr>
	<td style="text-align:left;"><code>sales</code></td>
</tr>
</tbody>
</table>
</li>
</ul>

<h3 id="mod_shared_roster_ldap">mod_shared_roster_ldap</h3>

<p>This module lets the server administrator automatically populate users'
rosters (contact lists) with entries based on users and groups defined
in an LDAP-based directory.</p>

<h4 id="configurationparameters">Configuration parameters</h4>

<p>The module accepts the following configuration parameters. Some of them,
if unspecified, default to the values specified for the top level of
configuration. This lets you avoid specifying, for example, the bind
password, in multiple places.</p>

<h5 id="filters">Filters</h5>

<p>These parameters specify LDAP filters used to query for shared roster
information. All of them are run against the <code>ldap_base</code>.</p>

<dl>
<dt><code>ldap_rfilter</code></dt>
<dd>So called &quot;Roster Filter&quot;. Used to find names of all &quot;shared roster&quot;
 groups. See also the <code>ldap_groupattr</code> parameter. If unspecified,
 defaults to the top-level parameter of the same name. You
 <span><em>must</em></span> specify it in some place in the configuration,
 there is no default.</dd>

<dt><code>ldap_ufilter</code></dt>
<dd>
<p>&quot;User Filter&quot; - used for retrieving the human-readable name of
 roster entries (usually full names of people in the roster). See
 also the parameters <code>ldap_userdesc</code> and <code>ldap_useruid</code>. If
 unspecified, defaults to the top-level parameter of the same name.
 If that one also is unspecified, then the filter is assembled from
 values of other parameters as follows (<code>[ldap_SOMETHING]</code> is used to
 mean &quot;the value of the configuration parameter
 <span>ldap_SOMETHING</span>&quot;):</p>

<pre><code>(&amp;(&amp;([ldap_memberattr]=[ldap_memberattr_format])([ldap_groupattr]=%g))[ldap_filter])
</code></pre>

<p>Subsequently <span>%u</span> and <span>%g</span> are replaced with a
. This means that given the defaults, the filter sent to the LDAP
server is would be <code>(&amp;(memberUid=*)(cn=*))</code>. If however the
<span>ldap_memberattr_format</span> is something like
<code>uid=%u,ou=People,o=org</code>, then the filter will be
<code>(&amp;(memberUid=uid=*,ou=People,o=org)(cn=*))</code>.</p></dd>

<dt><code>ldap_gfilter</code></dt>
<dd>&quot;Group Filter&quot; - used when retrieving human-readable name (a.k.a.
 &quot;Display Name&quot;) and the members of a group. See also the parameters
 <code>ldap_groupattr</code>, <code>ldap_groupdesc</code> and <code>ldap_memberattr</code>. If
 unspecified, defaults to the top-level parameter of the same name.
 If that one also is unspecified, then the filter is constructed
 exactly in the same way as <span>User Filter</span>.</dd>

<dt><code>ldap_filter</code></dt>
<dd>Additional filter which is AND-ed together with <span>User
 Filter</span> and <span>Group Filter</span>. If unspecified,
 defaults to the top-level parameter of the same name. If that one is
 also unspecified, then no additional filter is merged with the other
 filters.</dd>
</dl>

<p>Note that you will probably need to manually define the
<span>User</span> and <span>Group Filter</span>s (since the
auto-assembled ones will not work) if:</p>

<ul>
<li><p>your <span>ldap_memberattr_format</span> is anything other than a
simple <span>%u</span>,</p></li>
<li><p><span><strong>and</strong></span> the attribute specified with
<span>ldap_memberattr</span> does not support substring matches.</p></li>
</ul>

<p>An example where it is the case is OpenLDAP and
<span>(unique)MemberName</span> attribute from the
<span>groupOf(Unique)Names</span> objectClass. A symptom of this problem
is that you will see messages such as the following in your
<span>slapd.log</span>:</p>

<pre><code>#!yaml
get_filter: unknown filter type=130
filter=&quot;(&amp;(?=undefined)(?=undefined)(something=else))&quot;
</code></pre>

<h4 id="attributes">Attributes</h4>

<p>These parameters specify the names of the attributes which hold
interesting data in the entries returned by running filters specified in
section??<a href="#filters">Filters</a>.</p>

<p>The name of the attribute that holds the group name, and that is used to
differentiate between them. Retrieved from results of the &quot;Roster
Filter&quot; and &quot;Group Filter&quot;. Defaults to <span>cn</span>.</p>

<p>The name of the attribute which holds the human-readable group name in
the objects you use to represent groups. Retrieved from results of the
&quot;Group Filter&quot;. Defaults to whatever <span>ldap_groupattr</span> is
set.</p>

<p>The name of the attribute which holds the IDs of the members of a group.
Retrieved from results of the &quot;Group Filter&quot;. Defaults to
<span>memberUid</span>.</p>

<p>The name of the attribute differs depending on the
<span>objectClass</span> you use for your group objects, for example:</p>

<p><span><span>posixGroup</span></span> <span class="math">\(\rightarrow{}\)</span>
<span>memberUid</span></p>

<p><span><span>groupOfNames</span></span> <span class="math">\(\rightarrow{}\)</span>
<span>member</span></p>

<p><span><span>groupOfUniqueNames</span></span> <span class="math">\(\rightarrow{}\)</span>
<span>uniqueMember</span></p>

<p>The name of the attribute which holds the human-readable user name.
Retrieved from results of the &quot;User Filter&quot;. Defaults to
<span>cn</span>.</p>

<p>The name of the attribute which holds the ID of a roster item. Value of
this attribute in the roster item objects needs to match the ID
retrieved from the <span>ldap_memberattr</span> attribute of a group
object. Retrieved from results of the &quot;User Filter&quot;. Defaults to
<span>cn</span>.</p>

<h4 id="controlparameters">Control parameters</h4>

<p>These paramters control the behaviour of the module.</p>

<dl>
<dt><code>ldap_memberattr_format</code></dt>
<dd>A globbing format for extracting user ID from the value of the
 attribute named by <code>ldap_memberattr</code>. Defaults to <span>%u</span>,
 which means that the whole value is the member ID. If you change it
 to something different, you may also need to specify the User and
 Group Filters manually - see section??<a href="#filters">Filters</a>.</dd>

<dt><code>ldap_memberattr_format_re</code></dt>
<dd>
<p>A regex for extracting user ID from the value of the attribute named
 by <code>ldap_memberattr</code>.</p>

<p>An example value
<span>&quot;CN=(<span class="math">\(\backslash{}\backslash{}\)</span>w*),(OU=.*,)*DC=company,DC=com&quot;</span>
works for user IDs such as the following:</p>

<ul>
<li><p><code>CN=Romeo,OU=Montague,DC=company,DC=com</code></p></li>
<li><p><code>CN=Abram,OU=Servants,OU=Montague,DC=company,DC=com</code></p></li>
<li><p><code>CN=Juliet,OU=Capulet,DC=company,DC=com</code></p></li>
<li><p><code>CN=Peter,OU=Servants,OU=Capulet,DC=company,DC=com</code></p></li>
</ul>

<p>In case:</p>

<ul>
<li><p>the option is unset,</p></li>
<li><p>or the <span>re</span> module in unavailable in the current
Erlang environment,</p></li>
<li><p>or the regular expression does not compile,</p></li>
</ul>

<p>then instead of a regular expression, a simple format specified by
<span>ldap_memberattr_format</span> is used. Also, in the last two
cases an error message is logged during the module initialization.</p>

<p>Also, note that in all cases <span>ldap_memberattr_format</span>
(and <span><em>not</em></span> the regex version) is used for constructing
the default &quot;User/Group Filter&quot; - see section??<a href="#filters">Filters</a>.</p></dd>

<dt><code>ldap_auth_check</code></dt>
<dd>Whether the module should check (via the ejabberd authentication
 subsystem) for existence of each user in the shared LDAP roster. See
 section??[msrlconfigroster] form more information. Set to
 <span>off</span> if you want to disable the check. Defaults to
 <span>on</span>.</dd>

<dt><code>ldap_user_cache_validity</code></dt>
<dd>Number of seconds for which the cache for roster item full names is
 considered fresh after retrieval. 300 by default. See
 section??[msrlconfigroster] on how it is used during roster
 retrieval.</dd>

<dt><code>ldap_group_cache_validity</code></dt>
<dd>Number of seconds for which the cache for group membership is
 considered fresh after retrieval. 300 by default. See
 section??[msrlconfigroster] on how it is used during roster
 retrieval.</dd>
</dl>

<h4 id="connectionparameters">Connection parameters</h4>

<p>The module also accepts the connection parameters, all of which default
to the top-level parameter of the same name, if unspecified.
See??[ldapconnection] for more information about them.</p>

<h4 id="retrievingtheroster">Retrieving the roster</h4>

<p>When the module is called to retrieve the shared roster for a user, the
following algorithm is used:</p>

<ol>
<li><p>[step:rfilter] A list of names of groups to display is created: the
<span>Roster Filter</span> is run against the base DN, retrieving
the values of the attribute named by <span>ldap_groupattr</span>.</p></li>
<li><p>Unless the group cache is fresh (see the
<span>ldap_group_cache_validity</span> option), it is refreshed:</p>

<ol>
<li><p>Information for all groups is retrieved using a single query:
the <span>Group Filter</span> is run against the Base DN,
retrieving the values of attributes named by
<span>ldap_groupattr</span> (group ID),
<span>ldap_groupdesc</span> (group &quot;Display Name&quot;) and
<span>ldap_memberattr</span> (IDs of group members).</p></li>
<li><p>group &quot;Display Name&quot;, read from the attribute named by
<span>ldap_groupdesc</span>, is stored in the cache for the
given group</p></li>
<li><p>the following processing takes place for each retrieved value of
attribute named by <span>ldap_memberattr</span>:</p>

<ol>
<li><p>the user ID part of it is extracted using
<span>ldap_memberattr_format(_re)</span>,</p></li>
<li><p>then (unless <span>ldap_auth_check</span> is set to
<span>off</span>) for each found user ID, the module checks
(using the <code>ejabberd</code> authentication subsystem) whether such
user exists in the given virtual host. It is skipped if the
check is enabled and fails.</p>

<p>This step is here for historical reasons. If you have a tidy
DIT and properly defined &quot;Roster Filter&quot; and &quot;Group Filter&quot;,
it is safe to disable it by setting
<span>ldap_auth_check</span> to <span>off</span> - it will
speed up the roster retrieval.</p></li>
<li><p>the user ID is stored in the list of members in the cache
for the given group</p></li>
</ol></li>
</ol></li>
<li><p>For each item (group name) in the list of groups retrieved in
step??[3step:rfilter]: 1. the display name of a shared roster group is retrieved from the
 group cache</p>

<ol>
<li><p>for each IDs of users which belong to the group, retrieved from
the group cache:</p>

<ol>
<li><p>the ID is skipped if it's the same as the one for which we
are retrieving the roster. This is so that the user does not
have himself in the roster.</p></li>
<li><p>the display name of a shared roster user is retrieved:</p>

<ol>
<li><p>first, unless the user name cache is fresh (see the
<span>ldap_user_cache_validity</span> option), it is
refreshed by running the <span>User Filter</span>,
against the Base DN, retrieving the values of attributes
named by <span>ldap_useruid</span> and
<span>ldap_userdesc</span>.</p></li>
<li><p>then, the display name for the given user ID is
retrieved from the user name cache.</p></li>
</ol></li>
</ol></li>
</ol></li>
</ol>

<h4 id="configurationexamples">Configuration examples</h4>

<p>Since there are many possible
<a href="http://en.wikipedia.org/wiki/Directory_Information_Tree"><code>DIT</code></a>
layouts, it will probably be easiest to understand how to configure the
module by looking at an example for a given DIT (or one resembling it).</p>

<h5 id="flatdit">Flat DIT</h5>

<p>This seems to be the kind of DIT for which this module was initially
designed. Basically there are just user objects, and group membership is
stored in an attribute individually for each user. For example in a
layout shown in figure??[fig:msrl-dit-flat], the group of each user is
stored in its <span>ou</span> attribute.</p>

<p>Such layout has a few downsides, including:</p>

<ul>
<li><p>information duplication - the group name is repeated in every member
object</p></li>
<li><p>difficult group management - information about group members is not
centralized, but distributed between member objects</p></li>
<li><p>inefficiency - the list of unique group names has to be computed by
iterating over all users</p></li>
</ul>

<p>This however seems to be a common DIT layout, so the module keeps
supporting it. You can use the following configuration...</p>

<pre><code>#!yaml
modules:
  ...
  mod_shared_roster_ldap:
    ldap_base: &quot;ou=flat,dc=nodomain&quot;
    ldap_rfilter: &quot;(objectClass=inetOrgPerson)&quot;
    ldap_groupattr: &quot;ou&quot;
    ldap_memberattr: &quot;cn&quot;
    ldap_filter: &quot;(objectClass=inetOrgPerson)&quot;
    ldap_userdesc: &quot;displayName&quot;
  ...
</code></pre>

<p>...to be provided with a roster as shown in figure??[fig:msrl-roster-flat]
upon connecting as user <span>czesio</span>.</p>

<h5 id="deepdit">Deep DIT</h5>

<p>This type of DIT contains distinctly typed objects for users and groups
- see figure??[fig:msrl-dit-deep]. They are shown separated into
different subtrees, but it's not a requirement.</p>

<p>If you use the following example module configuration with it:</p>

<pre><code>#!yaml
modules: 
  ...
  mod_shared_roster_ldap: 
    ldap_base: &quot;ou=deep,dc=nodomain&quot;
    ldap_rfilter: &quot;(objectClass=groupOfUniqueNames)&quot;
    ldap_filter: &quot;&quot;
    ldap_gfilter: &quot;(&amp;(objectClass=groupOfUniqueNames)(cn=%g))&quot;
    ldap_groupdesc: &quot;description&quot;
    ldap_memberattr: &quot;uniqueMember&quot;
    ldap_memberattr_format: &quot;cn=%u,ou=people,ou=deep,dc=nodomain&quot;
    ldap_ufilter: &quot;(&amp;(objectClass=inetOrgPerson)(cn=%u))&quot;
    ldap_userdesc: &quot;displayName&quot;
  ...
</code></pre>

<p>...and connect as user <span>czesio</span>, then <code>ejabberd</code> will provide
you with the roster shown in figure??[fig:msrl-roster-deep].</p>

<h3 id="mod_sic">mod_sic</h3>

<p>This module adds support for Server IP Check
(<a href="http://xmpp.org/extensions/xep-0279.html"><code>XEP-0279</code></a>). This protocol
enables a client to discover its external IP address.</p>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for <code>urn:xmpp:sic:0</code> IQ
 queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>
</dl>

<h3 id="mod_sip">mod_sip</h3>

<p>This module adds SIP proxy/registrar support for the corresponding
virtual host. Note that it is not enough to just load this module only.
You should also configure listeners and DNS records properly. See
section <a href="#sip">sip</a> for the full explanation.</p>

<p>Example configuration:</p>

<pre><code>#!yaml
modules:
  ...
  mod_sip: {}
  ...
</code></pre>

<p>Options:</p>

<dl>
<dt><code>record_route: SIP_URI</code></dt>
<dd>When the option <code>always_record_route</code> is set or when SIP outbound is
 utilized <a href="http://tools.ietf.org/html/rfc5626"><code>RFC 5626</code></a>,
 <code>ejabberd</code> inserts <code>Record-Route</code> header field with this <code>SIP_URI</code>
 into a SIP message. The default is SIP URI constructed from the
 virtual host.</dd>

<dt><code>always_record_route: true|false</code></dt>
<dd>Always insert <code>Record-Route</code> header into SIP messages. This approach
 allows to bypass NATs/firewalls a bit more easily. The default is
 <code>true</code>.</dd>

<dt><code>routes: [SIP_URI]</code></dt>
<dd>You can set a list of SIP URIs of routes pointing to this proxy
 server. The default is a list of a SIP URI constructed from the
 virtual host.</dd>

<dt><code>flow_timeout_udp: Seconds</code></dt>
<dd>For SIP outbound UDP connections set a keep-alive timer to
 <code>Seconds</code>. The default is 29.</dd>

<dt><code>flow_timeout_tcp: Seconds</code></dt>
<dd>For SIP outbound TCP connections set a keep-alive timer to
 <code>Seconds</code>. The default is 120.</dd>

<dt><code>via: [{type: Type, host: Host, port: Port}]</code></dt>
<dd>With this option for every <code>Type</code> you can specify <code>Host</code> and <code>Port</code>
 to set in <code>Via</code> header of outgoing SIP messages, where <code>Type</code> can be
 <code>udp</code>, <code>tcp</code> or <code>tls</code>. <code>Host</code> is a string and <code>Port</code> is a non
 negative integer. This is useful if you're running your server in a
 non-standard network topology.</dd>
</dl>

<p>Example complex configuration:</p>

<pre><code>#!yaml
modules:
  ...
  mod_sip:
    always_record_route: false
    record_route: sip:example.com;lr
    routes:
      - sip:example.com;lr
      - sip:sip.example.com;lr
    flow_timeout_udp: 30
    flow_timeout_tcp: 130
    via:
      - 
        type: tls
        host: &quot;sip-tls.example.com&quot;
        port: 5061
      - 
        type: tcp
        host: &quot;sip-tcp.example.com&quot;
        port: 5060
      - 
        type: udp
        host: &quot;sip-udp.example.com&quot;
        port: 5060
  ...
</code></pre>

<h3 id="mod_stats">mod_stats</h3>

<p>This module adds support for Statistics Gathering
(<a href="http://xmpp.org/extensions/xep-0039.html"><code>XEP-0039</code></a>). This protocol
allows you to retrieve next statistics from your <code>ejabberd</code> deployment:</p>

<ul>
<li><p>Total number of registered users on the current virtual host
(users/total).</p></li>
<li><p>Total number of registered users on all virtual hosts
(users/all-hosts/total).</p></li>
<li><p>Total number of online users on the current virtual host
(users/online).</p></li>
<li><p>Total number of online users on all virtual hosts
(users/all-hosts/online).</p></li>
</ul>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Statistics Gathering
 (<code>http://jabber.org/protocol/stats</code>) IQ queries (see
 section <a href="#iqdisc">IQ Discipline Option</a>).</dd>
</dl>

<p>As there are only a small amount of clients (for example
<a href="http://tkabber.jabber.ru/"><code>Tkabber</code></a>) and software libraries with
support for this XEP, a few examples are given of the XML you need to
send in order to get the statistics. Here they are:</p>

<ul>
<li><p>You can request the number of online users on the current virtual
host (<code>example.org</code>) by sending:</p>

<pre><code>#!xml
&lt;iq to='example.org' type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/stats'&gt;
    &lt;stat name='users/online'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
</code></pre></li>
<li><p>You can request the total number of registered users on all virtual
hosts by sending:</p>

<pre><code>#!xml
&lt;iq to='example.org' type='get'&gt;
  &lt;query xmlns='http://jabber.org/protocol/stats'&gt;
    &lt;stat name='users/all-hosts/total'/&gt;
  &lt;/query&gt;
&lt;/iq&gt;
</code></pre></li>
</ul>

<h3 id="mod_time">mod_time</h3>

<p>This module features support for Entity Time
(<a href="http://xmpp.org/extensions/xep-0202.html"><code>XEP-0202</code></a>). By using this
XEP, you are able to discover the time at another entity's location.</p>

<p>Options:</p>

<dl>
<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Entity Time
 (<code>jabber:iq:time</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>
</dl>

<h3 id="mod_vcard">mod_vcard</h3>

<p>This module allows end users to store and retrieve their vCard, and to
retrieve other users vCards, as defined in vcard-temp
(<a href="http://xmpp.org/extensions/xep-0054.html"><code>XEP-0054</code></a>). The module
also implements an uncomplicated Jabber User Directory based on the
vCards of these users. Moreover, it enables the server to send its vCard
when queried.</p>

<p>Options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>vjud.</code>'. The keyword &quot;@HOST@&quot; is
 replaced at start time with the real virtual host name.</dd>

<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for <code>vcard-temp</code> IQ queries
 (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>

<dt><code>search: true|false</code></dt>
<dd>This option specifies whether the search functionality is enabled or
 not. If disabled, the option <code>host</code> will be ignored and the Jabber
 User Directory service will not appear in the Service Discovery item
 list. The default value is <code>true</code>.</dd>

<dt><code>matches: infinity|Number</code></dt>
<dd>With this option, the number of reported search results can be
 limited. If the option's value is set to <code>infinity</code>, all search
 results are reported. The default value is <code>30</code>.</dd>

<dt><code>allow_return_all: false|true</code></dt>
<dd>This option enables you to specify if search operations with empty
 input fields should return all users who added some information to
 their vCard. The default value is <code>false</code>.</dd>

<dt><code>search_all_hosts, true|false</code></dt>
<dd>If this option is set to <code>true</code>, search operations will apply to all
 virtual hosts. Otherwise only the current host will be searched. The
 default value is <code>true</code>. This option is available in <code>mod_vcard</code>
 when using Mnesia, but not when using ODBC storage.</dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>In this first situation, search results are limited to twenty items,
every user who added information to their vCard will be listed when
people do an empty search, and only users from the current host will
be returned:</p>

<pre><code>#!yaml
modules:
  ...
  mod_vcard:
    search: true
    matches: 20
    allow_return_all: true
    search_all_hosts: false
  ...
</code></pre></li>
<li><p>The second situation differs in a way that search results are not
limited, and that all virtual hosts will be searched instead of only
the current one:</p>

<pre><code>#!yaml
modules:
  ...
  mod_vcard:
    search: true
    matches: infinity
    allow_return_all: true
  ...
</code></pre></li>
</ul>

<h3 id="mod_vcard_ldap">mod_vcard_ldap</h3>

<p><code>ejabberd</code> can map LDAP attributes to vCard fields. This behaviour is
implemented in the <code>mod_vcard_ldap</code> module. This module does not depend
on the authentication method (see??[ldapauth]).</p>

<p>Usually <code>ejabberd</code> treats LDAP as a read-only storage: it is possible to
consult data, but not possible to create accounts or edit vCard that is
stored in LDAP. However, it is possible to change passwords if
<code>mod_register</code> module is enabled and LDAP server supports
<a href="http://tools.ietf.org/html/rfc3062"><code>RFC 3062</code></a>.</p>

<p>The <code>mod_vcard_ldap</code> module has its own optional parameters. The first
group of parameters has the same meaning as the top-level LDAP
parameters to set the authentication method: <code>ldap_servers</code>,
<code>ldap_port</code>, <code>ldap_rootdn</code>, <code>ldap_password</code>, <code>ldap_base</code>, <code>ldap_uids</code>,
<code>ldap_deref_aliases</code> and <code>ldap_filter</code>. See section??[ldapauth] for
detailed information about these options. If one of these options is not
set, <code>ejabberd</code> will look for the top-level option with the same name.</p>

<p>The second group of parameters consists of the following
<code>mod_vcard_ldap</code>-specific options:</p>

<dl>
<dt><code>host: HostName</code></dt>
<dd>This option defines the Jabber ID of the service. If the <code>host</code>
 option is not specified, the Jabber ID will be the hostname of the
 virtual host with the prefix '<code>vjud.</code>'. The keyword &quot;@HOST@&quot; is
 replaced at start time with the real virtual host name.</dd>

<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for <code>vcard-temp</code> IQ queries
 (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>

<dt><code>search: true|false</code></dt>
<dd>This option specifies whether the search functionality is enabled
 (value: <code>true</code>) or disabled (value: <code>false</code>). If disabled, the
 option <code>host</code> will be ignored and the Jabber User Directory service
 will not appear in the Service Discovery item list. The default
 value is <code>true</code>.</dd>

<dt><code>matches: infinity|Number</code></dt>
<dd>With this option, the number of reported search results can be
 limited. If the option's value is set to <code>infinity</code>, all search
 results are reported. The default value is <code>30</code>.</dd>

<dt><code>ldap_vcard_map: {Name: {Pattern, LDAPattributes}, ...}</code></dt>
<dd>
<p>With this option you can set the table that maps LDAP attributes to
 vCard fields. <code>Name</code> is the type name of the vCard as defined in
 <a href="http://tools.ietf.org/html/rfc2426"><code>RFC 2426</code></a>. <code>Pattern</code> is a
 string which contains pattern variables <code>%u</code>, <code>%d</code> or <code>%s</code>.
 <code>LDAPattributes</code> is the list containing LDAP attributes. The pattern
 variables <code>%s</code> will be sequentially replaced with the values of LDAP
 attributes from <code>List_of_LDAP_attributes</code>, <code>%u</code> will be replaced
 with the user part of a JID, and <code>%d</code> will be replaced with the
 domain part of a JID. The default is:</p>

<pre><code>&quot;NICKNAME&quot;: {&quot;%u&quot;: []}
&quot;FN&quot;: {&quot;%s&quot;: [&quot;displayName&quot;]}
&quot;LAST&quot;: {&quot;%s&quot;: [&quot;sn&quot;]}
&quot;FIRST&quot;: {&quot;%s&quot;: [&quot;givenName&quot;]}
&quot;MIDDLE&quot;: {&quot;%s&quot;: [&quot;initials&quot;]}
&quot;ORGNAME&quot;: {&quot;%s&quot;: [&quot;o&quot;]}
&quot;ORGUNIT&quot;: {&quot;%s&quot;: [&quot;ou&quot;]}
&quot;CTRY&quot;: {&quot;%s&quot;: [&quot;c&quot;]}
&quot;LOCALITY&quot;: {&quot;%s&quot;: [&quot;l&quot;]}
&quot;STREET&quot;: {&quot;%s&quot;: [&quot;street&quot;]}
&quot;REGION&quot;: {&quot;%s&quot;: [&quot;st&quot;]}
&quot;PCODE&quot;: {&quot;%s&quot;: [&quot;postalCode&quot;]}
&quot;TITLE&quot;: {&quot;%s&quot;: [&quot;title&quot;]}
&quot;URL&quot;: {&quot;%s&quot;: [&quot;labeleduri&quot;]}
&quot;DESC&quot;: {&quot;%s&quot;: [&quot;description&quot;]}
&quot;TEL&quot;: {&quot;%s&quot;: [&quot;telephoneNumber&quot;]}
&quot;EMAIL&quot;: {&quot;%s&quot;: [&quot;mail&quot;]}
&quot;BDAY&quot;: {&quot;%s&quot;: [&quot;birthDay&quot;]}
&quot;ROLE&quot;: {&quot;%s&quot;: [&quot;employeeType&quot;]}
&quot;PHOTO&quot;: {&quot;%s&quot;: [&quot;jpegPhoto&quot;]}
</code></pre></dd>

<dt><code>ldap_search_fields: {Name: Attribute, ...}</code></dt>
<dd>
<p>This option defines the search form and the LDAP attributes to
 search within. <code>Name</code> is the name of a search form field which will
 be automatically translated by using the translation files (see
 <code>msgs/*.msg</code> for available words). <code>Attribute</code> is the LDAP attribute
 or the pattern <code>%u</code>. The default is:</p>

<pre><code>&quot;User&quot;: &quot;%u&quot;
&quot;Full Name&quot;: &quot;displayName&quot;
&quot;Given Name&quot;: &quot;givenName&quot;
&quot;Middle Name&quot;: &quot;initials&quot;
&quot;Family Name&quot;: &quot;sn&quot;
&quot;Nickname&quot;: &quot;%u&quot;
&quot;Birthday&quot;: &quot;birthDay&quot;
&quot;Country&quot;: &quot;c&quot;
&quot;City&quot;: &quot;l&quot;
&quot;Email&quot;: &quot;mail&quot;
&quot;Organization Name&quot;: &quot;o&quot;
&quot;Organization Unit&quot;: &quot;ou&quot;
</code></pre></dd>

<dt><code>ldap_search_reported: {SearchField: VcardField}, ...}</code></dt>
<dd>
<p>This option defines which search fields should be reported.
 <code>SearchField</code> is the name of a search form field which will be
 automatically translated by using the translation files (see
 <code>msgs/*.msg</code> for available words). <code>VcardField</code> is the vCard field
 name defined in the <code>ldap_vcard_map</code> option. The default is:</p>

<pre><code>&quot;Full Name&quot;: &quot;FN&quot;
&quot;Given Name&quot;: &quot;FIRST&quot;
&quot;Middle Name&quot;: &quot;MIDDLE&quot;
&quot;Family Name&quot;: &quot;LAST&quot;
&quot;Nickname&quot;: &quot;NICKNAME&quot;
&quot;Birthday&quot;: &quot;BDAY&quot;
&quot;Country&quot;: &quot;CTRY&quot;
&quot;City&quot;: &quot;LOCALITY&quot;
&quot;Email&quot;: &quot;EMAIL&quot;
&quot;Organization Name&quot;: &quot;ORGNAME&quot;
&quot;Organization Unit&quot;: &quot;ORGUNIT&quot;
</code></pre></dd>
</dl>

<p>Examples:</p>

<ul>
<li><p>Let's say <code>ldap.example.org</code> is the name of our LDAP server. We have
users with their passwords in <code>ou=Users,dc=example,dc=org</code>
directory. Also we have addressbook, which contains users emails and
their additional infos in <code>ou=AddressBook,dc=example,dc=org</code>
directory. Corresponding authentication section should looks like
this:</p>

<pre><code>#!yaml
## authentication method
auth_method: ldap
## DNS name of our LDAP server
ldap_servers:
  - &quot;ldap.example.org&quot;
## We want to authorize users from 'shadowAccount' object class only
ldap_filter: &quot;(objectClass=shadowAccount)&quot;
</code></pre>

<p>Now we want to use users LDAP-info as their vCards. We have four
attributes defined in our LDAP schema: <code>mail</code> - email address,
<code>givenName</code> - first name, <code>sn</code> - second name, <code>birthDay</code> - birthday.
Also we want users to search each other. Let's see how we can set it
up:</p>

<pre><code>#!yaml
modules:
  mod_vcard_ldap:
    ## We use the same server and port, but want to bind anonymously because
    ## our LDAP server accepts anonymous requests to
    ## &quot;ou=AddressBook,dc=example,dc=org&quot; subtree.
    ldap_rootdn: &quot;&quot;
    ldap_password: &quot;&quot;
    ## define the addressbook's base
    ldap_base: &quot;ou=AddressBook,dc=example,dc=org&quot;
    ## uidattr: user's part of JID is located in the &quot;mail&quot; attribute
    ## uidattr_format: common format for our emails
    ldap_uids: {&quot;mail&quot;: &quot;%u@mail.example.org&quot;}
    ## Now we want to define vCard pattern
    ldap_vcard_map:
      &quot;NICKNAME&quot;: {&quot;%u&quot;: []} # just use user's part of JID as his nickname
      &quot;FIRST&quot;: {&quot;%s&quot;: [&quot;givenName&quot;]}
      &quot;LAST&quot;: {&quot;%s&quot;: [&quot;sn&quot;]}
      &quot;FN&quot;: {&quot;%s, %s&quot;: [&quot;sn&quot;, &quot;givenName&quot;]} # example: &quot;Smith, John&quot;
      &quot;EMAIL&quot;: {&quot;%s&quot;: [&quot;mail&quot;]}
      &quot;BDAY&quot;: {&quot;%s&quot;: [&quot;birthDay&quot;]}
    ## Search form
    ldap_search_fields:
      &quot;User&quot;: &quot;%u&quot;
      &quot;Name&quot;: &quot;givenName&quot;
      &quot;Family Name&quot;: &quot;sn&quot;
      &quot;Email&quot;: &quot;mail&quot;
      &quot;Birthday&quot;: &quot;birthDay&quot;
    ## vCard fields to be reported
    ## Note that JID is always returned with search results
    ldap_search_reported:
      &quot;Full Name&quot;: &quot;FN&quot;
      &quot;Nickname&quot;: &quot;NICKNAME&quot;
      &quot;Birthday&quot;: &quot;BDAY&quot;
</code></pre>

<p>Note that <code>mod_vcard_ldap</code> module checks an existence of the user
before searching his info in LDAP.</p></li>
<li><p><code>ldap_vcard_map</code> example:</p>

<pre><code>#!yaml
ldap_vcard_map:
  &quot;NICKNAME&quot;: {&quot;%u&quot;: []} # just use user's part of JID as his nickname
  &quot;FN&quot;: {&quot;%s&quot;: [&quot;displayName&quot;]}
  &quot;CTRY&quot;: {&quot;Russia&quot;: []}
  &quot;EMAIL&quot;: {&quot;%u@%d&quot;: []}
  &quot;DESC&quot;: {&quot;%s\n%s&quot;: [&quot;title&quot;, &quot;description&quot;]}
</code></pre></li>
<li><p><code>ldap_search_fields</code> example:</p>

<pre><code>#!yaml
ldap_search_fields:
  &quot;User&quot;: &quot;uid&quot;
  &quot;Full Name&quot;: &quot;displayName&quot;
  &quot;Email&quot;: &quot;mail&quot;
</code></pre></li>
<li><p><code>ldap_search_reported</code> example:</p>

<pre><code>#!yaml
ldap_search_reported:
  &quot;Full Name&quot;: &quot;FN&quot;
  &quot;Email&quot;: &quot;EMAIL&quot;
  &quot;Birthday&quot;: &quot;BDAY&quot;
  &quot;Nickname&quot;: &quot;NICKNAME&quot;
</code></pre></li>
</ul>

<h3 id="mod_vcard_xupdate">mod_vcard_xupdate</h3>

<p>The user's client can store an avatar in the user vCard. The vCard-Based
Avatars protocol
(<a href="http://xmpp.org/extensions/xep-0153.html"><code>XEP-0153</code></a>) provides a
method for clients to inform the contacts what is the avatar hash value.
However, simple or small clients may not implement that protocol.</p>

<p>If this module is enabled, all the outgoing client presence stanzas get
automatically the avatar hash on behalf of the client. So, the contacts
receive the presence stanzas with the Update Data described in
<a href="http://xmpp.org/extensions/xep-0153.html"><code>XEP-0153</code></a> as if the client
would had inserted it itself. If the client had already included such
element in the presence stanza, it is replaced with the element
generated by ejabberd.</p>

<p>By enabling this module, each vCard modification produces a hash
recalculation, and each presence sent by a client produces hash
retrieval and a presence stanza rewrite. For this reason, enabling this
module will introduce a computational overhead in servers with clients
that change frequently their presence.</p>

<p>Options:</p>

<dl>
<dt><code>db_type: mnesia|odbc|riak</code></dt>
<dd>Define the type of storage where the module will create the tables and store user information. The default is the storage defined by the global option <code>default_db</code>, or <code>mnesia</code> if omitted. If <code>odbc</code> or <code>riak</code> value is defined, make sure you have defined the database, see <a href="#databaseandldapconfiguration">database</a>.</dd>
</dl>

<h3 id="mod_version">mod_version</h3>

<p>This module implements Software Version
(<a href="http://xmpp.org/extensions/xep-0092.html"><code>XEP-0092</code></a>). Consequently,
it answers <code>ejabberd</code>'s version when queried.</p>

<p>Options:</p>

<dl>
<dt><code>show_os: true|false</code></dt>
<dd>Should the operating system be revealed or not. The default value is
 <code>true</code>.</dd>

<dt><code>iqdisc: Discipline</code></dt>
<dd>This specifies the processing discipline for Software Version
 (<code>jabber:iq:version</code>) IQ queries (see section <a href="#iqdisc">IQ Discipline Option</a>).</dd>
</dl>

<h1 id="managinganejabberdserver">Managing an ejabberd server</h1>

<hr />

<h2 id="ejabberdctl">ejabberdctl</h2>

<p>With the <code>ejabberdctl</code> command line administration script you can
execute <code>ejabberdctl commands</code> (described in the next section,
<a href="#ejabberdctlcommands">ejabberdctl Commands</a>) and also many general
<code>ejabberd commands</code> (described in section
<a href="#ejabberdcommands">ejabberd Commands</a>).
This means you can start, stop and perform many
other administrative tasks in a local or remote <code>ejabberd</code> server (by
providing the argument <code>-node NODENAME</code>).</p>

<p>The <code>ejabberdctl</code> script can be configured in the file
<code>ejabberdctl.cfg</code>. This file includes detailed information about each
configurable option. See section <a href="#erlangruntimesystem">Erlang Runtime System</a>.</p>

<p>The <code>ejabberdctl</code> script returns a numerical status code. Success is
represented by <code>0</code>, error is represented by <code>1</code>, and other codes may be
used for specific results. This can be used by other scripts to
determine automatically if a command succeeded or failed, for example
using: <code>echo $?</code></p>

<p>If you use Bash, you can get Bash completion by copying the file
<code>tools/ejabberdctl.bc</code> to the directory <code>/etc/bash_completion.d/</code> (in
Debian, Ubuntu, Fedora and maybe others).</p>

<h3 id="ejabberdctlcommands">ejabberdctl Commands</h3>

<p>When <code>ejabberdctl</code> is executed without any parameter, it displays the
available options. If there isn't an <code>ejabberd</code> server running, the
available parameters are:</p>

<dl>
<dt><code>start</code></dt>
<dd>Start <code>ejabberd</code> in background mode. This is the default method.</dd>

<dt><code>debug</code></dt>
<dd>Attach an Erlang shell to an already existing <code>ejabberd</code> server.
 This allows to execute commands interactively in the <code>ejabberd</code>
 server.</dd>

<dt><code>live</code></dt>
<dd>Start <code>ejabberd</code> in live mode: the shell keeps attached to the
 started server, showing log messages and allowing to execute
 interactive commands.</dd>
</dl>

<p>If there is an <code>ejabberd</code> server running in the system, <code>ejabberdctl</code>
shows the <code>ejabberdctl commands</code> described bellow and all the
<code>ejabberd commands</code> available in that server (see
<a href="#listofejabberdcommands">List of ejabberd Commands</a>).</p>

<p>The <code>ejabberdctl commands</code> are:</p>

<dl>
<dt><code>help</code></dt>
<dd>Get help about ejabberdctl or any available command. Try
 <code>ejabberdctl help help</code>.</dd>

<dt><code>status</code></dt>
<dd>Check the status of the <code>ejabberd</code> server.</dd>

<dt><code>stop</code></dt>
<dd>Stop the <code>ejabberd</code> server.</dd>

<dt><code>restart</code></dt>
<dd>Restart the <code>ejabberd</code> server.</dd>

<dt><code>mnesia</code></dt>
<dd>Get information about the Mnesia database.</dd>
</dl>

<p>The <code>ejabberdctl</code> script can be restricted to require authentication and
execute some <code>ejabberd commands</code>; see
<a href="#restrictexecutionwithaccesscommands">AccessCommands</a>.</p>

<p>If account <code>robot1@example.org</code> is registered in <code>ejabberd</code> with
password <code>abcdef</code> (which MD5 is E8B501798950FC58AAD83C8C14978E), and
your old-format configuration file contains this setting:</p>

<pre><code>#!erlang
{hosts, [&quot;example.org&quot;]}.
{acl, bots, {user, &quot;robot1&quot;, &quot;example.org&quot;}}.
{access, ctlaccess, [{allow, bots}]}.
{ejabberdctl_access_commands, [ {ctlaccess, [registered_users, register], []} ]}.
</code></pre>

<p>then you can do this in the shell:</p>

<pre><code>#!console
$ ejabberdctl registered_users example.org
Error: no_auth_provided
$ ejabberdctl --auth robot1 example.org abcdef registered_users example.org
robot1
testuser1
testuser2
</code></pre>

<h3 id="erlangruntimesystem">Erlang Runtime System</h3>

<p><code>ejabberd</code> is an Erlang/OTP application that runs inside an Erlang
runtime system. This system is configured using environment variables
and command line parameters. The <code>ejabberdctl</code> administration script
uses many of those possibilities. You can configure some of them with
the file <code>ejabberdctl.cfg</code>, which includes detailed description about
them. This section describes for reference purposes all the environment
variables and command line parameters.</p>

<p>The environment variables:</p>

<dl>
<dt><code>EJABBERD_CONFIG_PATH</code></dt>
<dd>Path to the ejabberd configuration file.</dd>

<dt><code>EJABBERD_MSGS_PATH</code></dt>
<dd>Path to the directory with translated strings.</dd>

<dt><code>EJABBERD_LOG_PATH</code></dt>
<dd>Path to the ejabberd service log file.</dd>

<dt><code>EJABBERD_SO_PATH</code></dt>
<dd>Path to the directory with binary system libraries.</dd>

<dt><code>EJABBERD_DOC_PATH</code></dt>
<dd>Path to the directory with ejabberd documentation.</dd>

<dt><code>EJABBERD_PID_PATH</code></dt>
<dd>Path to the PID file that ejabberd can create when started.</dd>

<dt><code>HOME</code></dt>
<dd>Path to the directory that is considered <code>ejabberd</code>'s home. This
 path is used to read the file <code>.erlang.cookie</code>.</dd>

<dt><code>ERL_CRASH_DUMP</code></dt>
<dd>Path to the file where crash reports will be dumped.</dd>

<dt><code>ERL_EPMD_ADDRESS</code></dt>
<dd>IP address where epmd listens for connections (see <a href="../security/#epmd">epmd</a>).</dd>

<dt><code>ERL_INETRC</code></dt>
<dd>Indicates which IP name resolution to use. If using <code>-sname</code>,
 specify either this option or <code>-kernel inetrc filepath</code>.</dd>

<dt><code>ERL_MAX_PORTS</code></dt>
<dd>Maximum number of simultaneously open Erlang ports.</dd>

<dt><code>ERL_MAX_ETS_TABLES</code></dt>
<dd>Maximum number of ETS and Mnesia tables.</dd>
</dl>

<p>The command line parameters:</p>

<dl>
<dt><code>-sname ejabberd</code></dt>
<dd>The Erlang node will be identified using only the first part of the
 host name, i.e. other Erlang nodes outside this domain cannot
 contact this node. This is the preferable option in most cases.</dd>

<dt><code>-name ejabberd</code></dt>
<dd>The Erlang node will be fully identified. This is only useful if you
 plan to setup an <code>ejabberd</code> cluster with nodes in different
 networks.</dd>

<dt><code>-kernel inetrc '/etc/ejabberd/inetrc'</code></dt>
<dd>Indicates which IP name resolution to use. If using <code>-sname</code>,
 specify either this option or <code>ERL_INETRC</code>.</dd>

<dt><code>-kernel inet_dist_listen_min 4200 inet_dist_listen_min 4210</code></dt>
<dd>Define the first and last ports that <code>epmd</code> can listen to
 (see <a href="../security/#epmd">epmd</a>).</dd>

<dt><code>-kernel inet_dist_use_interface { 127,0,0,1 }</code></dt>
<dd>Define the IP address where this Erlang node listens for other nodes
 connections (see <a href="../security/#epmd">epmd</a>).</dd>

<dt><code>-detached</code></dt>
<dd>Starts the Erlang system detached from the system console. Useful
 for running daemons and background processes.</dd>

<dt><code>-noinput</code></dt>
<dd>Ensures that the Erlang system never tries to read any input. Useful
 for running daemons and background processes.</dd>

<dt><code>-pa /var/lib/ejabberd/ebin</code></dt>
<dd>Specify the directory where Erlang binary files (*.beam) are
 located.</dd>

<dt><code>-s ejabberd</code></dt>
<dd>Tell Erlang runtime system to start the <code>ejabberd</code> application.</dd>

<dt><code>-mnesia dir '/var/lib/ejabberd/'</code></dt>
<dd>Specify the Mnesia database directory.</dd>

<dt><code>-sasl sasl_error_logger {file, /var/log/ejabberd/erlang.log}</code></dt>
<dd>Path to the Erlang/OTP system log file. SASL here means &quot;System
 Architecture Support Libraries&quot; not &quot;Simple Authentication and
 Security Layer&quot;.</dd>

<dt><code>+K [true|false]</code></dt>
<dd>Kernel polling.</dd>

<dt><code>-smp [auto|enable|disable]</code></dt>
<dd>SMP support.</dd>

<dt><code>+P 250000</code></dt>
<dd>Maximum number of Erlang processes.</dd>

<dt><code>-remsh ejabberd@localhost</code></dt>
<dd>Open an Erlang shell in a remote Erlang node.</dd>

<dt><code>-hidden</code></dt>
<dd>The connections to other nodes are hidden (not published). The
 result is that this node is not considered part of the cluster. This
 is important when starting a temporary <code>ctl</code> or <code>debug</code> node.</dd>
</dl>

<p>Note that some characters need to be escaped when used in shell scripts,
for instance <code>&quot;</code> and <code>{}</code>. You can find other options in the Erlang
manual page (<code>erl -man erl</code>).</p>

<h2 id="ejabberdcommands">ejabberd Commands</h2>

<p>An <code>ejabberd command</code> is an abstract function identified by a name, with
a defined number and type of calling arguments and type of result that
is registered in the <code>ejabberd_commands</code> service. Those commands can be
defined in any Erlang module and executed using any valid frontend.</p>

<p><code>ejabberd</code> includes two frontends to execute <code>ejabberd commands</code>: the
script <code>ejabberdctl</code> (see <a href="#ejabberdctl">ejabberdctl</a>) and the <code>ejabberd_xmlrpc</code>
listener (see <a href="../configuration/#listeningports">Listening Ports</a>).
Other known frontends that can be installed to
execute ejabberd commands in different ways are: <code>mod_rest</code> (HTTP POST
service), <code>mod_shcommands</code> (ejabberd WebAdmin page).</p>

<h3 id="listofejabberdcommands">List of ejabberd Commands</h3>

<p><code>ejabberd</code> includes a few ejabberd Commands by default as listed below.
When more modules are installed, new commands may be available in the
frontends.</p>

<p>The easiest way to get a list of the available commands, and get help
for them is to use the ejabberdctl script:</p>

<pre><code>#!console
$ ejabberdctl help
Usage: ejabberdctl [--node nodename] [--auth user host password] command [options]

Available commands in this ejabberd node:
  backup file                  Store the database to backup file
  connected_users              List all established sessions
  connected_users_number       Get the number of established sessions
  ...
</code></pre>

<p>The commands included in ejabberd by default are:</p>

<dl>
<dt><code>stop_kindly delay announcement</code></dt>
<dd>Inform users and rooms, wait, and stop the server. Provide the delay
 in seconds, and the announcement quoted.</dd>

<dt><code>registered_vhosts</code></dt>
<dd>List all registered vhosts in SERVER</dd>

<dt><code>reopen_log</code></dt>
<dd>Reopen the log files after they were renamed. If the old files were
 not renamed before calling this command, they are automatically
 renamed to <code>*-old.log</code>. See section <a href="../troubleshooting/#logfiles">Log Files</a>.</dd>

<dt><code>convert_to_yaml /etc/ejabberd/ejabberd.cfg /etc/ejabberd/ejabberd-converted.yml</code></dt>
<dd>Convert an old ejabberd.cfg file to the YAML syntax in a new file.</dd>

<dt><code>backup ejabberd.backup</code></dt>
<dd>Store internal Mnesia database to a binary backup file.</dd>

<dt><code>restore ejabberd.backup</code></dt>
<dd>Restore immediately from a binary backup file the internal Mnesia
 database. This will consume a lot of memory if you have a large
 database, so better use <code>install_fallback</code>.</dd>

<dt><code>install_fallback ejabberd.backup</code></dt>
<dd>The binary backup file is installed as fallback: it will be used to
 restore the database at the next ejabberd start. This means that,
 after running this command, you have to restart ejabberd. This
 command requires less memory than <code>restore</code>.</dd>

<dt><code>dump ejabberd.dump</code></dt>
<dd>Dump internal Mnesia database to a text file dump.</dd>

<dt><code>load ejabberd.dump</code></dt>
<dd>Restore immediately from a text file dump. This is not recommended
 for big databases, as it will consume much time, memory and
 processor. In that case it's preferable to use <code>backup</code> and
 <code>install_fallback</code>.</dd>

<dt><code>import_piefxis, export_piefxis, export_piefxis_host</code></dt>
<dd>These options can be used to migrate accounts using
 <a href="http://xmpp.org/extensions/xep0227.html"><code>XEP-0227</code></a> formatted XML
 files from/to other Jabber/XMPP servers or move users of a vhost to
 another ejabberd installation. See also
 <a href="https://support.processone.net/doc/display/MESSENGER/ejabberd+migration+kit"><code>ejabberd migration kit</code></a>.</dd>

<dt><code>import_file, import_dir</code></dt>
<dd>These options can be used to migrate accounts using jabberd1.4
 formatted XML files. from other Jabber/XMPP servers There exist
 tutorials to
 <a href="http://www.ejabberd.im/migratetoejabberd"><code>migrate from other software to ejabberd</code></a>.</dd>

<dt><code>set_master nodename</code></dt>
<dd>Set master node of the clustered Mnesia tables. If you provide as
 nodename &quot;self&quot;, this node will be set as its own master.</dd>

<dt><code>mnesia_change_nodename oldnodename newnodename oldbackup newbackup</code></dt>
<dd>Change the erlang node name in a backup file</dd>

<dt><code>export2odbc virtualhost directory</code></dt>
<dd>Export virtual host information from Mnesia tables to SQL files.</dd>

<dt><code>update_list</code></dt>
<dd>List modified modules that can be updated</dd>

<dt><code>update module</code></dt>
<dd>Update the given module, or use the keyword: all</dd>

<dt><code>reload_config</code></dt>
<dd>Reload ejabberd configuration file into memory</dd>

<dt><code>delete_expired_messages</code></dt>
<dd>This option can be used to delete old messages in offline storage.
 This might be useful when the number of offline messages is very
 high.</dd>

<dt><code>delete_old_messages days</code></dt>
<dd>Delete offline messages older than the given days.</dd>

<dt><code>incoming_s2s_number</code></dt>
<dd>Number of incoming s2s connections on the node</dd>

<dt><code>outgoing_s2s_number</code></dt>
<dd>Number of outgoing s2s connections on the node</dd>

<dt><code>register user host password</code></dt>
<dd>Register an account in that domain with the given password.</dd>

<dt><code>unregister user host</code></dt>
<dd>Unregister the given account.</dd>

<dt><code>registered_users host</code></dt>
<dd>List all registered users in HOST</dd>

<dt><code>connected_users</code></dt>
<dd>List all established sessions</dd>

<dt><code>connected_users_number</code></dt>
<dd>Get the number of established sessions</dd>

<dt><code>user_resources user host</code></dt>
<dd>List user's connected resources</dd>

<dt><code>kick_user user host</code></dt>
<dd>Disconnect user's active sessions</dd>
</dl>

<h3 id="restrictexecutionwithaccesscommands">Restrict Execution with AccessCommands</h3>

<p>The frontends can be configured to restrict access to certain commands
using the <code>AccessCommands</code>. In that case, authentication information
must be provided.</p>

<p>This option allows quite complex settings, so it does not use the YAML
format, instead it uses the Erlang format. If you want to set that
option, then you must move the frontend definition to another config
file and include it using the <code>include_config_file</code> option (see
section??[includeconfigfile] and the example below).</p>

<p>In each frontend the <code>AccessCommands</code> option is defined in a different
place. But in all cases the option syntax is the same:</p>

<pre><code>AccessCommands = [ {Access, CommandNames, Arguments}, ...]
Access = atom()
CommandNames = all | [CommandName]
CommandName = atom()
Arguments = [ {ArgumentName, ArgumentValue}, ...]
ArgumentName = atom()
ArgumentValue = any()
</code></pre>

<p>The default value is to not define any restriction: <code>[]</code>. The
authentication information is provided when executing a command, and is
Username, Hostname and Password of a local XMPP account that has
permission to execute the corresponding command. This means that the
account must be registered in the local ejabberd, because the
information will be verified.</p>

<p>When one or several access restrictions are defined and the
authentication information is provided, each restriction is verified
until one matches completely: the account matches the Access rule, the
command name is listed in CommandNames, and the provided arguments do
not contradict Arguments.</p>

<p>As an example to understand the syntax, let's suppose those options:</p>

<pre><code>#!erlang
{hosts, [&quot;example.org&quot;]}.
{acl, bots, {user, &quot;robot1&quot;, &quot;example.org&quot;}}.
{access, commaccess, [{allow, bots}]}.
</code></pre>

<p>This list of access restrictions allows only <code>robot1@example.org</code> to
execute all commands:</p>

<pre><code>[{commaccess, all, []}]
</code></pre>

<p>See another list of restrictions (the corresponding ACL and ACCESS are
not shown):</p>

<pre><code>#!erlang
[
 %% This bot can execute all commands:
 {bot, all, []},
 %% This bot can only execute the command 'dump'. No argument restriction:
 {bot_backups, [dump], []}
 %% This bot can execute all commands,
 %% but if a 'host' argument is provided, it must be &quot;example.org&quot;:
 {bot_all_example, all, [{host, &quot;example.org&quot;}]},
 %% This bot can only execute the command 'register',
 %% and if argument 'host' is provided, it must be &quot;example.org&quot;:
 {bot_reg_example, [register], [{host, &quot;example.org&quot;}]},
 %% This bot can execute the commands 'register' and 'unregister',
 %% if argument host is provided, it must be &quot;test.org&quot;:
 {_bot_reg_test, [register, unregister], [{host, &quot;test.org&quot;}]}
]
</code></pre>

<p>In summary, you put the frontends configurations in a CFG file using
Erlang format, for example a file called <code>additional.cfg</code>:</p>

<pre><code>#!erlang
{ejabberdctl_access_commands, [ {ctlaccess, [registered_users, register], []} ]}.

{listen, [
  {4560, ejabberd_xmlrpc, [{maxsessions, 10}, {timeout, 5000},
    {access_commands, [
      {ctlaccess, [registered_users], [{host, &quot;localhost&quot;}]}
    ]}
  ]}
 ]}.

{modules, [
  {mod_rest, [
    {allowed_ips, [ {127,0,0,1}, {192,168,1,12} ]},
    {allowed_destinations, [ &quot;nolan@localhost&quot;, &quot;admin@example.com&quot; ]},
    {allowed_stanza_types, [ &quot;message&quot;, &quot;presence&quot;, &quot;iq&quot; ]},
    {access_commands, [
      {ctlaccess, [registered_users], [{host, &quot;localhost&quot;}]}
    ]}
   ]}
 ]}.
</code></pre>

<p>and then add this line at the end of your main ejabberd configuration
file, usually called <code>ejabberd.yml</code>:</p>

<pre><code>include_config_file: &quot;/etc/ejabberd/additional.cfg&quot;
</code></pre>

<h2 id="webadmin">Web Admin</h2>

<p>The <code>ejabberd</code> Web Admin allows to administer most of <code>ejabberd</code> using a
web browser.</p>

<p>This feature is enabled by default: a <code>ejabberd_http</code> listener with the
option <code>web_admin</code> (see <a href="../configuration/#listeningports">Listening Ports</a>)
is included in the listening
ports. Then you can open <code>http://server:port/admin/</code> in your favourite
web browser. You will be asked to enter the username (the <em>full</em> Jabber
ID) and password of an <code>ejabberd</code> user with administrator rights. After
authentication you will see a page similar to figure??[fig:webadmmain].</p>

<p>Here you can edit access restrictions, manage users, create backups,
manage the database, enable/disable ports listened for, view server
statistics,...</p>

<p>The access rule <code>configure</code> determines what accounts can access the Web
Admin and modify it. The access rule <code>webadmin_view</code> is to grant only
view access: those accounts can browse the Web Admin with read-only
access.</p>

<p>Example configurations:</p>

<ul>
<li><p>You can serve the Web Admin on the same port as the HTTP Polling
interface. In this example you should point your web browser to
<code>http://example.org:5280/admin/</code> to administer all virtual hosts or
to <code>http://example.org:5280/admin/server/example.com/</code> to administer
only the virtual host <code>example.com</code>. Before you get access to the
Web Admin you need to enter as username, the JID and password from a
registered user that is allowed to configure <code>ejabberd</code>. In this
example you can enter as username '<code>admin@example.net</code>' to
administer all virtual hosts (first URL). If you log in with
'<code>admin@example.com</code>' on<br/>
<code>http://example.org:5280/admin/server/example.com/</code> you can only
administer the virtual host <code>example.com</code>. The account
'<code>reviewer@example.com</code>' can browse that vhost in read-only mode.</p>

<pre><code>#!yaml
acl: 
  admin: 
    user: 
      - &quot;admin&quot;: &quot;example.net&quot;

host_config: 
  &quot;example.com&quot;: 
    acl: 
      admin: 
        user: 
          - &quot;admin&quot;: &quot;example.com&quot;
      viewers: 
        user: 
          - &quot;reviewer&quot;: &quot;example.com&quot;

access: 
  configure: 
    admin: allow
  webadmin_view: 
    viewers: allow

hosts: 
  - &quot;example.org&quot;

listen: 
  ...
  - 
    port: 5280
    module: ejabberd_http
    web_admin: true
    http_poll: true
  ...
</code></pre></li>
<li><p>For security reasons, you can serve the Web Admin on a secured
connection, on a port differing from the HTTP Polling interface, and
bind it to the internal LAN IP. The Web Admin will be accessible by
pointing your web browser to <code>https://192.168.1.1:5282/admin/</code>:</p>

<pre><code>#!yaml
hosts: 
  - &quot;example.org&quot;
listen: 
  ...
  - 
    port: 5280
    module: ejabberd_http
    http_poll: true
  - 
    ip: &quot;192.168.1.1&quot;
    port: 5282
    module: ejabberd_http
    certfile: &quot;/usr/local/etc/server.pem&quot;
    tls: true
    web_admin: true
  ...
</code></pre></li>
</ul>

<p>Certain pages in the ejabberd Web Admin contain a link to a related
section in the ejabberd Installation and Operation Guide. In order to
view such links, a copy in HTML format of the Guide must be installed in
the system. The file is searched by default in
<code>/share/doc/ejabberd/guide.html</code>. The directory of the documentation can
be specified in the environment variable <code>EJABBERD_DOC_PATH</code>. See
section <a href="#erlangruntimesystem">Erlang Runtime System</a>.</p>

<h2 id="ad-hoccommands">Ad-hoc Commands</h2>

<p>If you enable <code>mod_configure</code>??and <code>mod_adhoc</code>, you can perform several
administrative tasks in <code>ejabberd</code> with an XMPP client. The client must
support Ad-Hoc Commands
(<a href="http://xmpp.org/extensions/xep-0050.html"><code>XEP-0050</code></a>), and you must
login in the XMPP server with an account with proper privileges.</p>

<h2 id="changecomputerhostname">Change Computer Hostname</h2>

<p><code>ejabberd</code> uses the distributed Mnesia database. Being distributed,
Mnesia enforces consistency of its file, so it stores the name of the
Erlang node in it (see section <a href="../security/#erlangnodename">Erlang Node Name</a>). The name of an Erlang node
includes the hostname of the computer. So, the name of the Erlang node
changes if you change the name of the machine in which <code>ejabberd</code> runs,
or when you move <code>ejabberd</code> to a different machine.</p>

<p>You have two ways to use the old Mnesia database in an ejabberd with new
node name: put the old node name in <code>ejabberdctl.cfg</code>, or convert the
database to the new node name.</p>

<p>Those example steps will backup, convert and load the Mnesia database.
You need to have either the old Mnesia spool dir or a backup of Mnesia.
If you already have a backup file of the old database, you can go
directly to step 5. You also need to know the old node name and the new
node name. If you don't know them, look for them by executing
<code>ejabberdctl</code> or in the ejabberd log files.</p>

<p>Before starting, setup some variables:</p>

<pre><code>OLDNODE=ejabberd@oldmachine
NEWNODE=ejabberd@newmachine
OLDFILE=/tmp/old.backup
NEWFILE=/tmp/new.backup
</code></pre>

<ol>
<li><p>Start ejabberd enforcing the old node name:</p>

<pre><code>#!console
ejabberdctl --node $OLDNODE start
</code></pre></li>
<li><p>Generate a backup file:</p>

<pre><code>#!console
ejabberdctl --node $OLDNODE backup $OLDFILE
</code></pre></li>
<li><p>Stop the old node:</p>

<pre><code>#!console
ejabberdctl --node $OLDNODE stop
</code></pre></li>
<li><p>Make sure there aren't files in the Mnesia spool dir. For example:</p>

<pre><code>#!console
mkdir /var/lib/ejabberd/oldfiles
mv /var/lib/ejabberd/*.* /var/lib/ejabberd/oldfiles/
</code></pre></li>
<li><p>Start ejabberd. There isn't any need to specify the node name
anymore:</p>

<pre><code>#!console
ejabberdctl start
</code></pre></li>
<li><p>Convert the backup to new node name:</p>

<pre><code>#!console
ejabberdctl mnesia_change_nodename $OLDNODE $NEWNODE $OLDFILE $NEWFILE
</code></pre></li>
<li><p>Install the backup file as a fallback:</p>

<pre><code>#!console
ejabberdctl install_fallback $NEWFILE
</code></pre></li>
<li><p>Stop ejabberd:</p>

<pre><code>#!console
ejabberdctl stop
</code></pre>

<p>You may see an error message in the log files, it's normal, so don't
worry:</p>

<pre><code>Mnesia(ejabberd@newmachine):
** ERROR ** (ignoring core)
** FATAL ** A fallback is installed and Mnesia must be restarted.
  Forcing shutdown after mnesia_down from ejabberd@newmachine...
</code></pre></li>
<li><p>Now you can finally start ejabberd:</p>

<pre><code>#!console
ejabberdctl start
</code></pre></li>
<li><p>Check that the information of the old database is available:
accounts, rosters... After you finish, remember to delete the
temporary backup files from public directories.</p></li>
</ol>

<h1 id="securingejabberd">Securing ejabberd</h1>

<hr />

<h2 id="firewallsettings">Firewall Settings</h2>

<p>You need to take the following TCP ports in mind when configuring your
firewall:</p>

<table>
<colgroup>
<col style="text-align:left;"/>
<col style="text-align:left;"/>
</colgroup>

<thead>
<tr>
	<th style="text-align:left;"><span><strong>Port</strong></span></th>
	<th style="text-align:left;"><span><strong>Description</strong></span></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;">5222</td>
	<td style="text-align:left;">Standard port for Jabber/XMPP client connections, plain or STARTTLS.</td>
</tr>
<tr>
	<td style="text-align:left;">5223</td>
	<td style="text-align:left;">Standard port for Jabber client connections using the old SSL method.</td>
</tr>
<tr>
	<td style="text-align:left;">5269</td>
	<td style="text-align:left;">Standard port for Jabber/XMPP server connections.</td>
</tr>
<tr>
	<td style="text-align:left;">4369</td>
	<td style="text-align:left;">EPMD (see <a href="#epmd">epmd</a>) listens for Erlang node name requests.</td>
</tr>
<tr>
	<td style="text-align:left;">port range</td>
	<td style="text-align:left;">Used for connections between Erlang nodes. This range is configurable (see <a href="#epmd">epmd</a>).</td>
</tr>
</tbody>
</table>

<h2 id="epmd">epmd</h2>

<p><a href="http://www.erlang.org/doc/man/epmd.html"><code>epmd (Erlang Port Mapper Daemon)</code></a>
is a small name server included in Erlang/OTP and used by Erlang
programs when establishing distributed Erlang communications. <code>ejabberd</code>
needs <code>epmd</code> to use <code>ejabberdctl</code> and also when clustering <code>ejabberd</code>
nodes. This small program is automatically started by Erlang, and is
never stopped. If <code>ejabberd</code> is stopped, and there aren't any other
Erlang programs running in the system, you can safely stop <code>epmd</code> if you
want.</p>

<p><code>ejabberd</code> runs inside an Erlang node. To communicate with <code>ejabberd</code>,
the script <code>ejabberdctl</code> starts a new Erlang node and connects to the
Erlang node that holds <code>ejabberd</code>. In order for this communication to
work, <code>epmd</code> must be running and listening for name requests in the port
4369. You should block the port 4369 in the firewall in such a way that
only the programs in your machine can access it. or configure the option
<code>ERL_EPMD_ADDRESS</code> in the file <code>ejabberdctl.cfg</code>.</p>

<p>If you build a cluster of several <code>ejabberd</code> instances, each <code>ejabberd</code>
instance is called an <code>ejabberd</code> node. Those <code>ejabberd</code> nodes use a
special Erlang communication method to build the cluster, and EPMD is
again needed listening in the port 4369. So, if you plan to build a
cluster of <code>ejabberd</code> nodes you must open the port 4369 for the machines
involved in the cluster. Remember to block the port so Internet doesn't
have access to it.</p>

<p>Once an Erlang node solved the node name of another Erlang node using
EPMD and port 4369, the nodes communicate directly. The ports used in
this case by default are random, but can be configured in the file
<code>ejabberdctl.cfg</code>. The Erlang command-line parameter used internally is,
for example:</p>

<pre><code>erl ... -kernel inet_dist_listen_min 4370 inet_dist_listen_max 4375
</code></pre>

<p>It is also possible to configure in <code>ejabberdctl.cfg</code> the network
interface where the Erlang node will listen and accept connections. The
Erlang command-line parameter used internally is, for example:</p>

<pre><code>erl ... -kernel inet_dist_use_interface &quot;{127,0,0,1}&quot;
</code></pre>

<h2 id="erlangcookie">Erlang Cookie</h2>

<p>The Erlang cookie is a string with numbers and letters. An Erlang node
reads the cookie at startup from the command-line parameter
<code>-setcookie</code>. If not indicated, the cookie is read from the cookie file
<code>$HOME/.erlang.cookie</code>. If this file does not exist, it is created
immediately with a random cookie. Two Erlang nodes communicate only if
they have the same cookie. Setting a cookie on the Erlang node allows
you to structure your Erlang network and define which nodes are allowed
to connect to which.</p>

<p>Thanks to Erlang cookies, you can prevent access to the Erlang node by
mistake, for example when there are several Erlang nodes running
different programs in the same machine.</p>

<p>Setting a secret cookie is a simple method to difficult unauthorized
access to your Erlang node. However, the cookie system is not ultimately
effective to prevent unauthorized access or intrusion to an Erlang node.
The communication between Erlang nodes are not encrypted, so the cookie
could be read sniffing the traffic on the network. The recommended way
to secure the Erlang node is to block the port 4369.</p>

<h2 id="erlangnodename">Erlang Node Name</h2>

<p>An Erlang node may have a node name. The name can be short (if indicated
with the command-line parameter <code>-sname</code>) or long (if indicated with the
parameter <code>-name</code>). Starting an Erlang node with -sname limits the
communication between Erlang nodes to the LAN.</p>

<p>Using the option <code>-sname</code> instead of <code>-name</code> is a simple method to
difficult unauthorized access to your Erlang node. However, it is not
ultimately effective to prevent access to the Erlang node, because it
may be possible to fake the fact that you are on another network using a
modified version of Erlang <code>epmd</code>. The recommended way to secure the
Erlang node is to block the port 4369.</p>

<h2 id="securingsensitivefiles">Securing Sensitive Files</h2>

<p><code>ejabberd</code> stores sensitive data in the file system either in plain text
or binary files. The file system permissions should be set to only allow
the proper user to read, write and execute those files and directories.</p>

<dl>
<dt><code>ejabberd configuration file: /etc/ejabberd/ejabberd.yml</code></dt>
<dd>Contains the JID of administrators and passwords of external
 components. The backup files probably contain also this information,
 so it is preferable to secure the whole <code>/etc/ejabberd/</code> directory.</dd>

<dt><code>ejabberd service log: /var/log/ejabberd/ejabberd.log</code></dt>
<dd>Contains IP addresses of clients. If the loglevel is set to 5, it
 contains whole conversations and passwords. If a logrotate system is
 used, there may be several log files with similar information, so it
 is preferable to secure the whole <code>/var/log/ejabberd/</code> directory.</dd>

<dt><code>Mnesia database spool files in /var/lib/ejabberd/</code></dt>
<dd>The files store binary data, but some parts are still readable. The
 files are generated by Mnesia and their permissions cannot be set
 directly, so it is preferable to secure the whole
 <code>/var/lib/ejabberd/</code> directory.</dd>

<dt><code>Erlang cookie file: /var/lib/ejabberd/.erlang.cookie</code></dt>
<dd>See section <a href="#erlangcookie">Erlang Cookie</a>.</dd>
</dl>

<h1 id="clustering">Clustering</h1>

<hr />

<h2 id="howitworks">How it Works</h2>

<p>A XMPP domain is served by one or more <code>ejabberd</code> nodes. These nodes can
be run on different machines that are connected via a network. They all
must have the ability to connect to port 4369 of all another nodes, and
must have the same magic cookie (see Erlang/OTP documentation, in other
words the file <code>~ejabberd/.erlang.cookie</code> must be the same on all
nodes). This is needed because all nodes exchange information about
connected users, s2s connections, registered services, etc...</p>

<p>Each <code>ejabberd</code> node has the following modules:</p>

<ul>
<li><p>router,</p></li>
<li><p>local router,</p></li>
<li><p>session manager,</p></li>
<li><p>s2s manager.</p></li>
</ul>

<h3 id="router">Router</h3>

<p>This module is the main router of XMPP packets on each node. It routes
them based on their destination's domains. It uses a global routing
table. The domain of the packet's destination is searched in the routing
table, and if it is found, the packet is routed to the appropriate
process. If not, it is sent to the s2s manager.</p>

<h3 id="localrouter">Local Router</h3>

<p>This module routes packets which have a destination domain equal to one
of this server's host names. If the destination JID has a non-empty user
part, it is routed to the session manager, otherwise it is processed
depending on its content.</p>

<h3 id="sessionmanager">Session Manager</h3>

<p>This module routes packets to local users. It looks up to which user
resource a packet must be sent via a presence table. Then the packet is
either routed to the appropriate c2s process, or stored in offline
storage, or bounced back.</p>

<h3 id="s2smanager">s2s Manager</h3>

<p>This module routes packets to other XMPP servers. First, it checks if an
opened s2s connection from the domain of the packet's source to the
domain of the packet's destination exists. If that is the case, the s2s
manager routes the packet to the process serving this connection,
otherwise a new connection is opened.</p>

<h2 id="clusteringsetup">Clustering Setup</h2>

<h3 id="addinganodeinacluster">Adding a node in a cluster</h3>

<p>Suppose you already configured <code>ejabberd</code> on one machine named
(<code>first</code>), and you need to setup another one to make an <code>ejabberd</code>
cluster. Then do following steps:</p>

<ol>
<li><p>Copy <code>~ejabberd/.erlang.cookie</code> file from <code>first</code> to <code>second</code>.</p>

<p>(alt) You can also add '<code>-setcookie content_of_.erlang.cookie</code>'
option to all '<code>erl</code>' commands below.</p></li>
<li><p>Adding a node into the cluster is done by starting a new ejabberd
node within the same network, and running a command from a cluster
node. On <code>second</code> node for example, as ejabberd is already
started, run the following command as the <code>ejabberd</code> daemon user,
using the ejabberdctl script:</p>

<pre><code>#!console
$ ejabberdctl join_cluster 'ejabberd@first'
</code></pre>

<p>This enable ejabberd internals replications to be launched across
all nodes so new node can start receiving messages from other
nodes and be registered in the routing tables.</p></li>
</ol>

<h3 id="removinganodefromthecluster">Removing a node from the cluster</h3>

<p>To remove a node from the cluster, it just has to be shut down. There
is no specific delay for the cluster to figure out that the node is
gone, the node is immediately removed from other routers entries. All
clients directly connected to the stopped node are disconnected, and
should reconnect to other nodes.</p>

<p>If the cluster is used behind a load balancer and the node has been
removed from the load balancer, no new clients should be connecting to
that node but established connections should be kept, thus allowing to
remove a node smoothly, by stopping it after most clients disconnected
by themselves. If the node is started again, it's immediately
attached back to the cluster until it has been explicitly removed
permanently from the cluster.</p>

<p>To remove permanently a node from the cluster, a command must be run from the node to be removed:</p>

<pre><code>    #!console
    $ ejabberdctl leave_cluster
</code></pre>

<h1 id="serviceload-balancing">Service Load-Balancing</h1>

<h3 id="domainload-balancingalgorithm">Domain Load-Balancing Algorithm</h3>

<p><code>ejabberd</code> includes an algorithm to load balance the components that are
plugged on an <code>ejabberd</code> cluster. It means that you can plug one or
several instances of the same component on each <code>ejabberd</code> cluster and
that the traffic will be automatically distributed.</p>

<p>The default distribution algorithm try to deliver to a local instance of
a component. If several local instances are available, one instance is
chosen randomly. If no instance is available locally, one instance is
chosen randomly among the remote component instances.</p>

<p>If you need a different behaviour, you can change the load balancing
behaviour with the option <code>domain_balancing</code>. The syntax of the option
is the following:</p>

<dl>
<dt><code>domain_balancing: BalancingCriteria</code></dt>
<dd></dd>
</dl>

<p>Several balancing criteria are available:</p>

<ul>
<li><p><code>destination</code>: the full JID of the packet <code>to</code> attribute is used.</p></li>
<li><p><code>source</code>: the full JID of the packet <code>from</code> attribute is used.</p></li>
<li><p><code>bare_destination</code>: the bare JID (without resource) of the packet
<code>to</code> attribute is used.</p></li>
<li><p><code>bare_source</code>: the bare JID (without resource) of the packet <code>from</code>
attribute is used.</p></li>
</ul>

<p>If the value corresponding to the criteria is the same, the same
component instance in the cluster will be used.</p>

<h3 id="load-balancingbuckets">Load-Balancing Buckets</h3>

<p>When there is a risk of failure for a given component, domain balancing
can cause service trouble. If one component is failing the service will
not work correctly unless the sessions are rebalanced.</p>

<p>In this case, it is best to limit the problem to the sessions handled by
the failing component. This is what the
<code>domain_balancing_component_number</code> option does, making the load
balancing algorithm not dynamic, but sticky on a fix number of component
instances.</p>

<p>The syntax is:</p>

<dl>
<dt><code>domain_balancing_component_number: Number</code></dt>
<dd></dd>
</dl>

<h1 id="troubleshootingejabberd">Troubleshooting ejabberd</h1>

<hr />

<h2 id="logfiles">Log Files</h2>

<p>An <code>ejabberd</code> node writes three log files:</p>

<dl>
<dt><code>ejabberd.log</code></dt>
<dd>is the ejabberd service log, with the messages reported by
 <code>ejabberd</code> code</dd>

<dt><code>error.log</code></dt>
<dd>is the file accumulating error messages from <code>ejabberd.log</code></dd>

<dt><code>crash.log</code></dt>
<dd>is the Erlang/OTP log, with the crash messages reported by
 Erlang/OTP using SASL (System Architecture Support Libraries)</dd>
</dl>

<p>The option <code>loglevel</code> modifies the verbosity of the file ejabberd.log.
The syntax:</p>

<dl>
<dt><code>loglevel: Level</code></dt>
<dd>The standard form to set a global log level.</dd>
</dl>

<p>The possible <code>Level</code> are:</p>

<dl>
<dt><code>0</code></dt>
<dd>No ejabberd log at all (not recommended)</dd>

<dt><code>1</code></dt>
<dd>Critical</dd>

<dt><code>2</code></dt>
<dd>Error</dd>

<dt><code>3</code></dt>
<dd>Warning</dd>

<dt><code>4</code></dt>
<dd>Info</dd>

<dt><code>5</code></dt>
<dd>Debug</dd>
</dl>

<p>For example, the default configuration is:</p>

<pre><code>loglevel: 4
</code></pre>

<p>Option <code>log_rate_limit</code> is useful if you want to protect the logging
mechanism from being overloaded by excessive amount of log messages. The
syntax is:</p>

<dl>
<dt><code>log_rate_limit: N</code></dt>
<dd>Where N is a maximum number of log messages per second. The default
 value is 100.</dd>
</dl>

<p>When the limit is reached the similar warning message is logged:</p>

<pre><code>lager_error_logger_h dropped 800 messages in the last second that exceeded the limit of 100 messages/sec
</code></pre>

<p>By default <code>ejabberd</code> rotates the log files when they get grown above a
certain size. The exact value is controlled by <code>log_rotate_size</code> option.
The syntax is:</p>

<dl>
<dt><code>log_rotate_size: N</code></dt>
<dd>Where N is the maximum size of a log file in bytes. The default
 value is 10485760 (10Mb).</dd>
</dl>

<p><code>ejabberd</code> can also rotates the log files at given date interval. The
exact value is controlled by <code>log_rotate_date</code> option. The syntax is:</p>

<dl>
<dt><code>log_rotate_date: D</code></dt>
<dd>Where D is a string with syntax is taken from the syntax newsyslog
 uses in newsyslog.conf. The default value is `` (no rotation
 triggered by date).</dd>
</dl>

<p>However, you can rotate the log files manually. For doing this, set
<code>log_rotate_size</code> option to 0 and <code>log_rotate_date</code> to empty list, then,
when you need to rotate the files, rename and then reopen them. The
ejabberdctl command <code>reopen-log</code> (please refer to section
[ectl-commands]) reopens the log files, and also renames the old ones if
you didn't rename them.</p>

<p>The option <code>log_rotate_count</code> defines the number of rotated files to
keep by <code>reopen-log</code> command. Every such file has a numeric suffix. The
exact format is:</p>

<dl>
<dt><code>log_rotate_count: N</code></dt>
<dd>The default value is 1, which means only <code>ejabberd.log.0</code>,
 <code>error.log.0</code> and <code>crash.log.0</code> will be kept.</dd>
</dl>

<h2 id="debugconsole">Debug Console</h2>

<p>The Debug Console is an Erlang shell attached to an already running
<code>ejabberd</code> server. With this Erlang shell, an experienced administrator
can perform complex tasks.</p>

<p>This shell gives complete control over the <code>ejabberd</code> server, so it is
important to use it with extremely care. There are some simple and safe
examples in the article
<a href="http://www.ejabberd.im/interconnect-erl-nodes"><code>Interconnecting Erlang Nodes</code></a></p>

<p>To exit the shell, close the window or press the keys: control+c
control+c.</p>

<h2 id="watchdogalerts">Watchdog Alerts</h2>

<p><code>ejabberd</code> includes a watchdog mechanism that may be useful to
developers when troubleshooting a problem related to memory usage. If a
process in the <code>ejabberd</code> server consumes more memory than the
configured threshold, a message is sent to the XMPP accounts defined
with the option <code>watchdog_admins</code> in the <code>ejabberd</code> configuration file.</p>

<p>The syntax is:</p>

<dl>
<dt><code>watchdog_admins: [JID, ...]</code></dt>
<dd></dd>
</dl>

<p>The memory consumed is measured in <code>words</code>: a word on 32-bit
architecture is 4 bytes, and a word on 64-bit architecture is 8 bytes.
The threshold by default is 1000000 words. This value can be configured
with the option <code>watchdog_large_heap</code>, or in a conversation with the
watchdog alert bot.</p>

<p>The syntax is:</p>

<dl>
<dt><code>watchdog_large_heap: Number</code></dt>
<dd></dd>
</dl>

<p>Example configuration:</p>

<pre><code>#!yaml
watchdog_admins:
  - &quot;admin2@localhost&quot;
  - &quot;admin2@example.org&quot;
watchdog_large_heap: 30000000
</code></pre>

<p>To remove watchdog admins, remove them in the option. To remove all
watchdog admins, set the option with an empty list:</p>

<pre><code>#!yaml
watchdog_admins: []
</code></pre>

</body>
</html>
